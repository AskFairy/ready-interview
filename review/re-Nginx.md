Nginx ï¼Œæ˜¯ä¸€ä¸ª 

- åŸºäºäº‹ä»¶çš„Web æœåŠ¡å™¨
- å¤„ç†è¯·æ±‚æ˜¯å¼‚æ­¥éé˜»å¡çš„ï¼Œä½æ¶ˆè€—ï¼Œæ”¯æ’‘é«˜å¹¶å‘
- åå‘ä»£ç†æœåŠ¡å™¨ï¼Œå®ç°è´Ÿè½½å‡è¡¡

cgi ï¼šweb æœåŠ¡å™¨ä¼šfork ä¸€ä¸ªæ–°è¿›ç¨‹

fastcgiï¼šweb æœåŠ¡å™¨ä¸ä¼šä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œç›´æ¥tcpäº¤ç»™å¯åŠ¨å°±å¼€å¯çš„è¿›ç¨‹ã€‚

#### Nginx å¸¸ç”¨å‘½ä»¤ï¼Ÿ

- å¯åŠ¨ `nginx` ã€‚
- åœæ­¢ `nginx -s stop`  ã€‚
- é‡è½½é…ç½® `./sbin/nginx -s reload(å¹³æ»‘é‡å¯)` æˆ– `service nginx reload` ã€‚
- é‡è½½æŒ‡å®šé…ç½®æ–‡ä»¶ `.nginx -c /usr/local/nginx/conf/nginx.conf` ã€‚
- æŸ¥çœ‹ nginx ç‰ˆæœ¬ `nginx -v` ã€‚
- æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡® `nginx -t` ã€‚
- æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ `nginx -h` ã€‚

#### Nginx å¸¸ç”¨é…ç½®ï¼Ÿ

```java
worker_processes  8; # å·¥ä½œè¿›ç¨‹ä¸ªæ•°
worker_connections  65535; # æ¯ä¸ªå·¥ä½œè¿›ç¨‹èƒ½å¹¶å‘å¤„ç†ï¼ˆå‘èµ·ï¼‰çš„æœ€å¤§è¿æ¥æ•°ï¼ˆåŒ…å«æ‰€æœ‰è¿æ¥æ•°ï¼‰
error_log         /data/logs/nginx/error.log; # é”™è¯¯æ—¥å¿—æ‰“å°åœ°å€
access_log      /data/logs/nginx/access.log; # è¿›å…¥æ—¥å¿—æ‰“å°åœ°å€
log_format  main  '$remote_addr"$request" ''$status $upstream_addr "$request_time"'; # è¿›å…¥æ—¥å¿—æ ¼å¼

listen       80; # ç›‘å¬ç«¯å£
server_name  rrc.test.jiedaibao.com; # å…è®¸åŸŸå
root  /data/release/rrc/web; # é¡¹ç›®æ ¹ç›®å½•
index  index.php index.html index.htm; # è®¿é—®æ ¹æ–‡ä»¶
```

ğŸ¦… **Nginx æ—¥å¿—æ ¼å¼ä¸­çš„ `$time_local` è¡¨ç¤ºçš„æ˜¯ä»€ä¹ˆæ—¶é—´ï¼Ÿè¯·æ±‚å¼€å§‹çš„æ—¶é—´ï¼Ÿè¯·æ±‚ç»“æŸçš„æ—¶é—´ï¼Ÿå…¶æ¬¡ï¼Œå½“æˆ‘ä»¬ä»å‰åˆ°åè§‚å¯Ÿæ—¥å¿—ä¸­çš„ `$time_local` æ—¶é—´æ—¶ï¼Œæœ‰æ—¶å€™ä¼šå‘ç°æ—¶é—´é¡ºåºå‰åé”™ä¹±çš„ç°è±¡ï¼Œè¯·è¯´æ˜åŸå› ï¼Ÿ**

`$time_local` ï¼šåœ¨æœåŠ¡å™¨é‡Œè¯·æ±‚å¼€å§‹å†™å…¥æœ¬åœ°çš„æ—¶é—´ã€‚

å› ä¸ºè¯·æ±‚å‘ç”Ÿæ—¶é—´æœ‰å‰æœ‰åï¼Œæ‰€ä»¥ä¼šæ—¶é—´é¡ºåºå‰åé”™ä¹±ã€‚

#### ä¼˜ç‚¹

éé˜»å¡ã€é«˜å¹¶å‘ã€é«˜æ€§èƒ½ã€é«˜åå

BSDè®¸å¯è¯ çµæ´»æ€§

#### **åå‘ä»£ç†æœåŠ¡å™¨**çš„ä¼˜ç‚¹

å½“ä¸­é—´å±‚ï¼Œéšè—æºæœåŠ¡å™¨çš„å­˜åœ¨å’Œç‰¹å¾

#### æ­£å‘ä»£ç†ï¼šä»£ç†ç«¯ä»£ç†çš„æ˜¯å®¢æˆ·ç«¯ï¼ŒVPN

#### åå‘ä»£ç†ï¼šä»£ç†ç«¯ä»£ç†çš„æ˜¯æœåŠ¡ç«¯

#### åœºæ™¯

![image-20200928123210804](https://gitee.com//chenchong0817/picture/raw/master/Aaron/20200928123220.png)

- apiæœåŠ¡ï¼šæ•°æ®æœåŠ¡åº”ç”¨åœºæ™¯ç®€å•ï¼Œå¹¶å‘æ€§èƒ½ï¼Œtpsé«˜äºåº”ç”¨æœåŠ¡ã€‚jsã€luaã€openResty
  - webé˜²ç«å¢™

#### è¯·è§£é‡Š Nginx å¦‚ä½•å¤„ç† HTTP è¯·æ±‚ï¼Ÿ

- é¦–å…ˆï¼ŒNginx åœ¨å¯åŠ¨æ—¶ï¼Œä¼šè§£æé…ç½®æ–‡ä»¶ï¼Œå¾—åˆ°éœ€è¦ç›‘å¬çš„ç«¯å£ä¸ IP åœ°å€ï¼Œç„¶ååœ¨ Nginx çš„ Master è¿›ç¨‹é‡Œé¢å…ˆåˆå§‹åŒ–å¥½è¿™ä¸ªç›‘æ§çš„Socket(åˆ›å»º S ocketï¼Œè®¾ç½® addrã€reuse ç­‰é€‰é¡¹ï¼Œç»‘å®šåˆ°æŒ‡å®šçš„ ip åœ°å€ç«¯å£ï¼Œå† listen ç›‘å¬)ã€‚

- ç„¶åï¼Œå† fork(ä¸€ä¸ªç°æœ‰è¿›ç¨‹å¯ä»¥è°ƒç”¨ fork å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ã€‚ç”± fork åˆ›å»ºçš„æ–°è¿›ç¨‹è¢«ç§°ä¸ºå­è¿›ç¨‹ )å‡ºå¤šä¸ªå­è¿›ç¨‹å‡ºæ¥ã€‚

- ä¹‹åï¼Œå­è¿›ç¨‹ä¼šç«äº‰ accept æ–°çš„è¿æ¥ã€‚æ­¤æ—¶ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥å‘ nginx å‘èµ·è¿æ¥äº†ã€‚å½“å®¢æˆ·ç«¯ä¸nginxè¿›è¡Œä¸‰æ¬¡æ¡æ‰‹ï¼Œä¸ nginx å»ºç«‹å¥½ä¸€ä¸ªè¿æ¥åã€‚æ­¤æ—¶ï¼ŒæŸä¸€ä¸ªå­è¿›ç¨‹ä¼š accept æˆåŠŸï¼Œå¾—åˆ°è¿™ä¸ªå»ºç«‹å¥½çš„è¿æ¥çš„ Socket ï¼Œç„¶ååˆ›å»º nginx å¯¹è¿æ¥çš„å°è£…ï¼Œå³ ngx_connection_t ç»“æ„ä½“ã€‚

- æ¥ç€ï¼Œè®¾ç½®è¯»å†™äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œå¹¶æ·»åŠ è¯»å†™äº‹ä»¶æ¥ä¸å®¢æˆ·ç«¯è¿›è¡Œæ•°æ®çš„äº¤æ¢ã€‚

  > è¿™é‡Œï¼Œè¿˜æ˜¯æœ‰ä¸€äº›é€»è¾‘ï¼Œç»§ç»­åœ¨ [ã€ŒNginx æ˜¯å¦‚ä½•å®ç°é«˜å¹¶å‘çš„ï¼Ÿã€](http://svip.iocoder.cn/Nginx/Interview/#) é—®é¢˜ä¸­æ¥çœ‹ã€‚

- æœ€åï¼ŒNginx æˆ–å®¢æˆ·ç«¯æ¥ä¸»åŠ¨å…³æ‰è¿æ¥ï¼Œåˆ°æ­¤ï¼Œä¸€ä¸ªè¿æ¥å°±å¯¿ç»ˆæ­£å¯äº†ã€‚

ğŸ¦… **Nginx æ˜¯å¦‚ä½•å®ç°é«˜å¹¶å‘çš„ï¼Ÿ**

å¦‚æœä¸€ä¸ª server é‡‡ç”¨ä¸€ä¸ªè¿›ç¨‹(æˆ–è€…çº¿ç¨‹)è´Ÿè´£ä¸€ä¸ªrequestçš„æ–¹å¼ï¼Œé‚£ä¹ˆè¿›ç¨‹æ•°å°±æ˜¯å¹¶å‘æ•°ã€‚é‚£ä¹ˆæ˜¾è€Œæ˜“è§çš„ï¼Œå°±æ˜¯ä¼šæœ‰å¾ˆå¤šè¿›ç¨‹åœ¨ç­‰å¾…ä¸­ã€‚ç­‰ä»€ä¹ˆï¼Ÿæœ€å¤šçš„åº”è¯¥æ˜¯ç­‰å¾…ç½‘ç»œä¼ è¾“ã€‚å…¶ç¼ºç‚¹èƒ–å‹åº”è¯¥ä¹Ÿæ„Ÿè§‰åˆ°äº†ï¼Œæ­¤å¤„ä¸è¿°ã€‚

> æ€è€ƒä¸‹ï¼ŒJava çš„ NIO å’Œ BIO çš„å¯¹æ¯”å“Ÿã€‚

è€Œ Nginx çš„å¼‚æ­¥éé˜»å¡å·¥ä½œæ–¹å¼æ­£æ˜¯åˆ©ç”¨äº†è¿™ç‚¹ç­‰å¾…çš„æ—¶é—´ã€‚åœ¨éœ€è¦ç­‰å¾…çš„æ—¶å€™ï¼Œè¿™äº›è¿›ç¨‹å°±ç©ºé—²å‡ºæ¥å¾…å‘½äº†ã€‚å› æ­¤è¡¨ç°ä¸ºå°‘æ•°å‡ ä¸ªè¿›ç¨‹å°±è§£å†³äº†å¤§é‡çš„å¹¶å‘é—®é¢˜ã€‚

Nginxæ˜¯å¦‚ä½•åˆ©ç”¨çš„å‘¢ï¼Œç®€å•æ¥è¯´ï¼šåŒæ ·çš„ 4 ä¸ªè¿›ç¨‹ï¼Œå¦‚æœé‡‡ç”¨ä¸€ä¸ªè¿›ç¨‹è´Ÿè´£ä¸€ä¸ª request çš„æ–¹å¼ï¼Œé‚£ä¹ˆï¼ŒåŒæ—¶è¿›æ¥ 4 ä¸ª request ä¹‹åï¼Œæ¯ä¸ªè¿›ç¨‹å°±è´Ÿè´£å…¶ä¸­ä¸€ä¸ªï¼Œç›´è‡³ä¼šè¯å…³é—­ã€‚æœŸé—´ï¼Œå¦‚æœæœ‰ç¬¬ 5 ä¸ªrequestè¿›æ¥äº†ã€‚å°±æ— æ³•åŠæ—¶ååº”äº†ï¼Œå› ä¸º 4 ä¸ªè¿›ç¨‹éƒ½æ²¡å¹²å®Œæ´»å‘¢ï¼Œå› æ­¤ï¼Œä¸€èˆ¬æœ‰ä¸ªè°ƒåº¦è¿›ç¨‹ï¼Œæ¯å½“æ–°è¿›æ¥äº†ä¸€ä¸ª request ï¼Œå°±æ–°å¼€ä¸ªè¿›ç¨‹æ¥å¤„ç†ã€‚

> å›æƒ³ä¸‹ï¼ŒBIO æ˜¯ä¸æ˜¯å­˜åœ¨é…±ç´«çš„é—®é¢˜ï¼Ÿå˜»å˜»ã€‚

Nginx ä¸è¿™æ ·ï¼Œæ¯è¿›æ¥ä¸€ä¸ª request ï¼Œä¼šæœ‰ä¸€ä¸ª worker è¿›ç¨‹å»å¤„ç†ã€‚ä½†ä¸æ˜¯å…¨ç¨‹çš„å¤„ç†ï¼Œå¤„ç†åˆ°ä»€ä¹ˆç¨‹åº¦å‘¢ï¼Ÿå¤„ç†åˆ°å¯èƒ½å‘ç”Ÿé˜»å¡çš„åœ°æ–¹ï¼Œæ¯”å¦‚å‘ä¸Šæ¸¸ï¼ˆåç«¯ï¼‰æœåŠ¡å™¨è½¬å‘ request ï¼Œå¹¶ç­‰å¾…è¯·æ±‚è¿”å›ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªå¤„ç†çš„ worker ä¸ä¼šè¿™ä¹ˆå‚»ç­‰ç€ï¼Œä»–ä¼šåœ¨å‘é€å®Œè¯·æ±‚åï¼Œæ³¨å†Œä¸€ä¸ªäº‹ä»¶ï¼šâ€œå¦‚æœ upstream è¿”å›äº†ï¼Œå‘Šè¯‰æˆ‘ä¸€å£°ï¼Œæˆ‘å†æ¥ç€å¹²â€ã€‚äºæ˜¯ä»–å°±ä¼‘æ¯å»äº†ã€‚æ­¤æ—¶ï¼Œå¦‚æœå†æœ‰ request è¿›æ¥ï¼Œä»–å°±å¯ä»¥å¾ˆå¿«å†æŒ‰è¿™ç§æ–¹å¼å¤„ç†ã€‚è€Œä¸€æ—¦ä¸Šæ¸¸æœåŠ¡å™¨è¿”å›äº†ï¼Œå°±ä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶ï¼Œworker æ‰ä¼šæ¥æ¥æ‰‹ï¼Œè¿™ä¸ª request æ‰ä¼šæ¥ç€å¾€ä¸‹èµ°ã€‚

> è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¯´ï¼ŒNginx åŸºäºäº‹ä»¶æ¨¡å‹ã€‚

ç”±äº web server çš„å·¥ä½œæ€§è´¨å†³å®šäº†æ¯ä¸ª request çš„å¤§éƒ¨ä»½ç”Ÿå‘½éƒ½æ˜¯åœ¨ç½‘ç»œä¼ è¾“ä¸­ï¼Œå®é™…ä¸ŠèŠ±è´¹åœ¨ server æœºå™¨ä¸Šçš„æ—¶é—´ç‰‡ä¸å¤šã€‚è¿™æ˜¯å‡ ä¸ªè¿›ç¨‹å°±è§£å†³é«˜å¹¶å‘çš„ç§˜å¯†æ‰€åœ¨ã€‚å³ï¼š

> webserver åˆšå¥½å±äºç½‘ç»œ IO å¯†é›†å‹åº”ç”¨ï¼Œä¸ç®—æ˜¯è®¡ç®—å¯†é›†å‹ã€‚

è€Œæ­£å¦‚å”åº¦æ‰€è¯´çš„

> å¼‚æ­¥ï¼Œéé˜»å¡ï¼Œä½¿ç”¨ epoll ï¼Œå’Œå¤§é‡ç»†èŠ‚å¤„çš„ä¼˜åŒ–ã€‚

ä¹Ÿæ­£æ˜¯ Nginx ä¹‹æ‰€ä»¥ç„¶çš„æŠ€æœ¯åŸºçŸ³ã€‚

ğŸ¦… **ä¸ºä»€ä¹ˆ Nginx ä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ**

Apache: åˆ›å»ºå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹ï¼Œè€Œæ¯ä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹éƒ½ä¼šä¸ºå…¶åˆ†é… cpu å’Œå†…å­˜ï¼ˆçº¿ç¨‹è¦æ¯”è¿›ç¨‹å°çš„å¤šï¼Œæ‰€ä»¥ worker æ”¯æŒæ¯” perfork é«˜çš„å¹¶å‘ï¼‰ï¼Œå¹¶å‘è¿‡å¤§ä¼šæ¦¨å¹²æœåŠ¡å™¨èµ„æºã€‚

Nginx: é‡‡ç”¨å•çº¿ç¨‹æ¥å¼‚æ­¥éé˜»å¡å¤„ç†è¯·æ±‚ï¼ˆç®¡ç†å‘˜å¯ä»¥é…ç½® Nginx ä¸»è¿›ç¨‹çš„å·¥ä½œè¿›ç¨‹çš„æ•°é‡ï¼‰(epoll)ï¼Œä¸ä¼šä¸ºæ¯ä¸ªè¯·æ±‚åˆ†é… cpu å’Œå†…å­˜èµ„æºï¼ŒèŠ‚çœäº†å¤§é‡èµ„æºï¼ŒåŒæ—¶ä¹Ÿå‡å°‘äº†å¤§é‡çš„ CPU çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ‰€ä»¥æ‰ä½¿å¾— Nginx æ”¯æŒæ›´é«˜çš„å¹¶å‘ã€‚

> Nettyã€Redis åŸºæœ¬é‡‡ç”¨ç›¸åŒæ€è·¯ã€‚