Nginx ï¼Œæ˜¯ä¸€ä¸ª 

- **åŸºäºäº‹ä»¶çš„Web æœåŠ¡å™¨**
- å¤„ç†è¯·æ±‚æ˜¯å¼‚æ­¥éé˜»å¡çš„ï¼Œä½æ¶ˆè€—ï¼Œæ”¯æ’‘é«˜å¹¶å‘
- åå‘ä»£ç†æœåŠ¡å™¨ï¼Œå®ç°è´Ÿè½½å‡è¡¡

cgi ï¼šweb æœåŠ¡å™¨ä¼šfork ä¸€ä¸ªæ–°è¿›ç¨‹

`fastcgi`ï¼šweb æœåŠ¡å™¨ä¸ä¼šä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œç›´æ¥tcpäº¤ç»™å¯åŠ¨å°±å¼€å¯çš„è¿›ç¨‹ã€‚

#### Nginx å¸¸ç”¨å‘½ä»¤ï¼Ÿ

- å¯åŠ¨ `nginx` ã€‚
- åœæ­¢ `nginx -s stop`  ã€‚
- é‡è½½é…ç½® `./sbin/nginx -s reload(å¹³æ»‘é‡å¯)` æˆ– `service nginx reload` ã€‚
- é‡è½½æŒ‡å®šé…ç½®æ–‡ä»¶ `.nginx -c /usr/local/nginx/conf/nginx.conf` ã€‚
- æŸ¥çœ‹ nginx ç‰ˆæœ¬ `nginx -v` ã€‚
- æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡® `nginx -t` ã€‚
- æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ `nginx -h` ã€‚

#### Nginx å¸¸ç”¨é…ç½®ï¼Ÿ

```java
worker_processes  8; # å·¥ä½œè¿›ç¨‹ä¸ªæ•°
worker_connections  65535; # æ¯ä¸ªå·¥ä½œè¿›ç¨‹èƒ½å¹¶å‘å¤„ç†ï¼ˆå‘èµ·ï¼‰çš„æœ€å¤§è¿æ¥æ•°ï¼ˆåŒ…å«æ‰€æœ‰è¿æ¥æ•°ï¼‰
error_log         /data/logs/nginx/error.log; # é”™è¯¯æ—¥å¿—æ‰“å°åœ°å€
access_log      /data/logs/nginx/access.log; # è¿›å…¥æ—¥å¿—æ‰“å°åœ°å€
log_format  main  '$remote_addr"$request" ''$status $upstream_addr "$request_time"'; # è¿›å…¥æ—¥å¿—æ ¼å¼

listen       80; # ç›‘å¬ç«¯å£
server_name  rrc.test.jiedaibao.com; # å…è®¸åŸŸå
root  /data/release/rrc/web; # é¡¹ç›®æ ¹ç›®å½•
index  index.php index.html index.htm; # è®¿é—®æ ¹æ–‡ä»¶
```

ğŸ¦… **Nginx æ—¥å¿—æ ¼å¼ä¸­çš„ `$time_local` è¡¨ç¤ºçš„æ˜¯ä»€ä¹ˆæ—¶é—´ï¼Ÿå…¶æ¬¡ï¼Œå½“æˆ‘ä»¬ä»å‰åˆ°åè§‚å¯Ÿæ—¥å¿—ä¸­çš„ `$time_local` æ—¶é—´æ—¶ï¼Œæœ‰æ—¶å€™ä¼šå‘ç°æ—¶é—´é¡ºåºå‰åé”™ä¹±çš„ç°è±¡ï¼Œè¯·è¯´æ˜åŸå› ï¼Ÿ**

`$time_local` ï¼šåœ¨æœåŠ¡å™¨é‡Œ**è¯·æ±‚å¼€å§‹å†™å…¥æœ¬åœ°çš„æ—¶é—´**ã€‚

å› ä¸ºè¯·æ±‚å‘ç”Ÿæ—¶é—´æœ‰å‰æœ‰åï¼Œæ‰€ä»¥ä¼šæ—¶é—´é¡ºåºå‰åé”™ä¹±ã€‚

#### ä¼˜ç‚¹

éé˜»å¡ã€é«˜å¹¶å‘ã€é«˜æ€§èƒ½ã€é«˜åå

BSDè®¸å¯è¯ çµæ´»æ€§

#### **åå‘ä»£ç†æœåŠ¡å™¨**çš„ä¼˜ç‚¹

å½“ä¸­é—´å±‚ï¼Œéšè—æºæœåŠ¡å™¨çš„å­˜åœ¨å’Œç‰¹å¾

#### æ­£å‘ä»£ç†ï¼šä»£ç†ç«¯ä»£ç†çš„æ˜¯å®¢æˆ·ç«¯ï¼ŒVPN

#### åå‘ä»£ç†ï¼šä»£ç†ç«¯ä»£ç†çš„æ˜¯æœåŠ¡ç«¯

#### åœºæ™¯

![image-20200928123210804](https://gitee.com//chenchong0817/picture/raw/master/Aaron/20200928123220.png)

- apiæœåŠ¡ï¼šæ•°æ®æœåŠ¡åº”ç”¨åœºæ™¯ç®€å•ï¼Œå¹¶å‘æ€§èƒ½ï¼Œtpsï¼ˆç³»ç»Ÿååé‡ï¼‰é«˜äºåº”ç”¨æœåŠ¡ã€‚jsã€luaã€openResty
  - webé˜²ç«å¢™
  - openrestyè§£å†³çš„ç—›ç‚¹æ˜¯ï¼Œnginxæ¨¡å—å¼€å‘ä½¿ç”¨luaè§„èŒƒæ–¹ä¾¿ï¼Œä¸ç”¨Cå»å¼€å‘ï¼Œä¸éœ€è¦ç‰¹åˆ«ç†Ÿæ‚‰nginxæºç ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¼€å‘å‡ºé€‚åˆè‡ªå·±ä¸šåŠ¡çš„é«˜æ€§èƒ½web Serveræ¨¡å—ï¼Œä»–ä¹Ÿè‡ªå¸¦MySQLï¼Œredisï¼Œmemcachedç­‰æ¨¡å—ï¼Œå†è¯´åˆ°ä½ è¯´çš„æ•°æ®ä¸Šï¼Œé‚£ä½ æŠŠMySQLæŸ¥è¯¢çš„æ•°æ®æ”¾memcachedï¼Œæµè§ˆå™¨è·å–æ•°æ®ä¸å°±å¿«äº†ä¹ˆ

#### è¯·è§£é‡Š Nginx å¦‚ä½•å¤„ç† HTTP è¯·æ±‚ï¼Ÿ

- é¦–å…ˆï¼ŒNginx åœ¨å¯åŠ¨æ—¶ï¼Œä¼š**è§£æé…ç½®æ–‡ä»¶**ï¼Œå¾—åˆ°éœ€è¦ç›‘å¬çš„ç«¯å£ä¸ IP åœ°å€ï¼Œç„¶ååœ¨ Nginx çš„ **Master è¿›ç¨‹**é‡Œé¢å…ˆåˆå§‹åŒ–å¥½è¿™ä¸ª**ç›‘æ§çš„Socket**ã€‚
- ç„¶åï¼Œå† **forkå‡ºå¤šä¸ªå­è¿›ç¨‹**å‡ºæ¥ã€‚ä¹‹åï¼Œå­è¿›ç¨‹ä¼šç«äº‰æ–°çš„è¿æ¥ã€‚
- æ­¤æ—¶ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥å‘ nginx å‘èµ·è¿æ¥äº†ã€‚å½“å®¢æˆ·ç«¯ä¸nginxè¿›è¡Œä¸‰æ¬¡æ¡æ‰‹ï¼Œä¸ nginx å»ºç«‹å¥½ä¸€ä¸ªè¿æ¥åã€‚
- æ­¤æ—¶ï¼ŒæŸä¸€ä¸ªå­è¿›ç¨‹ä¼š accept æˆåŠŸï¼Œå¾—åˆ°è¿™ä¸ªå»ºç«‹å¥½çš„è¿æ¥çš„ Socket ï¼Œç„¶ååˆ›å»º nginx å¯¹è¿æ¥çš„å°è£…ã€‚
- æ¥ç€ï¼Œè®¾ç½®**è¯»å†™äº‹ä»¶å¤„ç†å‡½æ•°**ï¼Œå¹¶æ·»åŠ è¯»å†™äº‹ä»¶æ¥ä¸å®¢æˆ·ç«¯è¿›è¡Œæ•°æ®çš„äº¤æ¢ã€‚

- æœ€åï¼ŒNginx æˆ–å®¢æˆ·ç«¯æ¥ä¸»åŠ¨å…³æ‰è¿æ¥ï¼Œåˆ°æ­¤ï¼Œä¸€ä¸ªè¿æ¥å°±å¯¿ç»ˆæ­£å¯äº†ã€‚

### Nginx æ˜¯å¦‚ä½•å®ç°é«˜å¹¶å‘çš„ï¼Ÿ

Nginx ä¸è¿™æ ·ï¼Œæ¯è¿›æ¥ä¸€ä¸ª request ï¼Œä¼šæœ‰ä¸€ä¸ª worker è¿›ç¨‹å»å¤„ç†ã€‚ä½†ä¸æ˜¯å…¨ç¨‹çš„å¤„ç†ï¼Œ**å¤„ç†åˆ°å¯èƒ½å‘ç”Ÿé˜»å¡çš„åœ°æ–¹**ï¼Œæ¯”å¦‚å‘ä¸Šæ¸¸ï¼ˆåç«¯ï¼‰æœåŠ¡å™¨è½¬å‘ request ï¼Œå¹¶ç­‰å¾…è¯·æ±‚è¿”å›ã€‚

é‚£ä¹ˆï¼Œè¿™ä¸ªå¤„ç†çš„ worker ä¸ä¼šè¿™ä¹ˆå‚»ç­‰ç€ï¼Œä»–ä¼šåœ¨å‘é€å®Œè¯·æ±‚åï¼Œ**æ³¨å†Œä¸€ä¸ªäº‹ä»¶**ï¼šâ€œå¦‚æœ upstream è¿”å›äº†ï¼Œå‘Šè¯‰æˆ‘ä¸€å£°ï¼Œæˆ‘å†æ¥ç€å¹²â€ã€‚

äºæ˜¯ä»–å°±ä¼‘æ¯å»äº†ã€‚æ­¤æ—¶ï¼Œå¦‚æœå†æœ‰ request è¿›æ¥ï¼Œä»–å°±å¯ä»¥å¾ˆå¿«å†æŒ‰è¿™ç§æ–¹å¼å¤„ç†ã€‚è€Œä¸€æ—¦**ä¸Šæ¸¸æœåŠ¡å™¨è¿”å›äº†ï¼Œå°±ä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶**ï¼Œworker æ‰ä¼šæ¥æ¥æ‰‹ï¼Œè¿™ä¸ª request æ‰ä¼šæ¥ç€å¾€ä¸‹èµ°ã€‚

> è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¯´ï¼ŒNginx åŸºäºäº‹ä»¶æ¨¡å‹ã€‚

ç”±äº web server çš„å·¥ä½œæ€§è´¨å±äºç½‘ç»œ IO å¯†é›†å‹åº”ç”¨ï¼Œä¸ç®—æ˜¯è®¡ç®—å¯†é›†å‹ã€‚

> å¼‚æ­¥ï¼Œéé˜»å¡ï¼Œä½¿ç”¨ epoll ï¼Œå’Œå¤§é‡ç»†èŠ‚å¤„çš„ä¼˜åŒ–ã€‚ä¹Ÿæ­£æ˜¯ Nginx ä¹‹æ‰€ä»¥ç„¶çš„æŠ€æœ¯åŸºçŸ³ã€‚

### è¯·è§£é‡ŠNginxæœåŠ¡å™¨ä¸Šçš„Masterå’ŒWorkerè¿›ç¨‹åˆ†åˆ«æ˜¯ä»€ä¹ˆ?

- nginxåœ¨å¯åŠ¨åï¼Œä¼šæœ‰ä¸€ä¸ªmasterè¿›ç¨‹å’Œå¤šä¸ªworkerè¿›ç¨‹ã€‚
- masterè¿›ç¨‹ä¸»è¦ç”¨æ¥**ç®¡ç†workerè¿›ç¨‹**ï¼ŒåŒ…å«ï¼šæ¥æ”¶æ¥è‡ªå¤–ç•Œçš„ä¿¡å·ï¼Œå‘å„workerè¿›ç¨‹å‘é€ä¿¡å·ï¼Œç›‘æ§workerè¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ï¼Œå½“workerè¿›ç¨‹å¼‚å¸¸é€€å‡ºåï¼Œï¼Œä¼šè‡ªåŠ¨é‡æ–°å¯åŠ¨æ–°çš„workerè¿›ç¨‹ã€‚
- è€ŒåŸºæœ¬çš„ç½‘ç»œäº‹ä»¶ï¼Œåˆ™æ˜¯æ”¾åœ¨workerè¿›ç¨‹ä¸­æ¥å¤„ç†äº†
- workerè¿›ç¨‹çš„ä¸ªæ•°æ˜¯å¯ä»¥è®¾ç½®çš„ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šè®¾ç½®ä¸**æœºå™¨cpuæ ¸æ•°ä¸€è‡´**ï¼Œè¿™é‡Œé¢çš„åŸå› ä¸nginxçš„è¿›ç¨‹æ¨¡å‹ä»¥åŠäº‹ä»¶å¤„ç†æ¨¡å‹æ˜¯åˆ†ä¸å¼€çš„ã€‚nginxçš„è¿›ç¨‹æ¨¡å‹ï¼Œ

### ä¸ºä»€ä¹ˆ Nginx ä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ

Apache: åˆ›å»ºå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹ï¼Œè€Œæ¯ä¸ªè¿›ç¨‹æˆ–**çº¿ç¨‹éƒ½ä¼šä¸ºå…¶åˆ†é… cpu å’Œå†…å­˜**ï¼ˆçº¿ç¨‹è¦æ¯”è¿›ç¨‹å°çš„å¤šï¼Œæ‰€ä»¥ worker æ”¯æŒæ¯” perfork é«˜çš„å¹¶å‘ï¼‰ï¼Œå¹¶å‘è¿‡å¤§ä¼šæ¦¨å¹²æœåŠ¡å™¨èµ„æºã€‚

Nginx: é‡‡ç”¨å•çº¿ç¨‹æ¥å¼‚æ­¥éé˜»å¡å¤„ç†è¯·æ±‚(epoll)ï¼Œä¸ä¼šä¸ºæ¯ä¸ªè¯·æ±‚åˆ†é… cpu å’Œå†…å­˜èµ„æºï¼Œ**èŠ‚çœäº†å¤§é‡èµ„æº**ï¼ŒåŒæ—¶ä¹Ÿ**å‡å°‘äº†å¤§é‡çš„ CPU çš„ä¸Šä¸‹æ–‡åˆ‡æ¢**ã€‚æ‰€ä»¥æ‰ä½¿å¾— Nginx æ”¯æŒæ›´é«˜çš„å¹¶å‘ã€‚

> Nettyã€Redis åŸºæœ¬é‡‡ç”¨ç›¸åŒæ€è·¯ã€‚

#### å¤šè¿›ç¨‹

![image-20200928144356362](https://gitee.com//chenchong0817/picture/raw/master/Aaron/20200928144400.png)

ä¸ºäº†ä¿æŒé«˜å¯ç”¨ï¼Œé«˜å¯é æ€§ã€‚å¤šçº¿ç¨‹å…±äº«åœ°å€ç©ºé—´ï¼Œç¬¬ä¸‰æ–¹å¼•å‘åœ°å€ç©ºé—´æ®µé”™è¯¯ï¼Œåœ°å€è¶Šç•Œï¼Œè¿›ç¨‹æŒ‚æ‰ã€‚

**è¿›ç¨‹é—´é€šä¿¡é‡‡ç”¨å…±äº«å†…å­˜è§£å†³çš„ã€‚**

ä¸€ä¸ªworkerç»‘å®šä¸€ä¸ªcpuæ ¸ï¼Œæ›´å¥½ä½¿ç”¨cpuæ ¸ä¸­çš„ç¼“å­˜ï¼Œå‡å°‘ç¼“å­˜å¤±æ•ˆçš„å‘½ä¸­ç‡ã€‚

![image-20200928145020276](https://gitee.com//chenchong0817/picture/raw/master/Aaron/20200928145022.png)

reload   ==   kill -SIGHUB 9170 

kill -SIGTERM 16882

å‘½ä»¤è¡Œçš„å­å‘½ä»¤ï¼Œå°±æ˜¯å‘`Master`è¿›ç¨‹**å‘é€ä¿¡å·**

![image-20200928145530397](https://gitee.com//chenchong0817/picture/raw/master/Aaron/20200928145533.png)

hub é‡è½½æ—¥å¿—æ–‡ä»¶

usr1åšæ—¥å¿—æ–‡ä»¶çš„åˆ‡å‰²

![image-20200928150532520](https://gitee.com//chenchong0817/picture/raw/master/Aaron/20200928150534.png)

![image-20200928150614260](https://gitee.com//chenchong0817/picture/raw/master/Aaron/20200928150615.png)

- worker_shutdown_TimeOut

å‡çº§Nginxï¼Œä½¿ç”¨

![image-20200928151105436](https://gitee.com//chenchong0817/picture/raw/master/Aaron/20200928151107.png)

ä¼˜é›…çš„å…³é—­ï¼šé’ˆå¯¹HTTPè¯·æ±‚

![image-20200928151448502](https://gitee.com//chenchong0817/picture/raw/master/Aaron/20200928151449.png)

![image-20200928152111397](https://gitee.com//chenchong0817/picture/raw/master/Aaron/20200928152112.png)

![image-20200928152347122](https://gitee.com//chenchong0817/picture/raw/master/Aaron/20200928152349.png)

ä¸‰æ¬¡æ¡æ‰‹åï¼Œ**æ‰é€šçŸ¥å”¤é†’Nginxï¼ŒNginxä»æ“ä½œç³»ç»Ÿkernelä¸­è·å–äº‹ä»¶**

#### [epoll](https://zhuanlan.zhihu.com/p/63179839)

![image-20200928152830807](https://gitee.com//chenchong0817/picture/raw/master/Aaron/20200928152832.png)

- æ¯æ¬¡å–æ´»è·ƒé“¾æ¥ï¼Œåªä¼šéå†**é“¾è¡¨**ï¼Œé“¾è¡¨ä¸­**åªå­˜æ´»è·ƒ**çš„é“¾æ¥ï¼Œå†…æ ¸æ€å’Œç”¨æˆ·æ€åªè¯»å–æ´»è·ƒçš„é“¾è¡¨
- å»ºç«‹é“¾æ¥æˆåŠŸåï¼Œåœ¨çº¢é»‘æ ‘ä¸­å»ºç«‹äº‹ä»¶ã€‚æ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹ã€éƒ½æ˜¯logNçš„æ—¶é—´å¤æ‚åº¦

