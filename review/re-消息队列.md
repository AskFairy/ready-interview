# æ¶ˆæ¯é˜Ÿåˆ— 

#### æ¶ˆæ¯é˜Ÿåˆ—

æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ˜¯**åˆ†å¸ƒå¼ç³»ç»Ÿ**ä¸­ä¸å¯ç¼ºå°‘çš„**ä¸­é—´ä»¶**ã€‚å¯å®ç°**é«˜æ€§èƒ½**ï¼Œ**é«˜å¯ç”¨**ï¼Œ**å¯ä¼¸ç¼©å’Œæœ€ç»ˆä¸€è‡´æ€§æ¶æ„**

ç›®å‰ä¸»æµçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰

- Kafkaï¼šå¤§æ•°æ®ã€å®æ—¶è®¡ç®—ï¼Œkafkaæ˜¯ä¸šå†…æ ‡å‡†ã€‚
- RabbitMQï¼šå¼€æºï¼ŒErlangå®ç°ï¼ŒSpring Cloud æ”¯æŒä¸Šä¸é”™ï¼Œç¤¾åŒºæ´»è·ƒ
- RocketMQ ï¼šJavaå®ç°ï¼Œé˜¿é‡Œå‡ºå“ã€‚
- ActiveMQ ï¼šä¸æ¸…æ¥šï¼Œæ²¡ç»è¿‡å¤§è§„æ¨¡ååé‡åœºæ™¯çš„éªŒè¯ï¼Œç¤¾åŒºä¸æ´»è·ƒ

![image-20200928164858644](https://gitee.com//chenchong0817/picture/raw/master/Aaron/20200928164900.png)

#### è§’è‰²

- ç”Ÿäº§è€…ï¼ˆProducerï¼‰

- æ¶ˆè´¹è€…ï¼ˆConsumer

- æ¶ˆæ¯ä»£ç†ï¼ˆMessage Brokerï¼‰ï¼šè´Ÿè´£**å­˜å‚¨æ¶ˆæ¯**å’Œ**è½¬å‘æ¶ˆæ¯**ä¸¤ä»¶äº‹æƒ…ã€‚

  å…¶ä¸­ï¼Œ**è½¬å‘æ¶ˆæ¯**åˆ†ä¸ºæ¨é€å’Œæ‹‰å–ä¸¤ç§æ–¹å¼ã€‚

  - **æ‹‰å–**ï¼ˆPullï¼‰
  - **æ¨é€**ï¼ˆPushï¼‰

#### åº”ç”¨åœºæ™¯

- åº”ç”¨**è§£è€¦**
  - è§£è€¦ï¼šä»ä¸»åŠ¨è°ƒç”¨çš„æ–¹å¼ï¼Œå˜æˆäº†æ¶ˆæ¯çš„è®¢é˜…å‘å¸ƒ
- **å¼‚æ­¥**å¤„ç†
  - ä¸²è¡Œè°ƒç”¨å˜ä¸ºå¼‚æ­¥ï¼Œæå‡é€Ÿåº¦ã€‚
  - å‰æï¼Œè¿”å›çš„ç»“æœä¸ä¾èµ–äºå¤„ç†çš„ç»“æœã€‚
- æµé‡**å‰Šå³°**
  - è½¬å‘åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæ…¢æ…¢å¤„ç†ã€‚
  - ç”Ÿäº§ä¸­ï¼Œå¦‚æœå¯¹æ—¶æ•ˆæ²¡æœ‰è¦æ±‚ï¼Œå¯ä»¥å…è®¸çŸ­æš‚çš„é«˜å³°æœŸç§¯å‹
- æ¶ˆæ¯**é€šè®¯**
  - æ¶ˆæ¯é€šè®¯
- æ—¥å¿—å¤„ç†ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
  - è§£å†³å¤§é‡**æ—¥å¿—ä¼ è¾“**çš„é—®é¢˜ï¼ˆELK+kafkaï¼‰

#### ç¼ºç‚¹

- **å¤æ‚åº¦æé«˜**
  - 1ï¼‰æ¶ˆæ¯æ€ä¹ˆä¸**é‡å¤**æ¶ˆæ¯ã€‚
  - 2ï¼‰æ¶ˆæ¯æ€ä¹ˆä¿è¯ä¸**ä¸¢å¤±**ã€‚
  - 3ï¼‰éœ€è¦æ¶ˆæ¯**é¡ºåº**çš„ä¸šåŠ¡åœºæ™¯ï¼Œæ€ä¹ˆå¤„ç†ã€‚
- **å¯ç”¨æ€§é™ä½**ï¼šä¸‡ä¸€æ¶ˆæ¯é˜Ÿåˆ—æŒ‚äº†ã€‚
- **ä¸€è‡´æ€§é—®é¢˜**ã€‚**ä¸€å®šè¦è¾¾åˆ°æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§**

#### æ¶ˆè´¹è¯­ä¹‰

1. æ¶ˆæ¯**è‡³å¤šè¢«æ¶ˆè´¹ä¸€æ¬¡**ï¼ˆAt most onceï¼‰ï¼šæ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±ï¼Œä½†**ç»ä¸é‡ä¼ **ã€‚

   - ååé‡å¤§ï¼Œå®¹å¿æ¶ˆæ¯ä¸¢å¤±ã€‚
   - Message Broker**ä¸**å¯¹æ¥æ”¶åˆ°çš„æ¶ˆæ¯**å“åº”**ç¡®è®¤
   - Message Brokerè½¬å‘**ä¸**è¦æ±‚**æŒä¹…**æ€§ï¼Œä¹Ÿä¸å…³å¿ƒæ¶ˆè´¹è€…æ˜¯å¦çœŸçš„æ”¶åˆ°
   - Message Brokeræ¶ˆæ¯è¢«æ‹¿èµ°å°±åˆ é™¤ï¼Œ**ä¸å…³å¿ƒæ¶ˆè´¹**è€…ï¼Œæ¶ˆè´¹æƒ…å†µ

2. æ¶ˆæ¯**è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡**ï¼ˆAt least onceï¼‰ï¼šæ¶ˆæ¯å¯ä»¥**é‡ä¼ **ï¼Œä½†ç»ä¸ä¸¢å¤±ã€‚

   - Message Broker å¿…é¡»**å“åº”**å¯¹æ¶ˆæ¯çš„ç¡®è®¤ï¼Œå¹¶æä¾›**æŒä¹…**æ€§ä¿éšœ
   - **æ¥æ”¶åˆ°æ¶ˆè´¹è€…é€šçŸ¥**åï¼Œæ‰åˆ é™¤æ¶ˆæ¯ã€‚

3. æ¶ˆæ¯**ä»…è¢«æ¶ˆè´¹ä¸€æ¬¡**ï¼ˆExactly onceï¼‰ï¼šæ¯ä¸€æ¡æ¶ˆæ¯åªè¢«ä¼ é€’ä¸€æ¬¡ã€‚

   - Message Broker ä¸Šå­˜å‚¨çš„æ¶ˆæ¯è¢« Consumer ä»…æ¶ˆè´¹ä¸€æ¬¡ã€‚

     - Message Broker**ä¸**å¯¹æ¥æ”¶åˆ°çš„æ¶ˆæ¯**å“åº”**ç¡®è®¤

     - Message Broker **æä¾›æŒä¹…æ€§**ä¿éšœ
     - æ¶ˆæ¯æœ‰å”¯ä¸€æ ‡è¯†ï¼Œ**æ¶ˆè´¹è€…è®°å½•å”¯ä¸€æ ‡å‡†**ï¼Œé˜²æ­¢é‡å¤æ¶ˆè´¹

   - Producer ä¸Šäº§ç”Ÿçš„æ¶ˆæ¯è¢« Consumer ä»…æ¶ˆè´¹ä¸€æ¬¡ã€‚

     - Message Brokerå¯¹æ¥æ”¶åˆ°çš„**æ¶ˆæ¯å“åº”ç¡®è®¤**ã€‚ **Producer è´Ÿè´£ä¸ºè¯¥æ¶ˆæ¯äº§ç”Ÿå”¯ä¸€æ ‡è¯†**ï¼Œä»¥é˜²æ­¢ Consumer é‡å¤æ¶ˆè´¹
     - Message Broker æä¾›**æŒä¹…æ€§**ä¿éšœï¼Œæ¶ˆæ¯é˜Ÿåˆ—é‡Œæœ‰å”¯ä¸€æ ‡è¯†
     - **æ¶ˆè´¹è€…è®°å½•å”¯ä¸€æ ‡è¯†**ï¼Œé˜²æ­¢é‡å¤æ¶ˆè´¹

#### æ¶ˆæ¯é˜Ÿåˆ—æœ‰å‡ ç§æŠ•é€’æ–¹å¼ï¼Ÿåˆ†åˆ«æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹

**push**

- ä¼˜ç‚¹ï¼š**å³æ—¶**
- ç¼ºç‚¹ï¼šå°±æ˜¯å—é™äº**æ¶ˆè´¹è€…**çš„æ¶ˆè´¹èƒ½åŠ›ï¼Œå¯èƒ½é€ æˆæ¶ˆæ¯çš„**å †ç§¯**

**pull**

- ä¼˜ç‚¹ï¼šæ¶ˆè´¹è€…è‡ªå·±æŒæ§è¿›åº¦ï¼Œæ¶ˆè´¹è€…ä¸ä¼šå †ç§¯ï¼Œä½†æ¶ˆæ¯é˜Ÿåˆ—å¯èƒ½ä¼šå †ç§¯ã€‚
- ç¼ºç‚¹ï¼š**å»¶è¿Ÿã€å¿™ç­‰**

**ç›®å‰çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒåŸºäº push + pull æ¨¡å¼ç»“åˆçš„æ–¹å¼**ï¼ŒBroker ä»…ä»…å‘Šè¯‰ Consumer æœ‰æ–°çš„æ¶ˆæ¯ï¼Œå…·ä½“çš„æ¶ˆæ¯æ‹‰å–ï¼Œè¿˜æ˜¯ Consumer è‡ªå·±ä¸»åŠ¨æ‹‰å–ã€‚

##### æ¶ˆè´¹è€…å®ç°**å¹‚ç­‰æ€§**ï¼Ÿæ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹ï¼Ÿ

**æ¶ˆæ¯ä»…è¢«æ¶ˆè´¹ä¸€æ¬¡**ï¼Œä¸”**æ¯æ¡æ¶ˆæ¯ä» Producer ä¿è¯è¢«é€è¾¾ï¼Œå¹¶ä¸”è¢« Consumer ä»…æ¶ˆè´¹ä¸€æ¬¡**ã€‚

é‡å¤æ¶ˆè´¹ï¼šoffsetï¼Œæ¶ˆè´¹è€…æŒ‚äº†

æ–¹å¼ï¼š

1. **ä¸šåŠ¡å±‚è‡ªå·±ç¡®è®¤æ˜¯å¦æ˜¯å¦æ¶ˆè´¹è¿‡**
2. **äº‹ç‰©**ï¼ŒZookeeper å’Œ Redis åœ¨è·å–åˆ†å¸ƒå¼é”

##### å¦‚ä½•ä¿è¯ç”Ÿäº§è€…çš„å‘é€æ¶ˆæ¯çš„**å¯é æ€§**ï¼Ÿ

###### **RabbitMQ** 

![image-20200928174648240](https://gitee.com//chenchong0817/picture/raw/master/Aaron/20200928174649.png)

1. ç”Ÿäº§è€…å¼„ä¸¢äº†æ•°æ®

   1. æä¾›äº‹ç‰©ï¼ˆåŒæ­¥ï¼‰ï¼Œä¼šé™ä½åå

      ```java
      // å¼€å¯äº‹åŠ¡
      channel.txSelect
      try {
          // è¿™é‡Œå‘é€æ¶ˆæ¯
      } catch (Exception e) {
          channel.txRollback
      
          // è¿™é‡Œå†æ¬¡é‡å‘è¿™æ¡æ¶ˆæ¯
      }
      
      // æäº¤äº‹åŠ¡
      channel.txCommit
      ```

   2. å¼€å¯ç”Ÿäº§è€… `confirm` æ¨¡å¼ï¼ˆæ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼‰ï¼š

      - å¼€å¯ `confirm` æ¨¡å¼ä¹‹åï¼Œä½ æ¯æ¬¡å†™çš„æ¶ˆæ¯éƒ½ä¼šåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ idï¼Œç„¶åå¦‚æœå†™å…¥äº† RabbitMQ ä¸­ï¼ŒRabbitMQ ä¼šç»™ä½ å›ä¼ ä¸€ä¸ª `ack` æ¶ˆæ¯ï¼Œå‘Šè¯‰ä½ è¯´è¿™ä¸ªæ¶ˆæ¯ ok äº†ã€‚
      - å¦‚æœ `RabbitMQ` æ²¡èƒ½å¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œä¼š**å›è°ƒä½ çš„**ä¸€ä¸ª `nack` æ¥å£ï¼Œå‘Šè¯‰ä½ è¿™ä¸ªæ¶ˆæ¯æ¥æ”¶å¤±è´¥ï¼Œä½ å¯ä»¥é‡è¯•ã€‚
      - è€Œä¸”ä½ å¯ä»¥ç»“åˆè¿™ä¸ªæœºåˆ¶**è‡ªå·±åœ¨å†…å­˜é‡Œç»´æŠ¤æ¯ä¸ªæ¶ˆæ¯ id çš„çŠ¶æ€**ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šæ—¶é—´è¿˜æ²¡æ¥æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯çš„å›è°ƒï¼Œé‚£ä¹ˆä½ å¯ä»¥é‡å‘ã€‚

2. RabbitMQ å¼„ä¸¢äº†æ•°æ®

   1. **å¼€å¯ RabbitMQ çš„æŒä¹…åŒ–**
      - åˆ›å»º queue çš„æ—¶å€™å°†å…¶è®¾ç½®ä¸ºæŒä¹…åŒ–
      - å‘é€æ¶ˆæ¯çš„æ—¶å€™å°†æ¶ˆæ¯çš„ `deliveryMode` è®¾ç½®ä¸º `2`ï¼ˆæŒä¹…åŒ–äº†æ‰è¿”å›ï¼‰
      - æŒä¹…åŒ–å¯ä»¥è·Ÿç”Ÿäº§è€…é‚£è¾¹çš„ `confirm` æœºåˆ¶é…åˆ

3. æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ®

   - RabbitMQ æä¾›çš„ `ack` æœºåˆ¶ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯**ä½ å¿…é¡»å…³é—­ RabbitMQ çš„è‡ªåŠ¨ ack** ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ª api æ¥è°ƒç”¨å°±è¡Œï¼Œç„¶åæ¯æ¬¡ä½ è‡ªå·±ä»£ç é‡Œç¡®ä¿å¤„ç†å®Œçš„æ—¶å€™ï¼Œå†åœ¨ç¨‹åºé‡Œ `ack` ä¸€æŠŠã€‚
   - [ä¸ºé˜²æ­¢ä»»åŠ¡æ‰§è¡ŒæœŸé—´å‡ºé”™](https://www.cnblogs.com/julygift/p/9445107.html)ï¼Œè®¾ç½®NO_ACK=FALSEæ ‡å¿—ï¼Œè¿™æ ·ã€ä¸€æ—¦ä»»åŠ¡æ²¡æœ‰åº”ç­”çš„è¯ï¼Œç›¸åº”çš„ä»»åŠ¡å°±ä¼šè¢«RabbitMQè‡ªåŠ¨Re-Queue,é¿å…ä¸¢å¤±ä»»åŠ¡
     - é—®é¢˜-è¶…æ—¶ä¸€ç›´Re-Queueï¼Œæ­»å¾ªç¯ã€‚
   - ç»‘å®šæ­»ä¿¡é˜Ÿåˆ—

###### **Kafka**

1. æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ®
   - **å…³é—­è‡ªåŠ¨æäº¤** offsetï¼Œåœ¨å¤„ç†å®Œä¹‹åè‡ªå·±**æ‰‹åŠ¨æäº¤ offset**ï¼Œå°±å¯ä»¥ä¿è¯æ•°æ®ä¸ä¼šä¸¢ï¼Œ**å¯èƒ½ä¼šæœ‰é‡å¤æ¶ˆè´¹**ï¼Œè‡ªå·±ä¿è¯å¹‚ç­‰æ€§
2. Kafka å¼„ä¸¢äº†æ•°æ®
   - broker å®•æœºï¼Œç„¶åé‡æ–°é€‰ä¸¾ partition çš„ leaderï¼Œæ²¡æ¥å¾—åŠåŒæ­¥ï¼Œä¸¢å¤±æ•°æ®ï¼Œ
   - ä¸ºäº†é˜²æ­¢leaderåˆ‡æ¢ä¸ä¸¢æ•°æ®
     - ç»™ topic è®¾ç½® `replication.factor` å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº 1ï¼Œè¦æ±‚æ¯ä¸ª**partition å¿…é¡»æœ‰è‡³å°‘ 2 ä¸ªå‰¯æœ¬**ã€‚
     - åœ¨ Kafka æœåŠ¡ç«¯è®¾ç½® `min.insync.replicas` å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº 1ï¼Œè¿™ä¸ªæ˜¯**è¦æ±‚ä¸€ä¸ª leader è‡³å°‘æ„ŸçŸ¥åˆ°æœ‰è‡³å°‘ä¸€ä¸ª follower è¿˜è·Ÿè‡ªå·±ä¿æŒè”ç³»ï¼Œæ²¡æ‰é˜Ÿ**ï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿ leader æŒ‚äº†è¿˜æœ‰ä¸€ä¸ª follower å§ã€‚
     - åœ¨ **producer ç«¯**è®¾ç½® `acks=all` ï¼šè¿™ä¸ªæ˜¯è¦æ±‚æ¯æ¡æ•°æ®ï¼Œå¿…é¡»æ˜¯**å†™å…¥æ‰€æœ‰ replica ä¹‹åï¼Œæ‰èƒ½è®¤ä¸ºæ˜¯å†™æˆåŠŸäº†**ã€‚
     - åœ¨ **producer ç«¯**è®¾ç½® `retries=MAX` ï¼ˆå¾ˆå¤§å¾ˆå¤§å¾ˆå¤§çš„ä¸€ä¸ªå€¼ï¼Œæ— é™æ¬¡é‡è¯•çš„æ„æ€ï¼‰ï¼šè¿™ä¸ªæ˜¯**è¦æ±‚ä¸€æ—¦å†™å…¥å¤±è´¥ï¼Œå°±æ— é™é‡è¯•**ï¼Œå¡åœ¨è¿™é‡Œäº†ã€‚
3. ç”Ÿäº§è€…ä¼šä¸ä¼šå¼„ä¸¢æ•°æ®ï¼Ÿ
   - è®¾ç½®äº† `acks=all`ã€`retries=Ingeter.Max` ,ç”Ÿäº§è€…ä¼šè‡ªåŠ¨ä¸æ–­çš„é‡è¯•ï¼Œé‡è¯•æ— é™æ¬¡ã€‚

##### å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ

åœºæ™¯ï¼š mysql `binlog` æ—¥å¿—ï¼Œåˆ°MQï¼Œå†å‡ºæ¥ï¼Œé¡ºåºå¾—ä¸€è‡´ã€‚å¤šä¸ªæ¶ˆè´¹è€…ï¼Œå¤šä¸ªçº¿ç¨‹æ¶ˆè´¹ã€‚

è§£å†³é¡ºåºå‹ï¼Œå¾—åŒæ­¥.

###### è§£å†³æ–¹æ¡ˆ

**RabbitMQ**

1. æ‹†åˆ†å¤šä¸ª queueï¼Œæ¯ä¸ª queue ä¸€ä¸ª consumer

2. ä¸€ä¸ª queue ä½†æ˜¯å¯¹åº”ä¸€ä¸ª consumerï¼Œç„¶åè¿™ä¸ª consumer å†…éƒ¨ç”¨**å†…å­˜é˜Ÿåˆ—åšæ’é˜Ÿ**ï¼Œç„¶ååˆ†å‘ç»™åº•å±‚ä¸åŒçš„ worker æ¥å¤„ç†ã€‚

   ![rabbitmq-order-02](https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/rabbitmq-order-02.png)

**Kafka**

1. ä¸€ä¸ª topicï¼Œæ¯ä¸ªä¸ª partitionï¼Œå¯¹åº”ä¸€ä¸ª consumerï¼Œå†…éƒ¨å•çº¿ç¨‹æ¶ˆè´¹

2. å†å†™ **N ä¸ªå†…å­˜ queue**ï¼Œå…·æœ‰ç›¸åŒ key çš„æ•°æ®éƒ½åˆ°åŒä¸€ä¸ªå†…å­˜ queueï¼›ç„¶åå¯¹äº N ä¸ªçº¿ç¨‹ï¼Œ**æ¯ä¸ªçº¿ç¨‹åˆ†åˆ«æ¶ˆè´¹ä¸€ä¸ªå†…å­˜ queue** å³å¯ï¼Œè¿™æ ·å°±èƒ½ä¿è¯é¡ºåºæ€§ã€‚

   ![kafka-order-02](https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/kafka-order-02.png)

##### å¦‚ä½•è§£å†³æ¶ˆæ¯ç§¯å‹çš„é—®é¢˜ï¼Ÿ

1. å…ˆä¿®å¤ consumer ï¼Œå°†ç°æœ‰ consumer éƒ½åœæ‰ã€‚
2. **æ–°å»ºä¸€ä¸ª topic**ï¼Œ`partition` æ˜¯åŸæ¥çš„ `10` å€ï¼Œä¸´æ—¶å»ºç«‹å¥½åŸå…ˆ 10 å€çš„ queue æ•°é‡ã€‚
3. ç„¶åå†™ä¸€ä¸ªä¸´æ—¶çš„**åˆ†å‘æ•°æ®çš„ consumer ç¨‹åº**ï¼Œè¿™ä¸ªç¨‹åºéƒ¨ç½²ä¸Šå»æ¶ˆè´¹ç§¯å‹çš„æ•°æ®ï¼Œ**æ¶ˆè´¹ä¹‹åä¸åšè€—æ—¶çš„å¤„ç†**ï¼Œç›´æ¥å‡åŒ€è½®è¯¢å†™å…¥ä¸´æ—¶å»ºç«‹å¥½çš„ 10 å€æ•°é‡çš„ queueã€‚
4. æ¥ç€ä¸´æ—¶å¾ç”¨ 10 å€çš„æœºå™¨æ¥`éƒ¨ç½² consumer`ï¼Œ**æ¯ä¸€æ‰¹ consumer æ¶ˆè´¹ä¸€ä¸ªä¸´æ—¶ queue çš„æ•°æ®**ã€‚è¿™ç§åšæ³•ç›¸å½“äºæ˜¯ä¸´æ—¶å°† queue èµ„æºå’Œ consumer èµ„æºæ‰©å¤§ 10 å€ï¼Œä»¥æ­£å¸¸çš„ 10 å€é€Ÿåº¦æ¥æ¶ˆè´¹æ•°æ®ã€‚
5. ç­‰å¿«é€Ÿæ¶ˆè´¹å®Œç§¯å‹æ•°æ®ä¹‹åï¼Œ**å¾—æ¢å¤åŸå…ˆéƒ¨ç½²çš„æ¶æ„**ï¼Œ**é‡æ–°**ç”¨åŸå…ˆçš„ consumer æœºå™¨æ¥æ¶ˆè´¹æ¶ˆæ¯ã€‚

##### å¦‚ä½•è§£å†³æ¶ˆæ¯è¿‡æœŸçš„é—®é¢˜ï¼Ÿ

å¤§é‡ç§¯å‹ï¼Œä¸¢å¼ƒï¼Œ**è¶æ²¡äººçš„æ—¶å€™ï¼Œä¸¢å¼ƒæ‰¹é‡é‡å¯¼**

##### æ¶ˆæ¯é˜Ÿåˆ—å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ

###### RabbitMQ ï¼š

1. å•æœºï¼šDEMO
2. æ™®é€šé›†ç¾¤ï¼šåˆ›å»ºçš„**åˆ›å»ºçš„ queueï¼Œåªä¼šæ”¾åœ¨ä¸€ä¸ª RabbitMQ å®ä¾‹ä¸Š**ï¼Œæ¯ä¸ªå®ä¾‹æ”¾é˜Ÿåˆ—çš„å…ƒæ•°æ®ã€‚é›†ç¾¤é—´å¯èƒ½äº§ç”Ÿå¤§é‡çš„æ•°æ®ä¼ è¾“ï¼Œæ²¡å¤‡ä»½ï¼Œå¯ç”¨æ€§æ— æ³•ä¿éšœã€‚å°±æ˜¯ä¸ºäº†æé«˜ååé‡ã€‚
3. é•œåƒé›†ç¾¤æ¨¡å¼ï¼ˆé«˜å¯ç”¨æ€§ï¼‰ï¼šåŸºäºä¸»ä»åšé«˜å¯ç”¨ã€‚ä½ åˆ›å»ºçš„ queueï¼Œæ— è®ºå…ƒæ•°æ®è¿˜æ˜¯ queue é‡Œçš„æ¶ˆæ¯éƒ½ä¼š**å­˜åœ¨äºå¤šä¸ªå®ä¾‹ä¸Š**ï¼Œä¹Ÿå°±æ˜¯é•œåƒ
   - å¼€é”€å¤§ï¼Œ**ä¸æ˜¯åˆ†å¸ƒå¼**ï¼Œæ‰€æœ‰æ•°æ®æ”¾åˆ°ä¸€ä¸ªèŠ‚ç‚¹é‡Œï¼Œ**ä¸èƒ½çº¿æ€§æ‰©å±•**ã€‚

###### Kafka çš„é«˜å¯ç”¨æ€§

ç”±å¤šä¸ª `broker` ç»„æˆï¼Œæ¯ä¸ª broker æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼›ä½ åˆ›å»ºä¸€ä¸ª topicï¼Œè¿™ä¸ª topic å¯ä»¥åˆ’åˆ†ä¸ºå¤šä¸ª `partition`ï¼Œæ¯ä¸ª partition å¯ä»¥å­˜åœ¨äºä¸åŒçš„ broker ä¸Šï¼Œæ¯ä¸ª partition å°±æ”¾ä¸€éƒ¨åˆ†æ•°æ®ã€‚

è¿™å°±æ˜¯**å¤©ç„¶çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—**ï¼Œå°±æ˜¯è¯´ä¸€ä¸ª topic çš„æ•°æ®ï¼Œæ˜¯**åˆ†æ•£æ”¾åœ¨å¤šä¸ªæœºå™¨ä¸Šçš„ï¼Œæ¯ä¸ªæœºå™¨å°±æ”¾ä¸€éƒ¨åˆ†æ•°æ®**ã€‚

- Kafka 0.8 ä»¥åï¼Œæä¾›äº† HA æœºåˆ¶ï¼Œå°±æ˜¯ replicaï¼ˆå¤åˆ¶å“ï¼‰ å‰¯æœ¬æœºåˆ¶
- æ‰€æœ‰ replica ä¼šé€‰ä¸¾ä¸€ä¸ª leader å‡ºæ¥ï¼Œé‚£ä¹ˆç”Ÿäº§å’Œæ¶ˆè´¹éƒ½è·Ÿè¿™ä¸ª **leader æ‰“äº¤é“**ï¼Œç„¶åå…¶ä»– replica å°±æ˜¯ followerã€‚
- **å†™æ•°æ®**çš„æ—¶å€™ï¼Œç”Ÿäº§è€…å°±å†™ leaderï¼Œç„¶å leader å°†æ•°æ®è½åœ°å†™æœ¬åœ°ç£ç›˜ï¼Œæ¥ç€å…¶ä»– follower è‡ªå·±**ä¸»åŠ¨ä» leader æ¥ pull æ•°æ®**
- **æ¶ˆè´¹**çš„æ—¶å€™ï¼Œåªä¼šä» leader å»è¯»ï¼Œä½†æ˜¯åªæœ‰å½“ä¸€ä¸ªæ¶ˆæ¯å·²ç»è¢«æ‰€æœ‰ follower éƒ½åŒæ­¥æˆåŠŸè¿”å› ack çš„æ—¶å€™ï¼Œè¿™ä¸ªæ¶ˆæ¯æ‰ä¼šè¢«æ¶ˆè´¹è€…è¯»åˆ°ã€‚
-  broker å®•æœºï¼šä¼šä» follower ä¸­**é‡æ–°é€‰ä¸¾**ä¸€ä¸ªæ–°çš„ leader å‡ºæ¥

#### [è®¾è®¡ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—](https://www.cnblogs.com/expiator/p/10021298.html)

- å¯ä¼¸ç¼©ï¼Œbroker -> topic -> partition
- è½åœ°ç£ç›˜ï¼šé¡ºåºå†™
- å¯ç”¨æ€§ï¼šå¤šå‰¯æœ¬ -> leader & follower -> broker æŒ‚äº†é‡æ–°é€‰ä¸¾ leader å³å¯å¯¹å¤–æœåŠ¡
- 0ä¸¢å¤±

# RabbitMQ 

## RabbitMQ æ˜¯ä»€ä¹ˆï¼Ÿ

RabbitMQ æ˜¯ä¸€ä¸ªç”± Erlang è¯­è¨€å¼€å‘çš„ AMQP çš„å¼€æºå®ç°ã€‚

> AMQP ï¼šAdvanced Message Queueï¼Œé«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ã€‚å®ƒæ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ï¼ŒåŸºäºæ­¤åè®®çš„å®¢æˆ·ç«¯ä¸æ¶ˆæ¯ä¸­é—´ä»¶å¯ä¼ é€’æ¶ˆæ¯ï¼Œå¹¶ä¸å—äº§å“ã€å¼€å‘è¯­è¨€ç­‰æ¡ä»¶çš„é™åˆ¶ã€‚

RabbitMQå…·ä½“ç‰¹ç‚¹åŒ…æ‹¬ï¼š

- 1ã€å¯é æ€§ï¼ˆReliabilityï¼‰

- 2ã€çµæ´»çš„è·¯ç”±ï¼ˆFlexible Routingï¼‰

  > åœ¨æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—ä¹‹å‰ï¼Œé€šè¿‡ Exchange æ¥è·¯ç”±æ¶ˆæ¯çš„ã€‚å¯¹äºå…¸å‹çš„è·¯ç”±åŠŸèƒ½ï¼ŒRabbitMQ å·²ç»æä¾›äº†ä¸€äº›å†…ç½®çš„ Exchange æ¥å®ç°ã€‚é’ˆå¯¹æ›´å¤æ‚çš„è·¯ç”±åŠŸèƒ½ï¼Œå¯ä»¥å°†å¤šä¸ª Exchange ç»‘å®šåœ¨ä¸€èµ·ï¼Œä¹Ÿé€šè¿‡æ’ä»¶æœºåˆ¶å®ç°è‡ªå·±çš„ Exchange ã€‚

- 3ã€æ¶ˆæ¯é›†ç¾¤ï¼ˆClusteringï¼‰

- 4ã€é«˜å¯ç”¨ï¼ˆHighly Available Queuesï¼‰

- 6ã€å¤šè¯­è¨€å®¢æˆ·ç«¯ï¼ˆMany Clientsï¼‰

  > RabbitMQ å‡ ä¹æ”¯æŒæ‰€æœ‰å¸¸ç”¨è¯­è¨€ï¼Œæ¯”å¦‚ Javaã€.NETã€Ruby ç­‰ç­‰ã€‚

- 7ã€ç®¡ç†ç•Œé¢ï¼ˆManagement UIï¼‰

  > RabbitMQ æä¾›äº†ä¸€ä¸ªæ˜“ç”¨çš„ç”¨æˆ·ç•Œé¢ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥ç›‘æ§å’Œç®¡ç†æ¶ˆæ¯ Broker çš„è®¸å¤šæ–¹é¢ã€‚

- 8ã€**è·Ÿè¸ªæœºåˆ¶**ï¼ˆTracingï¼‰

  > å¦‚æœæ¶ˆæ¯å¼‚å¸¸ï¼ŒRabbitMQ æä¾›äº†æ¶ˆæ¯è·Ÿè¸ªæœºåˆ¶ï¼Œä½¿ç”¨è€…å¯ä»¥æ‰¾å‡ºå‘ç”Ÿäº†ä»€ä¹ˆã€‚

- 9ã€æ’ä»¶æœºåˆ¶ï¼ˆPlugin Systemï¼‰

## RabbitMQ ä¸­çš„ Broker æ˜¯æŒ‡ä»€ä¹ˆï¼ŸCluster åˆæ˜¯æŒ‡ä»€ä¹ˆï¼Ÿ

- Brokerï¼ˆä»£ç†ï¼‰ ï¼Œæ˜¯æŒ‡**ä¸€ä¸ªæˆ–å¤šä¸ª erlang node çš„é€»è¾‘åˆ†ç»„**ï¼Œä¸” node ä¸Šè¿è¡Œç€ RabbitMQ åº”ç”¨ç¨‹åºã€‚
- Clusterï¼ˆé›†ç¾¤ï¼‰ ï¼Œæ˜¯åœ¨ Broker çš„åŸºç¡€ä¹‹ä¸Šï¼Œå¢åŠ äº† node ä¹‹é—´å…±äº«å…ƒæ•°æ®çš„çº¦æŸã€‚

ğŸ¦… **vhost æ˜¯ä»€ä¹ˆï¼Ÿèµ·ä»€ä¹ˆä½œç”¨ï¼Ÿ**

`vhost` å¯ä»¥ç†è§£ä¸º`è™šæ‹Ÿ Broker` ï¼Œå³ mini-RabbitMQ server ã€‚å…¶å†…éƒ¨å‡å«æœ‰ç‹¬ç«‹çš„ queueã€exchange å’Œ binding ç­‰ï¼Œä½†æœ€æœ€é‡è¦çš„æ˜¯ï¼Œå…¶æ‹¥æœ‰ç‹¬ç«‹çš„æƒé™ç³»ç»Ÿï¼Œå¯ä»¥åšåˆ° vhost èŒƒå›´çš„ç”¨æˆ·æ§åˆ¶ã€‚å½“ç„¶ï¼Œä» RabbitMQ çš„å…¨å±€è§’åº¦ï¼Œvhost å¯ä»¥ä½œä¸ºä¸åŒæƒé™éš”ç¦»çš„æ‰‹æ®µï¼ˆä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯ä¸åŒçš„åº”ç”¨å¯ä»¥è·‘åœ¨ä¸åŒçš„ vhost ä¸­ï¼‰ã€‚

> è¿™ä¸ªï¼Œå’Œ Tomcatã€Nginxã€Apache çš„ vhost æ˜¯ä¸€æ ·çš„æ¦‚å¿µã€‚

## ä»€ä¹ˆæ˜¯å…ƒæ•°æ®ï¼Ÿå…ƒæ•°æ®åˆ†ä¸ºå“ªäº›ç±»å‹ï¼ŸåŒ…æ‹¬å“ªäº›å†…å®¹ï¼Ÿ

åœ¨é Cluster æ¨¡å¼ä¸‹ï¼Œå…ƒæ•°æ®ä¸»è¦åˆ†ä¸ºï¼š

- **Queue å…ƒæ•°æ®**ï¼ˆqueue åå­—å’Œå±æ€§ç­‰ï¼‰
- **Exchange å…ƒæ•°æ®**ï¼ˆexchange åå­—ã€ç±»å‹å’Œå±æ€§ç­‰ï¼‰
- **Binding å…ƒæ•°æ®**ï¼ˆå­˜æ”¾è·¯ç”±å…³ç³»çš„æŸ¥æ‰¾è¡¨ï¼‰
- **Vhost å…ƒæ•°æ®**ï¼ˆvhost èŒƒå›´å†…é’ˆå¯¹å‰ä¸‰è€…çš„åå­—ç©ºé—´çº¦æŸå’Œå®‰å…¨å±æ€§è®¾ç½®ï¼‰ã€‚

ğŸ¦… **ä¸ Cluster ç›¸å…³çš„å…ƒæ•°æ®æœ‰å“ªäº›ï¼Ÿå…ƒæ•°æ®æ˜¯å¦‚ä½•ä¿å­˜çš„ï¼Ÿå…ƒæ•°æ®åœ¨ Cluster ä¸­æ˜¯å¦‚ä½•åˆ†å¸ƒçš„ï¼Ÿ**

åœ¨ Cluster æ¨¡å¼ä¸‹ï¼Œè¿˜åŒ…æ‹¬ Cluster ä¸­ **node ä½ç½®ä¿¡æ¯å’Œ node å…³ç³»ä¿¡æ¯**ã€‚

å…ƒæ•°æ®æ ¹æ® erlang node çš„ç±»å‹ç¡®å®šæ˜¯ä»…ä¿å­˜äº RAM ä¸­ï¼Œè¿˜æ˜¯åŒæ—¶ä¿å­˜åœ¨ RAM å’Œ disk ä¸Šã€‚å…ƒæ•°æ®åœ¨ Cluster ä¸­æ˜¯å…¨ node åˆ†å¸ƒçš„ã€‚

ä¸‹å›¾æ‰€ç¤ºä¸º queue çš„å…ƒæ•°æ®åœ¨å• node å’Œ cluster ä¸¤ç§æ¨¡å¼ä¸‹çš„åˆ†å¸ƒå›¾ï¼š

[![åˆ†å¸ƒå›¾](http://static.iocoder.cn/c7566feb7a61cb647296a7224ba7f39d)](http://static.iocoder.cn/c7566feb7a61cb647296a7224ba7f39d)åˆ†å¸ƒå›¾

ğŸ¦… **RAM node å’Œ Disk node çš„åŒºåˆ«ï¼Ÿ**

- RAM node ä»…å°† fabricï¼ˆå³ queueã€exchange å’Œ bindingç­‰ RabbitMQåŸºç¡€æ„ä»¶ï¼‰ç›¸å…³å…ƒæ•°æ®ä¿å­˜åˆ°å†…å­˜ä¸­ï¼Œä½† Disk node ä¼šåœ¨å†…å­˜å’Œç£ç›˜ä¸­å‡è¿›è¡Œå­˜å‚¨ã€‚
- RAM node ä¸Š**å”¯ä¸€ä¼šå­˜å‚¨åˆ°ç£ç›˜ä¸Šçš„å…ƒæ•°æ®æ˜¯ Cluster ä¸­ä½¿ç”¨çš„ Disk node çš„åœ°å€**ã€‚å¹¶ä¸”è¦æ±‚åœ¨ RabbitMQ Cluster ä¸­è‡³å°‘å­˜åœ¨ä¸€ä¸ª Disk node ã€‚

## RabbitMQ æ¦‚å¿µé‡Œçš„ channelã€exchange å’Œ queue æ˜¯ä»€ä¹ˆï¼Ÿ

- `queue` å…·æœ‰è‡ªå·±çš„ erlang è¿›ç¨‹ï¼›
- `exchange` å†…éƒ¨å®ç°ä¸ºä¿å­˜ `binding` å…³ç³»çš„æŸ¥æ‰¾è¡¨ï¼›
- `channel` æ˜¯å®é™…è¿›è¡Œ**è·¯ç”±å·¥ä½œçš„å®ä½“**ï¼Œå³è´Ÿè´£æŒ‰ç…§ routing_key å°† message æŠ•é€’ç»™ queue ã€‚

ç”± AMQP åè®®æè¿°å¯çŸ¥ï¼Œchannel æ˜¯çœŸå® TCP è¿æ¥ä¹‹ä¸Šçš„è™šæ‹Ÿè¿æ¥ï¼Œæ‰€æœ‰ AMQP å‘½ä»¤éƒ½æ˜¯é€šè¿‡ channel å‘é€çš„ï¼Œä¸”æ¯ä¸€ä¸ª channel æœ‰å”¯ä¸€çš„ ID ã€‚

- ä¸€ä¸ª channel åªèƒ½è¢«å•ç‹¬ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä½¿ç”¨ï¼Œæ•…æŠ•é€’åˆ°ç‰¹å®š channel ä¸Šçš„ message æ˜¯æœ‰é¡ºåºçš„ã€‚ä½†ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸Šå…è®¸ä½¿ç”¨å¤šä¸ª channel ã€‚

- channel å·ä¸º 0 çš„ channel ç”¨äºå¤„ç†æ‰€æœ‰å¯¹äºå½“å‰ connection å…¨å±€æœ‰æ•ˆçš„å¸§ï¼Œè€Œ 1-65535 å· channel ç”¨äºå¤„ç†å’Œç‰¹å®š channel ç›¸å…³çš„å¸§ã€‚

- AMQP åè®®ç»™å‡ºçš„ channel å¤ç”¨æ¨¡å‹å¦‚ä¸‹ï¼š

  ![channel å¤ç”¨æ¨¡å‹](http://static.iocoder.cn/0cb69bbcda6043bc0c9d7733de251d76)

  channel å¤ç”¨æ¨¡å‹

  - å…¶ä¸­æ¯ä¸€ä¸ª channel è¿è¡Œåœ¨ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ä¸Šï¼Œå¤šçº¿ç¨‹å…±äº«åŒä¸€ä¸ª socket ã€‚

ğŸ¦… **æ¶ˆæ¯åŸºäºä»€ä¹ˆä¼ è¾“ï¼Ÿ**

ç”±äº TCP è¿æ¥çš„**åˆ›å»ºå’Œé”€æ¯å¼€é”€è¾ƒå¤§**ï¼Œä¸”å¹¶å‘æ•°å—ç³»ç»Ÿèµ„æºé™åˆ¶ï¼Œä¼šé€ æˆæ€§èƒ½ç“¶é¢ˆã€‚RabbitMQ ä½¿ç”¨ä¿¡é“(`channel` )çš„æ–¹å¼æ¥ä¼ è¾“æ•°æ®ã€‚ä¿¡é“æ˜¯**å»ºç«‹åœ¨çœŸå®çš„ TCP è¿æ¥å†…çš„è™šæ‹Ÿè¿æ¥**ï¼Œä¸”æ¯æ¡ TCPè¿æ¥ä¸Šçš„ä¿¡é“æ•°é‡æ²¡æœ‰é™åˆ¶ã€‚

ğŸ¦… **RabbitMQ ä¸Šçš„ä¸€ä¸ª queue ä¸­å­˜æ”¾çš„ message æ˜¯å¦æœ‰æ•°é‡é™åˆ¶ï¼Ÿ**

å¯ä»¥è®¤ä¸ºæ˜¯æ— é™åˆ¶ï¼Œå› ä¸ºé™åˆ¶å–å†³äºæœºå™¨çš„å†…å­˜ï¼Œä½†æ˜¯æ¶ˆæ¯è¿‡å¤šä¼šå¯¼è‡´å¤„ç†æ•ˆç‡çš„ä¸‹é™ã€‚

> ä¸‹é¢çš„å‡ ä¸ªé—®é¢˜ï¼ŒCluster ç›¸å…³ã€‚

ğŸ¦… **åœ¨å• node ç³»ç»Ÿå’Œå¤š node æ„æˆçš„ cluster ç³»ç»Ÿä¸­å£°æ˜ queueã€exchange ï¼Œä»¥åŠè¿›è¡Œ binding ä¼šæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ**

- å½“ä½ åœ¨å• node ä¸Šå£°æ˜ queue æ—¶ï¼Œåªè¦è¯¥ node ä¸Šç›¸å…³å…ƒæ•°æ®è¿›è¡Œäº†å˜æ›´ï¼Œä½ å°±ä¼šå¾—åˆ° `Queue.Declare-ok` å›åº”ï¼›è€Œåœ¨ cluster ä¸Šå£°æ˜ queue ï¼Œåˆ™è¦æ±‚ cluster ä¸Šçš„**å…¨éƒ¨ node éƒ½è¦è¿›è¡Œå…ƒæ•°æ®æˆåŠŸæ›´æ–°**ï¼Œæ‰ä¼šå¾—åˆ° `Queue.Declare-ok` å›åº”ã€‚
- å¦å¤–ï¼Œè‹¥ **node ç±»å‹ä¸º RAM node** åˆ™å˜æ›´çš„æ•°æ®ä»…ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œè‹¥ç±»å‹ä¸º Disk node åˆ™è¿˜è¦å˜æ›´ä¿å­˜åœ¨ç£ç›˜ä¸Šçš„æ•°æ®ã€‚

ğŸ¦… **å®¢æˆ·ç«¯è¿æ¥åˆ° Cluster ä¸­çš„ä»»æ„ node ä¸Šæ˜¯å¦éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼Ÿ**

æ˜¯çš„ã€‚å®¢æˆ·ç«¯æ„Ÿè§‰ä¸åˆ°æœ‰ä½•ä¸åŒã€‚

ğŸ¦… **è‹¥ Cluster ä¸­æ‹¥æœ‰æŸä¸ª queue çš„ owner node å¤±æ•ˆäº†ï¼Œä¸”è¯¥ queue è¢«å£°æ˜å…·æœ‰ durable å±æ€§(æŒä¹…åŒ–å±æ€§)ï¼Œæ˜¯å¦èƒ½å¤ŸæˆåŠŸä»å…¶ä»– node ä¸Šé‡æ–°å£°æ˜è¯¥ queue ï¼Ÿ**

- ä¸èƒ½ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†å¾—åˆ° 404 NOT_FOUND é”™è¯¯ã€‚åªèƒ½ç­‰ queue æ‰€å±çš„ node æ¢å¤åæ‰èƒ½ä½¿ç”¨è¯¥ queue ã€‚
- ä½†è‹¥è¯¥ queue æœ¬èº«ä¸å…·æœ‰ durable å±æ€§ï¼Œåˆ™å¯åœ¨å…¶ä»– node ä¸Šé‡æ–°å£°æ˜ã€‚

ğŸ¦… **Cluster ä¸­ node çš„å¤±æ•ˆä¼šå¯¹ consumer äº§ç”Ÿä»€ä¹ˆå½±å“ï¼Ÿè‹¥æ˜¯åœ¨ cluster ä¸­åˆ›å»ºäº† mirrored queueï¼ˆé•œåƒé˜Ÿåˆ—ï¼‰ ï¼Œè¿™æ—¶ node å¤±æ•ˆä¼šå¯¹ consumer äº§ç”Ÿä»€ä¹ˆå½±å“ï¼Ÿ**

- è‹¥æ˜¯ consumer æ‰€è¿æ¥çš„é‚£ä¸ª node å¤±æ•ˆï¼ˆæ— è®ºè¯¥ node æ˜¯å¦ä¸º consumer æ‰€è®¢é˜… queue çš„ owner nodeï¼‰ï¼Œåˆ™ **consumer ä¼šåœ¨å‘ç° TCP è¿æ¥æ–­å¼€æ—¶ï¼ŒæŒ‰æ ‡å‡†è¡Œä¸ºæ‰§è¡Œé‡è¿é€»è¾‘ï¼Œå¹¶æ ¹æ® â€œAssume Nothingï¼ˆä¸åšä»»ä½•å‡è®¾ï¼‰â€ åŸåˆ™é‡å»ºç›¸åº”çš„ fabric å³å¯**ã€‚
- è‹¥æ˜¯å¤±æ•ˆçš„ node ä¸º consumer è®¢é˜… queue çš„ owner nodeï¼Œ**åˆ™ consumer åªèƒ½é€šè¿‡ Consumer Cancellation Notificationï¼ˆæ¶ˆè´¹è€…å–æ¶ˆé€šçŸ¥ï¼‰ æœºåˆ¶æ¥æ£€æµ‹ä¸è¯¥ queue è®¢é˜…å…³ç³»çš„ç»ˆæ­¢ï¼Œå¦åˆ™ä¼šå‡ºç°å‚»ç­‰å´æ²¡æœ‰ä»»ä½•æ¶ˆæ¯æ¥åˆ°çš„é—®é¢˜ã€‚**

ğŸ¦… **Consumer Cancellation Notification æœºåˆ¶ç”¨äºä»€ä¹ˆåœºæ™¯ï¼Ÿ**

ç”¨äºä¿è¯å½“é•œåƒ queue ä¸­ `master æŒ‚æ‰`æ—¶ï¼Œè¿æ¥åˆ° slave ä¸Šçš„ consumer å¯ä»¥**æ”¶åˆ°è‡ªèº« consume è¢«å–æ¶ˆçš„é€šçŸ¥**ï¼Œè¿›è€Œå¯ä»¥é‡æ–°æ‰§è¡Œ consume åŠ¨ä½œä»æ–°é€‰å‡ºçš„ master å‡ºè·å¾—æ¶ˆæ¯ã€‚

è‹¥ä¸é‡‡ç”¨è¯¥æœºåˆ¶ï¼Œè¿æ¥åˆ° slave ä¸Šçš„ consumer å°†ä¸ä¼šæ„ŸçŸ¥ master æŒ‚æ‰è¿™ä¸ªäº‹æƒ…ï¼Œå¯¼è‡´åç»­æ— æ³•å†æ”¶åˆ°æ–° master å¹¿æ’­å‡ºæ¥çš„ message ã€‚

å¦å¤–ï¼Œå› ä¸ºåœ¨**é•œåƒ queue æ¨¡å¼**ä¸‹ï¼Œå­˜åœ¨å°† message è¿›è¡Œ requeue çš„å¯èƒ½ï¼Œæ‰€ä»¥å®ç° consumer çš„é€»è¾‘æ—¶éœ€è¦èƒ½å¤Ÿæ­£ç¡®å¤„ç†å‡ºç°é‡å¤ message çš„æƒ…å†µã€‚

ğŸ¦… **èƒ½å¤Ÿåœ¨åœ°ç†ä¸Šåˆ†å¼€çš„ä¸åŒæ•°æ®ä¸­å¿ƒä½¿ç”¨ RabbitMQ cluster ä¹ˆï¼Ÿ**

ä¸èƒ½ã€‚

- ç¬¬ä¸€ï¼Œä½ **æ— æ³•æ§åˆ¶æ‰€åˆ›å»ºçš„ queue å®é™…åˆ†å¸ƒåœ¨ cluster é‡Œçš„å“ªä¸ª node ä¸Š**ï¼ˆä¸€èˆ¬ä½¿ç”¨ HAProxy + cluster æ¨¡å‹æ—¶éƒ½æ˜¯è¿™æ ·ï¼‰ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å„ç§è·¨åœ°åŸŸè®¿é—®æ—¶çš„å¸¸è§é—®é¢˜ã€‚
- ç¬¬äºŒï¼ŒErlang çš„ OTP é€šä¿¡æ¡†æ¶å¯¹**å»¶è¿Ÿçš„å®¹å¿åº¦æœ‰é™**ï¼Œè¿™å¯èƒ½ä¼š**è§¦å‘å„ç§è¶…æ—¶**ï¼Œå¯¼è‡´ä¸šåŠ¡ç–²äºå¤„ç†ã€‚
- ç¬¬ä¸‰ï¼Œåœ¨å¹¿åŸŸç½‘ä¸Šçš„**è¿æ¥å¤±æ•ˆé—®é¢˜å°†å¯¼è‡´ç»å…¸çš„â€œè„‘è£‚â€é—®é¢˜**ï¼Œè€Œ RabbitMQ ç›®å‰æ— æ³•å¤„ç†ã€‚ï¼ˆè¯¥é—®é¢˜ä¸»è¦æ˜¯è¯´ Mnesiaï¼‰

## å¦‚ä½•ç¡®ä¿æ¶ˆæ¯æ­£ç¡®åœ°å‘é€è‡³ RabbitMQï¼Ÿ

RabbitMQ ä½¿ç”¨**å‘é€æ–¹ç¡®è®¤æ¨¡å¼**ï¼Œç¡®ä¿æ¶ˆæ¯æ­£ç¡®åœ°å‘é€åˆ° RabbitMQã€‚

- å‘é€æ–¹ç¡®è®¤æ¨¡å¼ï¼šå°†**ä¿¡é“è®¾ç½®æˆ confirmï¼ˆç¡®è®¤ï¼‰ æ¨¡å¼ï¼ˆå‘é€æ–¹ç¡®è®¤æ¨¡å¼ï¼‰**ï¼Œåˆ™æ‰€æœ‰åœ¨ä¿¡é“ä¸Šå‘å¸ƒçš„æ¶ˆæ¯éƒ½ä¼šè¢«æŒ‡æ´¾ä¸€ä¸ªå”¯ä¸€çš„ ID ã€‚ä¸€æ—¦æ¶ˆæ¯è¢«æŠ•é€’åˆ°ç›®çš„é˜Ÿåˆ—åï¼Œæˆ–è€…æ¶ˆæ¯è¢«å†™å…¥ç£ç›˜åï¼ˆå¯æŒä¹…åŒ–çš„æ¶ˆæ¯ï¼‰ï¼Œä¿¡é“ä¼šå‘é€ä¸€ä¸ªç¡®è®¤ç»™ç”Ÿäº§è€…ï¼ˆåŒ…å«æ¶ˆæ¯å”¯ä¸€IDï¼‰ã€‚å¦‚æœ RabbitMQ å‘ç”Ÿå†…éƒ¨é”™è¯¯ä»è€Œå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œä¼šå‘é€ä¸€æ¡ nackï¼ˆnot acknowledgedï¼Œæœªç¡®è®¤ï¼‰æ¶ˆæ¯ã€‚
- å‘é€æ–¹ç¡®è®¤æ¨¡å¼æ˜¯**å¼‚æ­¥çš„**ï¼Œç”Ÿäº§è€…åº”ç”¨ç¨‹åºåœ¨ç­‰å¾…ç¡®è®¤çš„åŒæ—¶ï¼Œå¯ä»¥ç»§ç»­å‘é€æ¶ˆæ¯ã€‚å½“ç¡®è®¤æ¶ˆæ¯åˆ°è¾¾ç”Ÿäº§è€…åº”ç”¨ç¨‹åºï¼Œç”Ÿäº§è€…åº”ç”¨ç¨‹åºçš„å›è°ƒæ–¹æ³•å°±ä¼šè¢«è§¦å‘æ¥å¤„ç†ç¡®è®¤æ¶ˆæ¯ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ14. ç”Ÿäº§è€…çš„å‘é€ç¡®è®¤ã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚

ğŸ¦… **å‘ä¸å­˜åœ¨çš„ exchange å‘ publish æ¶ˆæ¯ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå‘ä¸å­˜åœ¨çš„ queue æ‰§è¡Œ consume åŠ¨ä½œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ**

éƒ½ä¼šæ”¶åˆ° `Channel.Close` ä¿¡ä»¤å‘Šä¹‹ä¸å­˜åœ¨ï¼ˆå†…å«åŸå›  404 NOT_FOUNDï¼‰ã€‚

ğŸ¦… **ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºç° blackholed é—®é¢˜ï¼Ÿ**

> blackholed ï¼Œå¯¹åº”ä¸­æ–‡ä¸ºâ€œé»‘æ´â€ã€‚

blackholed é—®é¢˜æ˜¯æŒ‡ï¼Œ**å‘ exchange æŠ•é€’äº† message ï¼Œè€Œç”±äºå„ç§åŸå› å¯¼è‡´è¯¥ message ä¸¢å¤±ï¼Œä½†å‘é€è€…å´ä¸çŸ¥é“**ã€‚å¯å¯¼è‡´ blackholed çš„æƒ…å†µï¼š

- 1ã€å‘æœªç»‘å®š queue çš„ exchange å‘é€ message ã€‚
- 2ã€exchange ä»¥ binding_key key_A ç»‘å®šäº† queue queue_Aï¼Œä½†å‘è¯¥ exchange å‘é€ message ä½¿ç”¨çš„ routing_key å´æ˜¯ key_B ã€‚

ğŸ¦… **å¦‚ä½•é˜²æ­¢å‡ºç° blackholed é—®é¢˜ï¼Ÿ**

æ²¡æœ‰ç‰¹åˆ«å¥½çš„åŠæ³•ï¼Œåªèƒ½åœ¨å…·ä½“å®è·µä¸­é€šè¿‡å„ç§æ–¹å¼ä¿è¯ç›¸å…³ fabric çš„å­˜åœ¨ã€‚å¦å¤–ï¼Œå¦‚æœåœ¨æ‰§è¡Œ `Basic.Publish` æ—¶è®¾ç½® `mandatory=true` ï¼Œåˆ™åœ¨é‡åˆ°å¯èƒ½å‡ºç° blackholed æƒ…å†µæ—¶ï¼ŒæœåŠ¡å™¨ä¼šé€šè¿‡è¿”å› `Basic.Return` å‘Šä¹‹å½“å‰ message æ— æ³•è¢«æ­£ç¡®æŠ•é€’ï¼ˆå†…å«åŸå›  312 NO_ROUTEï¼‰ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ14.3 ReturnCallbackã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚

ğŸ¦… **routing_key å’Œ binding_key çš„æœ€å¤§é•¿åº¦æ˜¯å¤šå°‘ï¼Ÿ**

**255 å­—èŠ‚ã€‚**

ğŸ¦… **æ¶ˆæ¯æ€ä¹ˆè·¯ç”±ï¼Ÿ**

ä»æ¦‚å¿µä¸Šæ¥è¯´ï¼Œæ¶ˆæ¯è·¯ç”±å¿…é¡»æœ‰ä¸‰éƒ¨åˆ†ï¼šäº¤æ¢å™¨ã€è·¯ç”±ã€ç»‘å®šã€‚

- ç”Ÿäº§è€…æŠŠæ¶ˆæ¯å‘å¸ƒåˆ°**äº¤æ¢å™¨**ä¸Šï¼›

- **ç»‘å®š**å†³å®šäº†æ¶ˆæ¯å¦‚ä½•ä»è·¯ç”±å™¨è·¯ç”±åˆ°ç‰¹å®šçš„é˜Ÿåˆ—ï¼›

  > å¦‚æœä¸€ä¸ªè·¯ç”±ç»‘å®šäº†ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œé‚£ä¹ˆå‘é€ç»™è¯¥è·¯ç”±æ—¶ï¼Œè¿™ä¸¤ä¸ªé˜Ÿåˆ—éƒ½ä¼šå¢åŠ ä¸€æ¡æ¶ˆæ¯ã€‚

- æ¶ˆæ¯æœ€ç»ˆåˆ°è¾¾**é˜Ÿåˆ—**ï¼Œå¹¶è¢«æ¶ˆè´¹è€…æ¥æ”¶ã€‚

è¯¦ç»†æ¥è¯´ï¼Œå°±æ˜¯ï¼š

- æ¶ˆæ¯å‘å¸ƒåˆ°äº¤æ¢å™¨æ—¶ï¼Œæ¶ˆæ¯å°†æ‹¥æœ‰ä¸€ä¸ªè·¯ç”±é”®ï¼ˆrouting keyï¼‰ï¼Œåœ¨æ¶ˆæ¯åˆ›å»ºæ—¶è®¾å®šã€‚
- é€šè¿‡é˜Ÿåˆ—è·¯ç”±é”®ï¼Œå¯ä»¥æŠŠé˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢å™¨ä¸Šã€‚
- æ¶ˆæ¯åˆ°è¾¾äº¤æ¢å™¨åï¼ŒRabbitMQ ä¼šå°†æ¶ˆæ¯çš„è·¯ç”±é”®ä¸é˜Ÿåˆ—çš„è·¯ç”±é”®è¿›è¡ŒåŒ¹é…ï¼ˆé’ˆå¯¹ä¸åŒçš„äº¤æ¢å™¨æœ‰ä¸åŒçš„è·¯ç”±è§„åˆ™ï¼‰ã€‚å¦‚æœèƒ½å¤ŸåŒ¹é…åˆ°é˜Ÿåˆ—ï¼Œåˆ™æ¶ˆæ¯ä¼šæŠ•é€’åˆ°ç›¸åº”é˜Ÿåˆ—ä¸­ï¼›å¦‚æœä¸èƒ½åŒ¹é…åˆ°ä»»ä½•é˜Ÿåˆ—ï¼Œæ¶ˆæ¯å°†è¿›å…¥ â€œé»‘æ´â€ã€‚

å¸¸ç”¨çš„**äº¤æ¢å™¨**ä¸»è¦åˆ†ä¸ºä¸€ä¸‹ä¸‰ç§ï¼š

- directï¼šå¦‚æœè·¯ç”±é”®**å®Œå…¨åŒ¹é…**ï¼Œæ¶ˆæ¯å°±è¢«æŠ•é€’åˆ°ç›¸åº”çš„é˜Ÿåˆ—ã€‚
- fanoutï¼šå¦‚æœäº¤æ¢å™¨æ”¶åˆ°æ¶ˆæ¯ï¼Œå°†ä¼š**å¹¿æ’­**åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—ä¸Šã€‚
- topicï¼šå¯ä»¥ä½¿æ¥è‡ªä¸åŒæºå¤´çš„æ¶ˆæ¯èƒ½å¤Ÿåˆ°è¾¾åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚ ä½¿ç”¨ topic äº¤æ¢å™¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨é€šé…ç¬¦ï¼Œæ¯”å¦‚ï¼š`â€œ*â€` åŒ¹é…ç‰¹å®šä½ç½®çš„ä»»æ„æ–‡æœ¬ï¼Œ `â€œ.â€` æŠŠè·¯ç”±é”®åˆ†ä¸ºäº†å‡ éƒ¨åˆ†ï¼Œ`â€œ#â€` åŒ¹é…æ‰€æœ‰è§„åˆ™ç­‰ã€‚ç‰¹åˆ«æ³¨æ„ï¼šå‘å¾€ topic äº¤æ¢å™¨çš„æ¶ˆæ¯ä¸èƒ½éšæ„çš„è®¾ç½®é€‰æ‹©é”®ï¼ˆrouting_keyï¼‰ï¼Œå¿…é¡»æ˜¯ç”± `"."` éš”å¼€çš„ä¸€ç³»åˆ—çš„æ ‡è¯†ç¬¦ç»„æˆã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ3. å¿«é€Ÿå…¥é—¨ã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚

## å¦‚ä½•ç¡®ä¿æ¶ˆæ¯æ¥æ”¶æ–¹æ¶ˆè´¹äº†æ¶ˆæ¯ï¼Ÿ

RabbitMQ ä½¿ç”¨**æ¥æ”¶æ–¹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶**ï¼Œç¡®ä¿æ¶ˆæ¯æ¥æ”¶æ–¹æ¶ˆè´¹äº†æ¶ˆæ¯ã€‚

- æ¥æ”¶æ–¹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼šæ¶ˆè´¹è€…æ¥æ”¶æ¯ä¸€æ¡æ¶ˆæ¯åéƒ½å¿…é¡»è¿›è¡Œç¡®è®¤ï¼ˆæ¶ˆæ¯æ¥æ”¶å’Œæ¶ˆæ¯ç¡®è®¤æ˜¯ä¸¤ä¸ªä¸åŒæ“ä½œï¼‰ã€‚åªæœ‰æ¶ˆè´¹è€…ç¡®è®¤äº†æ¶ˆæ¯ï¼ŒRabbitMQ æ‰èƒ½å®‰å…¨åœ°æŠŠæ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚

è¿™é‡Œå¹¶æ²¡æœ‰ç”¨åˆ°è¶…æ—¶æœºåˆ¶ï¼ŒRabbitMQ ä»…é€šè¿‡ Consumer çš„è¿æ¥ä¸­æ–­æ¥ç¡®è®¤æ˜¯å¦éœ€è¦é‡æ–°å‘é€æ¶ˆæ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦è¿æ¥ä¸ä¸­æ–­ï¼ŒRabbitMQ ç»™äº† Consumer è¶³å¤Ÿé•¿çš„æ—¶é—´æ¥å¤„ç†æ¶ˆæ¯ã€‚

ä¸‹é¢ç½—åˆ—å‡ ç§ç‰¹æ®Šæƒ…å†µï¼š

- å¦‚æœæ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œåœ¨ç¡®è®¤ä¹‹å‰æ–­å¼€äº†è¿æ¥æˆ–å–æ¶ˆè®¢é˜…ï¼ŒRabbitMQ ä¼šè®¤ä¸ºæ¶ˆæ¯æ²¡æœ‰è¢«åˆ†å‘ï¼Œç„¶åé‡æ–°åˆ†å‘ç»™ä¸‹ä¸€ä¸ªè®¢é˜…çš„æ¶ˆè´¹è€…ã€‚ï¼ˆå¯èƒ½å­˜åœ¨æ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„éšæ‚£ï¼Œéœ€è¦æ ¹æ® bizId å»é‡ï¼‰
- å¦‚æœæ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯å´æ²¡æœ‰ç¡®è®¤æ¶ˆæ¯ï¼Œè¿æ¥ä¹Ÿæœªæ–­å¼€ï¼Œåˆ™ RabbitMQ è®¤ä¸ºè¯¥æ¶ˆè´¹è€…ç¹å¿™ï¼Œå°†ä¸ä¼šç»™è¯¥æ¶ˆè´¹è€…åˆ†å‘æ›´å¤šçš„æ¶ˆæ¯ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ13. æ¶ˆè´¹è€…çš„æ¶ˆæ¯ç¡®è®¤ã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚ã€‚

ğŸ¦… **å¦‚ä½•é¿å…æ¶ˆæ¯é‡å¤æŠ•é€’æˆ–é‡å¤æ¶ˆè´¹ï¼Ÿ**

åœ¨**æ¶ˆæ¯ç”Ÿäº§æ—¶**ï¼Œ**MQ å†…éƒ¨é’ˆå¯¹æ¯æ¡ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ç”Ÿæˆä¸€ä¸ª inner-msg-id** ï¼Œä½œä¸ºå»é‡å’Œå¹‚ç­‰çš„ä¾æ®ï¼ˆæ¶ˆæ¯æŠ•é€’å¤±è´¥å¹¶é‡ä¼ ï¼‰ï¼Œ**é¿å…é‡å¤çš„æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—**

åœ¨**æ¶ˆæ¯æ¶ˆè´¹æ—¶**ï¼Œè¦æ±‚æ¶ˆæ¯ä½“ä¸­å¿…é¡»è¦**æœ‰ä¸€ä¸ª bizId**ï¼ˆå¯¹äºåŒä¸€ä¸šåŠ¡å…¨å±€å”¯ä¸€ï¼Œå¦‚æ”¯ä»˜ IDã€è®¢å• IDã€å¸–å­ ID ç­‰ï¼‰ä½œä¸º**å»é‡å’Œå¹‚ç­‰**çš„ä¾æ®ï¼Œé¿å…åŒä¸€æ¡æ¶ˆæ¯è¢«é‡å¤æ¶ˆè´¹ã€‚

ğŸ¦… **æ¶ˆæ¯å¦‚ä½•åˆ†å‘ï¼Ÿ**

è‹¥è¯¥é˜Ÿåˆ—è‡³å°‘æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…è®¢é˜…ï¼Œæ¶ˆæ¯å°†ä»¥å¾ªç¯ï¼ˆround-robinï¼‰çš„æ–¹å¼å‘é€ç»™æ¶ˆè´¹è€…ã€‚æ¯æ¡æ¶ˆæ¯åªä¼šåˆ†å‘ç»™ä¸€ä¸ªè®¢é˜…çš„æ¶ˆè´¹è€…ï¼ˆå‰ææ˜¯æ¶ˆè´¹è€…èƒ½å¤Ÿæ­£å¸¸å¤„ç†æ¶ˆæ¯å¹¶è¿›è¡Œç¡®è®¤ï¼‰ã€‚

ğŸ¦… **RabbitMQ æœ‰å‡ ç§æ¶ˆè´¹æ¨¡å¼ï¼Ÿ**

RabbitMQ æœ‰ pull å’Œ push ä¸¤ç§æ¶ˆè´¹æ¨¡å¼ã€‚å…·ä½“çš„ä½¿ç”¨ï¼Œå¯å‚è§ [ã€ŠRabbitMQ ä¹‹ Consumer æ¶ˆè´¹æ¨¡å¼ï¼ˆPush & Pullï¼‰ã€‹](https://blog.csdn.net/u013256816/article/details/62890189) æ–‡ç« ã€‚

## ä¸ºä»€ä¹ˆä¸åº”è¯¥å¯¹æ‰€æœ‰çš„ message éƒ½ä½¿ç”¨æŒä¹…åŒ–æœºåˆ¶ï¼Ÿ

é¦–å…ˆï¼Œå¿…ç„¶å¯¼è‡´æ€§èƒ½çš„ä¸‹é™ï¼Œå› ä¸ºå†™ç£ç›˜æ¯”å†™ RAM æ…¢çš„å¤šï¼Œmessage çš„ååé‡å¯èƒ½æœ‰ 10 å€çš„å·®è·ã€‚

å…¶æ¬¡ï¼Œmessage çš„æŒä¹…åŒ–æœºåˆ¶ç”¨åœ¨ RabbitMQ çš„å†…ç½® Cluster æ–¹æ¡ˆæ—¶ä¼šå‡ºç°â€œå‘çˆ¹â€é—®é¢˜ã€‚çŸ›ç›¾ç‚¹åœ¨äºï¼š

- è‹¥ message è®¾ç½®äº† persistent å±æ€§ï¼Œä½† queue æœªè®¾ç½® durable å±æ€§ï¼Œé‚£ä¹ˆå½“è¯¥ queue çš„ owner node å‡ºç°å¼‚å¸¸åï¼Œåœ¨æœªé‡å»ºè¯¥ queue å‰ï¼Œå‘å¾€è¯¥ queue çš„ message å°†è¢« blackholed ã€‚
- è‹¥ message è®¾ç½®äº† persistent å±æ€§ï¼ŒåŒæ—¶ queue ä¹Ÿè®¾ç½®äº† durable å±æ€§ï¼Œé‚£ä¹ˆå½“ queue çš„ owner node å¼‚å¸¸ä¸”æ— æ³•é‡å¯çš„æƒ…å†µä¸‹ï¼Œåˆ™è¯¥ queue æ— æ³•åœ¨å…¶ä»– node ä¸Šé‡å»ºï¼Œåªèƒ½ç­‰å¾…å…¶ owner node é‡å¯åï¼Œæ‰èƒ½æ¢å¤è¯¥ queue çš„ä½¿ç”¨ï¼Œè€Œåœ¨è¿™æ®µæ—¶é—´å†…å‘é€ç»™è¯¥ queue çš„ message å°†è¢« blackholed ã€‚

æ‰€ä»¥ï¼Œæ˜¯å¦è¦å¯¹ message è¿›è¡ŒæŒä¹…åŒ–ï¼Œéœ€è¦ç»¼åˆè€ƒè™‘æ€§èƒ½éœ€è¦ï¼Œä»¥åŠå¯èƒ½é‡åˆ°çš„é—®é¢˜ã€‚è‹¥æƒ³è¾¾åˆ° 100,000 æ¡/ç§’ä»¥ä¸Šçš„æ¶ˆæ¯ååé‡ï¼ˆå• RabbitMQ æœåŠ¡å™¨ï¼‰ï¼Œåˆ™è¦ä¹ˆä½¿ç”¨å…¶ä»–çš„æ–¹å¼æ¥ç¡®ä¿ message çš„å¯é  delivery ï¼Œè¦ä¹ˆä½¿ç”¨éå¸¸å¿«é€Ÿçš„å­˜å‚¨ç³»ç»Ÿä»¥æ”¯æŒå…¨æŒä¹…åŒ–ï¼ˆä¾‹å¦‚ä½¿ç”¨ SSDï¼‰ã€‚å¦å¤–ä¸€ç§å¤„ç†åŸåˆ™æ˜¯ï¼šä»…å¯¹å…³é”®æ¶ˆæ¯ä½œæŒä¹…åŒ–å¤„ç†ï¼ˆæ ¹æ®ä¸šåŠ¡é‡è¦ç¨‹åº¦ï¼‰ï¼Œä¸”åº”è¯¥ä¿è¯å…³é”®æ¶ˆæ¯çš„é‡ä¸ä¼šå¯¼è‡´æ€§èƒ½ç“¶é¢ˆã€‚

ğŸ¦… **RabbitMQ å…è®¸å‘é€çš„ message æœ€å¤§å¯è¾¾å¤šå¤§ï¼Ÿ**

æ ¹æ® AMQP åè®®è§„å®šï¼Œæ¶ˆæ¯ä½“çš„å¤§å°ç”± 64-bit çš„å€¼æ¥æŒ‡å®šï¼Œæ‰€ä»¥ä½ å°±å¯ä»¥çŸ¥é“åˆ°åº•èƒ½å‘å¤šå¤§çš„æ•°æ®äº†ã€‚

ğŸ¦… **ä¸ºä»€ä¹ˆè¯´ä¿è¯ message è¢«å¯é æŒä¹…åŒ–çš„æ¡ä»¶æ˜¯ queue å’Œ exchange å…·æœ‰ durable å±æ€§ï¼ŒåŒæ—¶ message å…·æœ‰ persistent å±æ€§æ‰è¡Œï¼Ÿ**

binding å…³ç³»å¯ä»¥è¡¨ç¤ºä¸º exchangeâ€“bindingâ€“queue ã€‚ä»æ–‡æ¡£ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œè‹¥è¦æ±‚æŠ•é€’çš„ message èƒ½å¤Ÿä¸ä¸¢å¤±ï¼Œè¦æ±‚ message æœ¬èº«è®¾ç½® persistent å±æ€§ï¼ŒåŒæ—¶è¦æ±‚ exchange å’Œ queue éƒ½è®¾ç½® durable å±æ€§ã€‚

- å…¶å®è¿™é—®é¢˜å¯ä»¥è¿™ä¹ˆæƒ³ï¼Œè‹¥ exchange æˆ– queue æœªè®¾ç½® durable å±æ€§ï¼Œåˆ™åœ¨å…¶ crash ä¹‹åå°±ä¼šæ— æ³•æ¢å¤ï¼Œé‚£ä¹ˆå³ä½¿ message è®¾ç½®äº† persistent å±æ€§ï¼Œä»ç„¶å­˜åœ¨ message è™½ç„¶èƒ½æ¢å¤ä½†å´æ— å¤„å®¹èº«çš„é—®é¢˜ã€‚
- åŒç†ï¼Œè‹¥ message æœ¬èº«æœªè®¾ç½® persistent å±æ€§ï¼Œåˆ™ message çš„æŒä¹…åŒ–æ›´æ— ä»è°ˆèµ·ã€‚

ğŸ¦… **å¦‚ä½•ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ**

æ¶ˆæ¯æŒä¹…åŒ–çš„å‰ææ˜¯ï¼šå°†äº¤æ¢å™¨/é˜Ÿåˆ—çš„ durable å±æ€§è®¾ç½®ä¸º true ï¼Œè¡¨ç¤ºäº¤æ¢å™¨/é˜Ÿåˆ—æ˜¯æŒä¹…äº¤æ¢å™¨/é˜Ÿåˆ—ï¼Œåœ¨æœåŠ¡å™¨å´©æºƒæˆ–é‡å¯ä¹‹åä¸éœ€è¦é‡æ–°åˆ›å»ºäº¤æ¢å™¨/é˜Ÿåˆ—ï¼ˆäº¤æ¢å™¨/é˜Ÿåˆ—ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰ã€‚

å¦‚æœæ¶ˆæ¯æƒ³è¦ä» RabbitMQ å´©æºƒä¸­æ¢å¤ï¼Œé‚£ä¹ˆæ¶ˆæ¯å¿…é¡»ï¼š

- åœ¨æ¶ˆæ¯å‘å¸ƒå‰ï¼Œé€šè¿‡æŠŠå®ƒçš„ â€œæŠ•é€’æ¨¡å¼â€ é€‰é¡¹è®¾ç½®ä¸º2ï¼ˆæŒä¹…ï¼‰æ¥æŠŠæ¶ˆæ¯æ ‡è®°æˆæŒä¹…åŒ–
- å°†æ¶ˆæ¯å‘é€åˆ°æŒä¹…äº¤æ¢å™¨
- æ¶ˆæ¯åˆ°è¾¾æŒä¹…é˜Ÿåˆ—

RabbitMQ ç¡®ä¿æŒä¹…æ€§æ¶ˆæ¯èƒ½ä»æœåŠ¡å™¨é‡å¯ä¸­æ¢å¤çš„æ–¹å¼æ˜¯ï¼Œå°†å®ƒä»¬å†™å…¥ç£ç›˜ä¸Šçš„ä¸€ä¸ªæŒä¹…åŒ–æ—¥å¿—æ–‡ä»¶ã€‚

- å½“å‘å¸ƒä¸€æ¡æŒä¹…æ€§æ¶ˆæ¯åˆ°æŒä¹…äº¤æ¢å™¨ä¸Šæ—¶ï¼ŒRabbitMQ ä¼šåœ¨æ¶ˆæ¯æäº¤åˆ°æ—¥å¿—æ–‡ä»¶åæ‰å‘é€å“åº”ï¼ˆå¦‚æœæ¶ˆæ¯è·¯ç”±åˆ°äº†éæŒä¹…é˜Ÿåˆ—ï¼Œå®ƒä¼šè‡ªåŠ¨ä»æŒä¹…åŒ–æ—¥å¿—ä¸­ç§»é™¤ï¼‰ã€‚
- ä¸€æ—¦æ¶ˆè´¹è€…ä»æŒä¹…é˜Ÿåˆ—ä¸­æ¶ˆè´¹äº†ä¸€æ¡æŒä¹…åŒ–æ¶ˆæ¯ï¼ŒRabbitMQ ä¼šåœ¨æŒä¹…åŒ–æ—¥å¿—ä¸­æŠŠè¿™æ¡æ¶ˆæ¯æ ‡è®°ä¸ºç­‰å¾…åƒåœ¾æ”¶é›†ã€‚å¦‚æœæŒä¹…åŒ–æ¶ˆæ¯åœ¨è¢«æ¶ˆè´¹ä¹‹å‰ RabbitMQ é‡å¯ï¼Œé‚£ä¹ˆ RabbitMQ ä¼šè‡ªåŠ¨é‡å»ºäº¤æ¢å™¨å’Œé˜Ÿåˆ—ï¼ˆä»¥åŠç»‘å®šï¼‰ï¼Œå¹¶é‡æ’­æŒä¹…åŒ–æ—¥å¿—æ–‡ä»¶ä¸­çš„æ¶ˆæ¯åˆ°åˆé€‚çš„é˜Ÿåˆ—æˆ–è€…äº¤æ¢å™¨ä¸Šã€‚

## ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—ï¼Ÿ

DLXï¼ŒDead-Letter-Exchangeã€‚åˆ©ç”¨ DLX ï¼Œå½“æ¶ˆæ¯åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­å˜æˆæ­»ä¿¡ï¼ˆdead messageï¼‰ä¹‹åï¼Œå®ƒèƒ½è¢«é‡æ–° publish åˆ°å¦ä¸€ä¸ª Exchange ï¼Œè¿™ä¸ª Exchange å°±æ˜¯DLXã€‚æ¶ˆæ¯å˜æˆæ­»ä¿¡ä¸€å‘æœ‰ä¸€ä¸‹å‡ ç§æƒ…å†µï¼š

- æ¶ˆæ¯è¢«æ‹’ç»ï¼ˆbasic.reject / basic.nackï¼‰å¹¶ä¸” `requeue=false` ã€‚
- æ¶ˆæ¯ TTL è¿‡æœŸï¼ˆå‚è€ƒï¼šRabbitMQä¹‹TTLï¼ˆTime-To-Live è¿‡æœŸæ—¶é—´ï¼‰ï¼‰ã€‚
- é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦ã€‚

è¯¦ç»†çš„ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠRabbitMQ ä¹‹æ­»ä¿¡é˜Ÿåˆ—ã€‹](http://www.iocoder.cn/RabbitMQ/dead-letter-queue/?vip) æ–‡ç« ã€‚

ğŸ¦… **â€œdead letterâ€queue çš„ç”¨é€”ï¼Ÿ**

å½“æ¶ˆæ¯è¢« RabbitMQ server æŠ•é€’åˆ° consumer åï¼Œä½† consumer å´é€šè¿‡ `Basic.Reject` è¿›è¡Œäº†æ‹’ç»æ—¶ï¼ˆåŒæ—¶è®¾ç½® `requeue=false`ï¼‰ï¼Œé‚£ä¹ˆè¯¥æ¶ˆæ¯ä¼šè¢«æ”¾å…¥ â€œdead letterâ€ queue ä¸­ã€‚è¯¥ queue å¯ç”¨äºæ’æŸ¥ message è¢« reject æˆ– undeliver çš„åŸå› ã€‚

ğŸ¦… **`Basic.Reject` çš„ç”¨æ³•æ˜¯ä»€ä¹ˆï¼Ÿ**

è¯¥ä¿¡ä»¤å¯ç”¨äº consumer å¯¹æ”¶åˆ°çš„ message è¿›è¡Œ reject ã€‚

- è‹¥åœ¨è¯¥ä¿¡ä»¤ä¸­è®¾ç½® `requeue=true` ï¼Œåˆ™å½“ RabbitMQ server æ”¶åˆ°è¯¥æ‹’ç»ä¿¡ä»¤åï¼Œä¼šå°†è¯¥ message é‡æ–°å‘é€åˆ°ä¸‹ä¸€ä¸ªå¤„äº consume çŠ¶æ€çš„ consumer å¤„ï¼ˆç†è®ºä¸Šä»å¯èƒ½å°†è¯¥æ¶ˆæ¯å‘é€ç»™å½“å‰ consumerï¼‰ã€‚
- è‹¥è®¾ç½® `requeue=false` ï¼Œåˆ™ RabbitMQ server åœ¨æ”¶åˆ°æ‹’ç»ä¿¡ä»¤åï¼Œå°†ç›´æ¥å°†è¯¥ message ä» queue ä¸­ç§»é™¤ã€‚

å¦å¤–ä¸€ç§ç§»é™¤ queue ä¸­ message çš„å°æŠ€å·§æ˜¯ï¼Œconsumer å›å¤ `Basic.Ack` ä½†ä¸å¯¹è·å–åˆ°çš„ message åšä»»ä½•å¤„ç†ã€‚è€Œ `Basic.Nack`æ˜¯å¯¹ Basic.Reject çš„æ‰©å±•ï¼Œä»¥æ”¯æŒä¸€æ¬¡æ‹’ç»å¤šæ¡ message çš„èƒ½åŠ›ã€‚

## RabbitMQ ä¸­çš„ clusterã€mirrored queueï¼Œä»¥åŠ warrens æœºåˆ¶åˆ†åˆ«ç”¨äºè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

ğŸ¦… **1ï¼‰cluster**

- cluster æ˜¯ä¸ºäº†è§£å†³å½“ cluster ä¸­çš„ä»»æ„ node å¤±æ•ˆåï¼Œproducer å’Œ consumer å‡å¯ä»¥é€šè¿‡å…¶ä»– node ç»§ç»­å·¥ä½œï¼Œå³æé«˜äº†å¯ç”¨æ€§ï¼›å¦å¤–å¯ä»¥é€šè¿‡å¢åŠ  node æ•°é‡å¢åŠ  cluster çš„æ¶ˆæ¯ååé‡çš„ç›®çš„ã€‚
- cluster æœ¬èº«ä¸è´Ÿè´£ message çš„å¯é æ€§é—®é¢˜ï¼ˆè¯¥é—®é¢˜ç”± producer é€šè¿‡å„ç§æœºåˆ¶è‡ªè¡Œè§£å†³ï¼‰ï¼›cluster æ— æ³•è§£å†³è·¨æ•°æ®ä¸­å¿ƒçš„é—®é¢˜ï¼ˆå³è„‘è£‚é—®é¢˜ï¼‰ã€‚
- å¦å¤–ï¼Œåœ¨cluster å‰ä½¿ç”¨ HAProxy å¯ä»¥è§£å†³ node çš„é€‰æ‹©é—®é¢˜ï¼Œå³ä¸šåŠ¡æ— éœ€çŸ¥é“ cluster ä¸­å¤šä¸ª node çš„ ip åœ°å€ã€‚å¯ä»¥åˆ©ç”¨ HAProxy è¿›è¡Œå¤±æ•ˆ node çš„æ¢æµ‹ï¼Œå¯ä»¥ä½œè´Ÿè½½å‡è¡¡ã€‚ä¸‹å›¾ä¸º HAProxy + cluster çš„æ¨¡å‹ï¼š[HAProxy + cluster çš„æ¨¡å‹](https://img-blog.csdnimg.cn/20181219191433895)

ğŸ¦… **2ï¼‰Mirrored queue**

- Mirrored queue æ˜¯ä¸ºäº†è§£å†³ä½¿ç”¨ cluster æ—¶æ‰€åˆ›å»ºçš„ queue çš„å®Œæ•´ä¿¡æ¯ä»…å­˜åœ¨äºå•ä¸€ node ä¸Šçš„é—®é¢˜ï¼Œä»å¦ä¸€ä¸ªè§’åº¦å¢åŠ å¯ç”¨æ€§ã€‚
- è‹¥æƒ³æ­£ç¡®ä½¿ç”¨è¯¥åŠŸèƒ½ï¼Œéœ€è¦ä¿è¯ï¼š1ï¼‰consumer éœ€è¦æ”¯æŒ Consumer Cancellation Notification æœºåˆ¶ï¼›2ï¼‰consumer å¿…é¡»èƒ½å¤Ÿæ­£ç¡®å¤„ç†é‡å¤ message ã€‚

ğŸ¦… **3ï¼‰Warrens**

Warrens æ˜¯ä¸ºäº†è§£å†³ cluster ä¸­ message å¯èƒ½è¢« blackholed çš„é—®é¢˜ï¼Œå³ä¸èƒ½æ¥å— producer ä¸åœ republish message ä½† RabbitMQ server æ— å›åº”çš„æƒ…å†µã€‚

Warrens æœ‰ä¸¤ç§æ„æˆæ–¹å¼ï¼š

- ä¸€ç§æ¨¡å‹ï¼Œæ˜¯ä¸¤å°ç‹¬ç«‹çš„ RabbitMQ server + HAProxy ï¼Œå…¶ä¸­ä¸¤ä¸ª server çš„çŠ¶æ€åˆ†åˆ«ä¸º active å’Œ hot-standby ã€‚è¯¥æ¨¡å‹çš„ç‰¹ç‚¹ä¸ºï¼šä¸¤å° server ä¹‹é—´æ— ä»»ä½•æ•°æ®å…±äº«å’Œåè®®äº¤äº’ï¼Œä¸¤å° server å¯ä»¥åŸºäºä¸åŒçš„ RabbitMQ ç‰ˆæœ¬ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[æ¨¡å‹ä¸€](https://img-blog.csdnimg.cn/20181219191433914)
- å¦ä¸€ç§æ¨¡å‹ï¼Œä¸ºä¸¤å°å…±äº«å­˜å‚¨çš„ RabbitMQ server + keepalived ï¼Œå…¶ä¸­ä¸¤ä¸ª server çš„çŠ¶æ€åˆ†åˆ«ä¸º active å’Œ cold-standby ã€‚è¯¥æ¨¡å‹çš„ç‰¹ç‚¹ä¸ºï¼šä¸¤å° server åŸºäºå…±äº«å­˜å‚¨å¯ä»¥åšåˆ°å®Œå…¨æ¢å¤ï¼Œè¦æ±‚å¿…é¡»åŸºäºå®Œå…¨ç›¸åŒçš„ RabbitMQ ç‰ˆæœ¬ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[æ¨¡å‹äºŒ](https://img-blog.csdnimg.cn/20181219191433931)

Warrens æ¨¡å‹å­˜åœ¨çš„é—®é¢˜ï¼š

- å¯¹äºç¬¬ä¸€ç§æ¨¡å‹ï¼Œè™½ç„¶ç†è®ºä¸Šè®²ä¸ä¼šä¸¢å¤±æ¶ˆæ¯ï¼Œä½†è‹¥åœ¨è¯¥æ¨¡å‹ä¸Šä½¿ç”¨æŒä¹…åŒ–æœºåˆ¶ï¼Œå°±ä¼šå‡ºç°è¿™æ ·ä¸€ç§æƒ…å†µï¼Œå³è‹¥ä½œä¸º active çš„ server å¼‚å¸¸åï¼ŒæŒä¹…åŒ–åœ¨è¯¥ server ä¸Šçš„æ¶ˆæ¯å°†æš‚æ—¶æ— æ³•è¢« consume ï¼Œå› ä¸ºæ­¤æ—¶è¯¥ queue å°†æ— æ³•åœ¨ä½œä¸º hot-standby çš„ server ä¸Šè¢«é‡å»ºï¼Œæ‰€ä»¥ï¼Œåªèƒ½ç­‰åˆ°å¼‚å¸¸çš„ active server æ¢å¤åï¼Œæ‰èƒ½ä»å…¶ä¸Šçš„ queue ä¸­è·å–ç›¸åº”çš„ message è¿›è¡Œå¤„ç†ã€‚è€Œå¯¹äºä¸šåŠ¡æ¥è¯´ï¼Œéœ€è¦å…·æœ‰ï¼ša.æ„ŸçŸ¥ AMQP è¿æ¥æ–­å¼€åé‡å»ºå„ç§ fabric çš„èƒ½åŠ›ï¼›b.æ„ŸçŸ¥ active server æ¢å¤çš„èƒ½åŠ›ï¼›c.åˆ‡æ¢å› active server çš„æ—¶æœºæ§åˆ¶ï¼Œä»¥åŠåˆ‡å›åï¼Œé’ˆå¯¹ message å…ˆåé¡ºåºäº§ç”Ÿçš„å˜åŒ–è¿›è¡Œå¤„ç†çš„èƒ½åŠ›ã€‚
- å¯¹äºç¬¬äºŒç§æ¨¡å‹ï¼Œå› ä¸ºæ˜¯åŸºäºå…±äº«å­˜å‚¨çš„æ¨¡å¼ï¼Œæ‰€ä»¥å¯¼è‡´ active server å¼‚å¸¸çš„æ¡ä»¶ï¼Œå¯èƒ½åŒæ ·ä¼šå¯¼è‡´ cold-standby server å¼‚å¸¸ï¼›å¦å¤–ï¼Œåœ¨è¯¥æ¨¡å‹ä¸‹ï¼Œè¦æ±‚ active å’Œ cold-standby çš„ server å¿…é¡»å…·æœ‰ç›¸åŒçš„ node åå’Œ UID ï¼Œå¦åˆ™å°†äº§ç”Ÿè®¿é—®æƒé™é—®é¢˜ï¼›æœ€åï¼Œç”±äºè¯¥æ¨¡å‹æ˜¯å†·å¤‡æ–¹æ¡ˆï¼Œæ•…æ— æ³•ä¿è¯ cold-standby server èƒ½åœ¨ä½ è¦æ±‚çš„æ—¶é™å†…æˆåŠŸå¯åŠ¨ã€‚

## RabbitMQ å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ

> è¿™ä¸ªé—®é¢˜ï¼Œå’Œ [ã€ŒRabbitMQ ä¸­çš„ clusterã€mirrored queueï¼Œä»¥åŠ warrens æœºåˆ¶åˆ†åˆ«ç”¨äºè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) ä¼šæ¯”è¾ƒç±»ä¼¼ã€‚

RabbitMQ çš„é«˜å¯ç”¨ï¼Œæ˜¯åŸºäº**ä¸»ä»**åšé«˜å¯ç”¨æ€§çš„ã€‚å®ƒæœ‰ä¸‰ç§æ¨¡å¼ï¼š

- å•æœºæ¨¡å¼
- æ™®é€šé›†ç¾¤æ¨¡å¼
- é•œåƒé›†ç¾¤æ¨¡å¼

ğŸ¦… **1ï¼‰å•æœºæ¨¡å¼**

å•æœºæ¨¡å¼ï¼Œå°±æ˜¯å¯åŠ¨å•ä¸ª RabbitMQ èŠ‚ç‚¹ï¼Œä¸€èˆ¬ç”¨äºæœ¬åœ°å¼€å‘æˆ–è€…æµ‹è¯•ç¯å¢ƒã€‚å®é™…ç”Ÿäº§ç¯å¢ƒä¸‹ï¼ŒåŸºæœ¬ä¸ä¼šä½¿ç”¨ã€‚

ğŸ¦… **æ™®é€šé›†ç¾¤æ¨¡å¼ï¼ˆæ— é«˜å¯ç”¨æ€§ï¼‰**

> è¿™ç§æ–¹å¼ï¼Œå°±æ˜¯ä¸Šé¢é—®é¢˜çš„ **cluster** ã€‚

æ™®é€šé›†ç¾¤æ¨¡å¼ï¼Œæ„æ€å°±æ˜¯åœ¨å¤šå°æœºå™¨ä¸Šå¯åŠ¨å¤šä¸ª RabbitMQ å®ä¾‹ï¼Œæ¯ä¸ªæœºå™¨å¯åŠ¨ä¸€ä¸ªã€‚

- ä½ **åˆ›å»ºçš„ queueï¼Œåªä¼šæ”¾åœ¨ä¸€ä¸ª RabbitMQ å®ä¾‹ä¸Š**ï¼Œä½†æ˜¯æ¯ä¸ªå®ä¾‹éƒ½åŒæ­¥ queue çš„å…ƒæ•°æ®ï¼ˆå…ƒæ•°æ®å¯ä»¥è®¤ä¸ºæ˜¯ queue çš„ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œé€šè¿‡å…ƒæ•°æ®ï¼Œå¯ä»¥æ‰¾åˆ° queue æ‰€åœ¨å®ä¾‹ï¼‰ã€‚
- ä½ æ¶ˆè´¹çš„æ—¶å€™ï¼Œå®é™…ä¸Šå¦‚æœè¿æ¥åˆ°äº†å¦å¤–ä¸€ä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆé‚£ä¸ªå®ä¾‹ä¼šä» queue æ‰€åœ¨å®ä¾‹ä¸Šæ‹‰å–æ•°æ®è¿‡æ¥ã€‚

[![æ¶æ„å›¾](http://static2.iocoder.cn/75d36ed17c91932e28b5eeba681ad8ec)](http://static2.iocoder.cn/75d36ed17c91932e28b5eeba681ad8ec)æ¶æ„å›¾

è¿™ç§æ–¹å¼ç¡®å®å¾ˆéº»çƒ¦ï¼Œä¹Ÿä¸æ€ä¹ˆå¥½ï¼Œ**æ²¡åšåˆ°æ‰€è°“çš„åˆ†å¸ƒå¼**ï¼Œå°±æ˜¯ä¸ªæ™®é€šé›†ç¾¤ã€‚å› ä¸ºè¿™å¯¼è‡´ä½ è¦ä¹ˆæ¶ˆè´¹è€…æ¯æ¬¡éšæœºè¿æ¥ä¸€ä¸ªå®ä¾‹ç„¶åæ‹‰å–æ•°æ®ï¼Œè¦ä¹ˆå›ºå®šè¿æ¥é‚£ä¸ª queue æ‰€åœ¨å®ä¾‹æ¶ˆè´¹æ•°æ®ï¼Œå‰è€…æœ‰**æ•°æ®æ‹‰å–çš„å¼€é”€**ï¼Œåè€…å¯¼è‡´**å•å®ä¾‹æ€§èƒ½ç“¶é¢ˆ**ã€‚

è€Œä¸”å¦‚æœé‚£ä¸ªæ”¾ queue çš„å®ä¾‹å®•æœºäº†ï¼Œä¼šå¯¼è‡´æ¥ä¸‹æ¥å…¶ä»–å®ä¾‹å°±æ— æ³•ä»é‚£ä¸ªå®ä¾‹æ‹‰å–ï¼Œå¦‚æœä½ **å¼€å¯äº†æ¶ˆæ¯æŒä¹…åŒ–**ï¼Œè®© RabbitMQ è½åœ°å­˜å‚¨æ¶ˆæ¯çš„è¯ï¼Œ**æ¶ˆæ¯ä¸ä¸€å®šä¼šä¸¢**ï¼Œå¾—ç­‰è¿™ä¸ªå®ä¾‹æ¢å¤äº†ï¼Œç„¶åæ‰å¯ä»¥ç»§ç»­ä»è¿™ä¸ª queue æ‹‰å–æ•°æ®ã€‚

æ‰€ä»¥è¿™ä¸ªäº‹å„¿å°±æ¯”è¾ƒå°´å°¬äº†ï¼Œè¿™å°±**æ²¡æœ‰ä»€ä¹ˆæ‰€è°“çš„é«˜å¯ç”¨æ€§**ï¼Œ**è¿™æ–¹æ¡ˆä¸»è¦æ˜¯æé«˜ååé‡çš„**ï¼Œå°±æ˜¯è¯´è®©é›†ç¾¤ä¸­å¤šä¸ªèŠ‚ç‚¹æ¥æœåŠ¡æŸä¸ª queue çš„è¯»å†™æ“ä½œã€‚

ğŸ¦… **é•œåƒé›†ç¾¤æ¨¡å¼ï¼ˆé«˜å¯ç”¨æ€§ï¼‰**

> è‰¿è‰¿ï¼šè¯·æ•™äº†ä¸‹èƒ–å‹ï¼Œä»–ä»¬é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚
>
> è¿™ç§æ–¹å¼ï¼Œå°±æ˜¯ä¸Šé¢é—®é¢˜çš„ **Mirrored queue** ã€‚

è¿™ç§æ¨¡å¼ï¼Œæ‰æ˜¯æ‰€è°“çš„ RabbitMQ çš„é«˜å¯ç”¨æ¨¡å¼ã€‚è·Ÿæ™®é€šé›†ç¾¤æ¨¡å¼ä¸ä¸€æ ·çš„æ˜¯ï¼Œåœ¨é•œåƒé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä½ åˆ›å»ºçš„ queueï¼Œæ— è®ºå…ƒæ•°æ®è¿˜æ˜¯ queue é‡Œçš„æ¶ˆæ¯éƒ½ä¼š**å­˜åœ¨äºå¤šä¸ªå®ä¾‹ä¸Š**ï¼Œå°±æ˜¯è¯´ï¼Œæ¯ä¸ª RabbitMQ èŠ‚ç‚¹éƒ½æœ‰è¿™ä¸ª queue çš„ä¸€ä¸ª**å®Œæ•´é•œåƒ**ï¼ŒåŒ…å« queue çš„å…¨éƒ¨æ•°æ®çš„æ„æ€ã€‚ç„¶åæ¯æ¬¡ä½ å†™æ¶ˆæ¯åˆ° queue çš„æ—¶å€™ï¼Œéƒ½ä¼šè‡ªåŠ¨æŠŠ**æ¶ˆæ¯åŒæ­¥**åˆ°å¤šä¸ªå®ä¾‹çš„ queue ä¸Šã€‚

[![æ¶æ„å›¾](http://static2.iocoder.cn/20a6c4d82a08becf7e8d913662b00357)](http://static2.iocoder.cn/20a6c4d82a08becf7e8d913662b00357)æ¶æ„å›¾

é‚£ä¹ˆ**å¦‚ä½•å¼€å¯è¿™ä¸ªé•œåƒé›†ç¾¤æ¨¡å¼**å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼ŒRabbitMQ æœ‰å¾ˆå¥½çš„ç®¡ç†æ§åˆ¶å°ï¼Œå°±æ˜¯åœ¨åå°æ–°å¢ä¸€ä¸ªç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥æ˜¯**é•œåƒé›†ç¾¤æ¨¡å¼çš„ç­–ç•¥**ï¼ŒæŒ‡å®šçš„æ—¶å€™æ˜¯å¯ä»¥è¦æ±‚æ•°æ®åŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ï¼Œä¹Ÿå¯ä»¥è¦æ±‚åŒæ­¥åˆ°æŒ‡å®šæ•°é‡çš„èŠ‚ç‚¹ï¼Œå†æ¬¡åˆ›å»º queue çš„æ—¶å€™ï¼Œåº”ç”¨è¿™ä¸ªç­–ç•¥ï¼Œå°±ä¼šè‡ªåŠ¨å°†æ•°æ®åŒæ­¥åˆ°å…¶ä»–çš„èŠ‚ç‚¹ä¸Šå»äº†ã€‚

è¿™æ ·çš„è¯ï¼Œå¥½å¤„åœ¨äºï¼Œä½ ä»»ä½•ä¸€ä¸ªæœºå™¨å®•æœºäº†ï¼Œæ²¡äº‹å„¿ï¼Œå…¶å®ƒæœºå™¨ï¼ˆèŠ‚ç‚¹ï¼‰è¿˜åŒ…å«äº†è¿™ä¸ª queue çš„å®Œæ•´æ•°æ®ï¼Œåˆ«çš„ consumer éƒ½å¯ä»¥åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šå»æ¶ˆè´¹æ•°æ®ã€‚åå¤„åœ¨äºï¼Œç¬¬ä¸€ï¼Œè¿™ä¸ªæ€§èƒ½å¼€é”€ä¹Ÿå¤ªå¤§äº†å§ï¼Œæ¶ˆæ¯éœ€è¦åŒæ­¥åˆ°æ‰€æœ‰æœºå™¨ä¸Šï¼Œå¯¼è‡´ç½‘ç»œå¸¦å®½å‹åŠ›å’Œæ¶ˆè€—å¾ˆé‡ï¼ç¬¬äºŒï¼Œè¿™ä¹ˆç©å„¿ï¼Œä¸æ˜¯åˆ†å¸ƒå¼çš„ï¼Œå°±**æ²¡æœ‰æ‰©å±•æ€§å¯è¨€**äº†ï¼Œå¦‚æœæŸä¸ª queue è´Ÿè½½å¾ˆé‡ï¼Œä½ åŠ æœºå™¨ï¼Œæ–°å¢çš„æœºå™¨ä¹ŸåŒ…å«äº†è¿™ä¸ª queue çš„æ‰€æœ‰æ•°æ®ï¼Œå¹¶**æ²¡æœ‰åŠæ³•çº¿æ€§æ‰©å±•**ä½ çš„ queueã€‚ä½ æƒ³ï¼Œå¦‚æœè¿™ä¸ª queue çš„æ•°æ®é‡å¾ˆå¤§ï¼Œå¤§åˆ°è¿™ä¸ªæœºå™¨ä¸Šçš„å®¹é‡æ— æ³•å®¹çº³äº†ï¼Œæ­¤æ—¶è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

## å¦‚ä½•ä½¿ç”¨ RabbitMQ å®ç° RPC

åŸºäº [RabbitMQ reply_to](https://www.rabbitmq.com/direct-reply-to.html) ç‰¹æ€§ï¼Œå¯ä»¥å¾ˆè½»æ˜“ä½¿ç”¨ RabbitMQ å®ç° RPC åŠŸèƒ½ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ15. RPC è¿œç¨‹è°ƒç”¨ã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚ã€‚

ğŸ¦… **ä½¿ç”¨ RabbitMQ å®ç° RPC æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ**

- 1ã€å°†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è§£è€¦ï¼šå®¢æˆ·ç«¯åªæ˜¯å‘å¸ƒä¸€ä¸ªè¯·æ±‚åˆ° MQ å¹¶æ¶ˆè´¹è¿™ä¸ªè¯·æ±‚çš„å“åº”ã€‚å¹¶ä¸å…³å¿ƒå…·ä½“ç”±è°æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼ŒMQ å¦ä¸€ç«¯çš„è¯·æ±‚çš„æ¶ˆè´¹è€…å¯ä»¥éšæ„æ›¿æ¢æˆä»»ä½•å¯ä»¥å¤„ç†è¯·æ±‚çš„æœåŠ¡å™¨ï¼Œå¹¶ä¸å½±å“åˆ°å®¢æˆ·ç«¯ã€‚

  > ç›¸å½“äº RPC çš„æ³¨å†Œå‘ç°åŠŸèƒ½ï¼Œäº¤ç»™ RabbitMQ æ¥å®ç°äº†ã€‚

- 2ã€å‡è½»æœåŠ¡å™¨çš„å‹åŠ›ï¼šä¼ ç»Ÿçš„ RPC æ¨¡å¼ä¸­å¦‚æœå®¢æˆ·ç«¯å’Œè¯·æ±‚è¿‡å¤šï¼ŒæœåŠ¡å™¨çš„å‹åŠ›ä¼šè¿‡å¤§ã€‚ç”± MQ ä½œä¸ºä¸­é—´ä»¶çš„è¯ï¼Œè¿‡å¤šçš„è¯·æ±‚è€Œæ˜¯è¢« MQ æ¶ˆåŒ–æ‰ï¼ŒæœåŠ¡å™¨å¯ä»¥æ§åˆ¶æ¶ˆè´¹è¯·æ±‚çš„é¢‘æ¬¡ï¼Œå¹¶ä¸ä¼šå½±å“åˆ°æœåŠ¡å™¨ã€‚

- 3ã€æœåŠ¡å™¨çš„æ¨ªå‘æ‰©å±•æ›´åŠ å®¹æ˜“ï¼šå¦‚æœæœåŠ¡å™¨çš„å¤„ç†èƒ½åŠ›ä¸èƒ½æ»¡è¶³è¯·æ±‚çš„é¢‘æ¬¡ï¼Œåªéœ€è¦å¢åŠ æœåŠ¡å™¨æ¥æ¶ˆè´¹ MQ çš„æ¶ˆæ¯å³å¯ï¼ŒMQä¼šå¸®æˆ‘ä»¬å®ç°æ¶ˆæ¯æ¶ˆè´¹çš„è´Ÿè½½å‡è¡¡ã€‚

- 4ã€å¯ä»¥çœ‹å‡º RabbitMQ å¯¹äº RPC æ¨¡å¼çš„æ”¯æŒä¹Ÿæ˜¯æ¯”è¾ƒå‹å¥½åœ°ï¼Œ

  ```
  amq.rabbitmq.reply-to
  ```

  ,

   

  ```
  reply_to
  ```

  ,

   

  ```
  correlation_id
  ```

   

  è¿™äº›ç‰¹æ€§éƒ½è¯´æ˜äº†è¿™ä¸€ç‚¹ï¼Œå†åŠ ä¸Š

   

  spring-rabbit

   

  çš„å®ç°ï¼Œå¯ä»¥è®©æˆ‘ä»¬å¾ˆç®€å•çš„ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼çš„ RPC è°ƒç”¨ã€‚

  > ä¾‹å¦‚è¯´ï¼š[`rabbitmq-jsonrpc`](https://github.com/rabbitmq/rabbitmq-jsonrpc) çš„å®ç°ã€‚

å½“ç„¶ï¼Œè™½ç„¶æœ‰è¿™äº›ä¼˜ç‚¹ï¼Œå®é™…åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šè¿™ä¹ˆåšã€‚ğŸ˜ˆ

ğŸ¦… **ä¸ºä»€ä¹ˆ heavy RPC çš„ä½¿ç”¨åœºæ™¯ä¸‹ä¸å»ºè®®é‡‡ç”¨ disk node ï¼Ÿ**

heavy RPC æ˜¯æŒ‡åœ¨ä¸šåŠ¡é€»è¾‘ä¸­é«˜é¢‘è°ƒç”¨ RabbitMQ æä¾›çš„ RPC æœºåˆ¶ï¼Œå¯¼è‡´ä¸æ–­åˆ›å»ºã€é”€æ¯ reply queue ï¼Œè¿›è€Œé€ æˆ disk node çš„æ€§èƒ½é—®é¢˜ï¼ˆå› ä¸ºä¼šé’ˆå¯¹å…ƒæ•°æ®ä¸æ–­å†™ç›˜ï¼‰ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨ RPC æœºåˆ¶æ—¶éœ€è¦è€ƒè™‘è‡ªèº«çš„ä¸šåŠ¡åœºæ™¯ï¼Œä¸€èˆ¬æ¥è¯´ä¸å»ºè®®ã€‚

## RabbitMQ æ˜¯å¦ä¼šå¼„ä¸¢æ•°æ®ï¼Ÿ

> è‰¿è‰¿ï¼šè¿™ä¸ªé—®é¢˜ï¼ŒåŸºæœ¬æ˜¯æˆ‘ä»¬å‰é¢çœ‹åˆ°çš„å‡ ä¸ªé—®é¢˜çš„æ€»ç»“åˆå¹¶ã€‚

[![å¼„ä¸¢æ¶ˆæ¯çš„å‡ ç§æƒ…å†µ](http://static.iocoder.cn/6303e69011255831c54d605250a6aa67)](http://static.iocoder.cn/6303e69011255831c54d605250a6aa67)å¼„ä¸¢æ¶ˆæ¯çš„å‡ ç§æƒ…å†µ

ğŸ¦… **ç”Ÿäº§è€…å¼„ä¸¢äº†æ•°æ®ï¼Ÿ**

ç”Ÿäº§è€…å°†æ•°æ®å‘é€åˆ° RabbitMQ çš„æ—¶å€™ï¼Œå¯èƒ½æ•°æ®å°±åœ¨åŠè·¯ç»™æä¸¢äº†ï¼Œå› ä¸ºç½‘ç»œé—®é¢˜å•¥çš„ï¼Œéƒ½æœ‰å¯èƒ½ã€‚

> æ–¹æ¡ˆä¸€ï¼šäº‹åŠ¡åŠŸèƒ½

ğŸš€ æ­¤æ—¶å¯ä»¥é€‰æ‹©ç”¨ RabbitMQ æä¾›çš„ã€äº‹åŠ¡åŠŸèƒ½ã€‘ï¼Œå°±æ˜¯ç”Ÿäº§è€…**å‘é€æ•°æ®ä¹‹å‰**å¼€å¯ RabbitMQ äº‹åŠ¡`channel.txSelect`ï¼Œç„¶åå‘é€æ¶ˆæ¯ï¼Œå¦‚æœæ¶ˆæ¯æ²¡æœ‰æˆåŠŸè¢« RabbitMQ æ¥æ”¶åˆ°ï¼Œé‚£ä¹ˆç”Ÿäº§è€…ä¼šæ”¶åˆ°å¼‚å¸¸æŠ¥é”™ï¼Œæ­¤æ—¶å°±å¯ä»¥å›æ»šäº‹åŠ¡`channel.txRollback`ï¼Œç„¶åé‡è¯•å‘é€æ¶ˆæ¯ï¼›å¦‚æœæ”¶åˆ°äº†æ¶ˆæ¯ï¼Œé‚£ä¹ˆå¯ä»¥æäº¤äº‹åŠ¡`channel.txCommit`ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// å¼€å¯äº‹åŠ¡
channel.txSelect
try {
    // è¿™é‡Œå‘é€æ¶ˆæ¯
} catch (Exception e) {
    channel.txRollback

    // è¿™é‡Œå†æ¬¡é‡å‘è¿™æ¡æ¶ˆæ¯
}

// æäº¤äº‹åŠ¡
channel.txCommit
```

- ä½†æ˜¯é—®é¢˜æ˜¯ï¼ŒRabbitMQ äº‹åŠ¡æœºåˆ¶ï¼ˆåŒæ­¥ï¼‰ä¸€æï¼ŒåŸºæœ¬ä¸Š**ååé‡ä¼šä¸‹æ¥ï¼Œå› ä¸ºå¤ªè€—æ€§èƒ½**ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ12. äº‹åŠ¡æ¶ˆæ¯ã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚ã€‚

> æ–¹æ¡ˆäºŒï¼šconfirm åŠŸèƒ½ã€‚

ğŸš€ æ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä½ è¦ç¡®ä¿è¯´å†™ RabbitMQ çš„æ¶ˆæ¯åˆ«ä¸¢ï¼Œå¯ä»¥å¼€å¯ ã€`confirm` æ¨¡å¼ã€‘ï¼Œåœ¨ç”Ÿäº§è€…é‚£é‡Œè®¾ç½®å¼€å¯ `confirm` æ¨¡å¼ä¹‹åï¼Œä½ æ¯æ¬¡å†™çš„æ¶ˆæ¯éƒ½ä¼šåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ idï¼Œç„¶åå¦‚æœå†™å…¥äº† RabbitMQ ä¸­ï¼ŒRabbitMQ ä¼šç»™ä½ å›ä¼ ä¸€ä¸ª `ack` æ¶ˆæ¯ï¼Œå‘Šè¯‰ä½ è¯´è¿™ä¸ªæ¶ˆæ¯ ok äº†ã€‚å¦‚æœ RabbitMQ æ²¡èƒ½å¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œä¼šå›è°ƒä½ çš„ä¸€ä¸ª `nack` æ¥å£ï¼Œå‘Šè¯‰ä½ è¿™ä¸ªæ¶ˆæ¯æ¥æ”¶å¤±è´¥ï¼Œä½ å¯ä»¥é‡è¯•ã€‚è€Œä¸”ä½ å¯ä»¥ç»“åˆè¿™ä¸ªæœºåˆ¶è‡ªå·±åœ¨å†…å­˜é‡Œç»´æŠ¤æ¯ä¸ªæ¶ˆæ¯ id çš„çŠ¶æ€ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šæ—¶é—´è¿˜æ²¡æ¥æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯çš„å›è°ƒï¼Œé‚£ä¹ˆä½ å¯ä»¥é‡å‘ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ14. ç”Ÿäº§è€…çš„å‘é€ç¡®è®¤ã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚ã€‚

> å¯¹æ¯”æ€»ç»“

ğŸš€ äº‹åŠ¡æœºåˆ¶å’Œ `confirm` æœºåˆ¶æœ€å¤§çš„ä¸åŒåœ¨äºï¼Œ**äº‹åŠ¡æœºåˆ¶æ˜¯åŒæ­¥çš„**ï¼Œä½ æäº¤ä¸€ä¸ªäº‹åŠ¡ä¹‹åä¼š**é˜»å¡**åœ¨é‚£å„¿ï¼Œä½†æ˜¯ `confirm` æœºåˆ¶æ˜¯**å¼‚æ­¥**çš„ï¼Œä½ å‘é€ä¸ªæ¶ˆæ¯ä¹‹åå°±å¯ä»¥å‘é€ä¸‹ä¸€ä¸ªæ¶ˆæ¯ï¼Œç„¶åé‚£ä¸ªæ¶ˆæ¯ RabbitMQ æ¥æ”¶äº†ä¹‹åä¼šå¼‚æ­¥å›è°ƒä½ çš„ä¸€ä¸ªæ¥å£é€šçŸ¥ä½ è¿™ä¸ªæ¶ˆæ¯æ¥æ”¶åˆ°äº†ã€‚

æ‰€ä»¥ä¸€èˆ¬åœ¨ç”Ÿäº§è€…è¿™å—**é¿å…æ•°æ®ä¸¢å¤±**ï¼Œéƒ½æ˜¯ç”¨ `confirm` æœºåˆ¶çš„ã€‚

> ğŸ˜ˆ ä¸è¿‡ confirm åŠŸèƒ½ï¼Œä¹Ÿå¯èƒ½å­˜åœ¨ä¸¢æ¶ˆæ¯çš„æƒ…å†µã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœå›è°ƒåˆ° `nack` æ¥å£ï¼Œæ­¤æ—¶ JVM æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆæ­¤æ¶ˆæ¯å°±ä¸¢å¤±äº†ã€‚ï¼ˆè¿™ä¸ªæ˜¯è‰¿è‰¿çš„çŒœæƒ³ï¼Œè¿˜åœ¨æ‰¾èƒ–å‹æ¢è®¨ä¸­ã€‚å…³äºè¿™å—ï¼Œæ¬¢è¿æ˜Ÿçƒè®¨è®ºã€‚ï¼‰

ğŸ¦… **Broker å¼„ä¸¢äº†æ•°æ®**

å°±æ˜¯ Broker è‡ªå·±å¼„ä¸¢äº†æ•°æ®ï¼Œè¿™ä¸ªä½ å¿…é¡»**å¼€å¯ Broker çš„æŒä¹…åŒ–**ï¼Œå°±æ˜¯æ¶ˆæ¯å†™å…¥ä¹‹åä¼šæŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå“ªæ€•æ˜¯ Broker è‡ªå·±æŒ‚äº†ï¼Œ**æ¢å¤ä¹‹åä¼šè‡ªåŠ¨è¯»å–ä¹‹å‰å­˜å‚¨çš„æ•°æ®**ï¼Œä¸€èˆ¬æ•°æ®ä¸ä¼šä¸¢ã€‚é™¤éæå…¶ç½•è§çš„æ˜¯ï¼ŒBroker è¿˜æ²¡æŒä¹…åŒ–ï¼Œè‡ªå·±å°±æŒ‚äº†ï¼Œ**å¯èƒ½å¯¼è‡´å°‘é‡æ•°æ®ä¸¢å¤±**ï¼Œä½†æ˜¯è¿™ä¸ªæ¦‚ç‡è¾ƒå°ã€‚

è®¾ç½®æŒä¹…åŒ–æœ‰**ä¸¤ä¸ªæ­¥éª¤**ï¼š

- åˆ›å»º queue çš„æ—¶å€™å°†å…¶è®¾ç½®ä¸ºæŒä¹…åŒ–
  è¿™æ ·å°±å¯ä»¥ä¿è¯ RabbitMQ æŒä¹…åŒ– queue çš„å…ƒæ•°æ®ï¼Œä½†æ˜¯å®ƒæ˜¯ä¸ä¼šæŒä¹…åŒ– queue é‡Œçš„æ•°æ®çš„ã€‚
- ç¬¬äºŒä¸ªæ˜¯å‘é€æ¶ˆæ¯çš„æ—¶å€™å°†æ¶ˆæ¯çš„ `deliveryMode` è®¾ç½®ä¸º 2
  å°±æ˜¯å°†æ¶ˆæ¯è®¾ç½®ä¸ºæŒä¹…åŒ–çš„ï¼Œæ­¤æ—¶ RabbitMQ å°±ä¼šå°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šå»ã€‚

å¿…é¡»è¦åŒæ—¶è®¾ç½®è¿™ä¸¤ä¸ªæŒä¹…åŒ–æ‰è¡Œï¼ŒBroker å“ªæ€•æ˜¯æŒ‚äº†ï¼Œå†æ¬¡é‡å¯ï¼Œä¹Ÿä¼šä»ç£ç›˜ä¸Šé‡å¯æ¢å¤ queueï¼Œæ¢å¤è¿™ä¸ª queue é‡Œçš„æ•°æ®ã€‚

æ³¨æ„ï¼Œå“ªæ€•æ˜¯ä½ ç»™ Broker å¼€å¯äº†æŒä¹…åŒ–æœºåˆ¶ï¼Œä¹Ÿæœ‰ä¸€ç§å¯èƒ½ï¼Œå°±æ˜¯è¿™ä¸ªæ¶ˆæ¯å†™åˆ°äº† Broker ä¸­ï¼Œä½†æ˜¯è¿˜æ²¡æ¥å¾—åŠæŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼Œç»“æœä¸å·§ï¼Œæ­¤æ—¶ Broker æŒ‚äº†ï¼Œå°±ä¼šå¯¼è‡´å†…å­˜é‡Œçš„ä¸€ç‚¹ç‚¹æ•°æ®ä¸¢å¤±ã€‚

æ‰€ä»¥ï¼ŒæŒä¹…åŒ–å¯ä»¥è·Ÿç”Ÿäº§è€…é‚£è¾¹çš„ `confirm` æœºåˆ¶é…åˆèµ·æ¥ï¼Œåªæœ‰æ¶ˆæ¯è¢«æŒä¹…åŒ–åˆ°ç£ç›˜ä¹‹åï¼Œæ‰ä¼šé€šçŸ¥ç”Ÿäº§è€… `ack` äº†ï¼Œæ‰€ä»¥å“ªæ€•æ˜¯åœ¨æŒä¹…åŒ–åˆ°ç£ç›˜ä¹‹å‰ï¼ŒBroker æŒ‚äº†ï¼Œæ•°æ®ä¸¢äº†ï¼Œç”Ÿäº§è€…æ”¶ä¸åˆ° `ack`ï¼Œä½ ä¹Ÿæ˜¯å¯ä»¥è‡ªå·±é‡å‘çš„ã€‚

ğŸ¦… **æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ®ï¼Ÿ**

RabbitMQ å¦‚æœä¸¢å¤±äº†æ•°æ®ï¼Œä¸»è¦æ˜¯å› ä¸ºä½ æ¶ˆè´¹çš„æ—¶å€™ï¼Œ**åˆšæ¶ˆè´¹åˆ°ï¼Œè¿˜æ²¡å¤„ç†ï¼Œç»“æœè¿›ç¨‹æŒ‚äº†**ï¼Œæ¯”å¦‚é‡å¯äº†ï¼Œé‚£ä¹ˆå°±å°´å°¬äº†ï¼ŒRabbitMQ è®¤ä¸ºä½ éƒ½æ¶ˆè´¹äº†ï¼Œè¿™æ•°æ®å°±ä¸¢äº†ã€‚

è¿™ä¸ªæ—¶å€™å¾—ç”¨ RabbitMQ æä¾›çš„ `ack` æœºåˆ¶ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä½ å¿…é¡»å…³é—­ RabbitMQ çš„è‡ªåŠ¨ `ack`ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ª api æ¥è°ƒç”¨å°±è¡Œï¼Œç„¶åæ¯æ¬¡ä½ è‡ªå·±ä»£ç é‡Œç¡®ä¿å¤„ç†å®Œçš„æ—¶å€™ï¼Œå†åœ¨ç¨‹åºé‡Œ `ack` ä¸€æŠŠã€‚è¿™æ ·çš„è¯ï¼Œå¦‚æœä½ è¿˜æ²¡å¤„ç†å®Œï¼Œä¸å°±æ²¡æœ‰ `ack` äº†ï¼Ÿé‚£ RabbitMQ å°±è®¤ä¸ºä½ è¿˜æ²¡å¤„ç†å®Œï¼Œè¿™ä¸ªæ—¶å€™ RabbitMQ ä¼šæŠŠè¿™ä¸ªæ¶ˆè´¹åˆ†é…ç»™åˆ«çš„ consumer å»å¤„ç†ï¼Œæ¶ˆæ¯æ˜¯ä¸ä¼šä¸¢çš„ã€‚

ğŸ¦… **æ€»ç»“**

[![æ€»ç»“](http://static2.iocoder.cn/83213e2ac79cd8899b09a66a5cf71669)](http://static2.iocoder.cn/83213e2ac79cd8899b09a66a5cf71669)æ€»ç»“

## RabbitMQ å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ

å’Œ Kafka ä¸ RocketMQ ä¸åŒï¼ŒKafka ä¸å­˜åœ¨ç±»ä¼¼ç±»ä¼¼ Topic çš„æ¦‚å¿µï¼Œè€Œæ˜¯çœŸæ­£çš„ä¸€æ¡ä¸€æ¡é˜Ÿåˆ—ï¼Œå¹¶ä¸”æ¯ä¸ªé˜Ÿåˆ—å¯ä»¥è¢«å¤šä¸ª Consumer æ‹‰å–æ¶ˆæ¯ã€‚è¿™ä¸ªï¼Œæ˜¯éå¸¸å¤§çš„ä¸€ä¸ªå·®å¼‚ã€‚

ğŸš€ **æ¥çœ‹çœ‹ RabbitMQ é¡ºåºé”™ä¹±çš„åœºæ™¯**ï¼š

ä¸€ä¸ª queueï¼Œå¤šä¸ª consumerã€‚æ¯”å¦‚ï¼Œç”Ÿäº§è€…å‘ RabbitMQ é‡Œå‘é€äº†ä¸‰æ¡æ•°æ®ï¼Œé¡ºåºä¾æ¬¡æ˜¯ data1/data2/data3ï¼Œå‹å…¥çš„æ˜¯ RabbitMQ çš„ä¸€ä¸ªå†…å­˜é˜Ÿåˆ—ã€‚æœ‰ä¸‰ä¸ªæ¶ˆè´¹è€…åˆ†åˆ«ä» MQ ä¸­æ¶ˆè´¹è¿™ä¸‰æ¡æ•°æ®ä¸­çš„ä¸€æ¡ï¼Œç»“æœæ¶ˆè´¹è€… 2 å…ˆæ‰§è¡Œå®Œæ“ä½œï¼ŒæŠŠ data2 å­˜å…¥æ•°æ®åº“ï¼Œç„¶åæ˜¯ data1/data3ã€‚è¿™ä¸æ˜æ˜¾ä¹±äº†ã€‚ğŸ˜ˆ ä¹Ÿå°±æ˜¯è¯´ï¼Œä¹±åºæ¶ˆè´¹çš„é—®é¢˜ã€‚

[![ä¹±åº](http://static2.iocoder.cn/29ea655479f826f9a6a5d9d005f46c7c)](http://static2.iocoder.cn/29ea655479f826f9a6a5d9d005f46c7c)ä¹±åº

ğŸš€ **è§£å†³æ–¹æ¡ˆ**ï¼š

- æ–¹æ¡ˆä¸€ï¼Œæ‹†åˆ†å¤šä¸ª queueï¼Œæ¯ä¸ª queue ä¸€ä¸ª consumerï¼Œå°±æ˜¯å¤šä¸€äº› queue è€Œå·²ï¼Œç¡®å®æ˜¯éº»çƒ¦ç‚¹ã€‚

  > è¿™ä¸ªæ–¹å¼ï¼Œæœ‰ç‚¹æ¨¡ä»¿ Kafka å’Œ RocketMQ ä¸­ Topic çš„æ¦‚å¿µã€‚ä¾‹å¦‚è¯´ï¼ŒåŸå…ˆä¸€ä¸ª queue å« `"xxx"` ï¼Œé‚£ä¹ˆå¤šä¸ª queue ï¼Œæˆ‘ä»¬å¯ä»¥å« `"xxx-01"`ã€`"xxx-02"` ç­‰ï¼Œç›¸åŒå‰ç¼€ï¼Œä¸åŒåç¼€ã€‚

- æ–¹æ¡ˆäºŒï¼Œæˆ–è€…å°±ä¸€ä¸ª queue ä½†æ˜¯å¯¹åº”ä¸€ä¸ª consumerï¼Œç„¶åè¿™ä¸ª consumer å†…éƒ¨ç”¨å†…å­˜é˜Ÿåˆ—åšæ’é˜Ÿï¼Œç„¶ååˆ†å‘ç»™åº•å±‚ä¸åŒçš„ worker æ¥å¤„ç†ã€‚

  > è¿™ç§æ–¹å¼ï¼Œå°±æ˜¯è®²ä¸€ä¸ª queue é‡Œçš„ï¼Œç›¸åŒçš„â€œkeyâ€ äº¤ç»™åŒä¸€ä¸ª worker æ¥æ‰§è¡Œã€‚å› ä¸º RabbitMQ æ˜¯å¯ä»¥å•æ¡æ¶ˆæ¯æ¥ ack ï¼Œæ‰€ä»¥è¿˜æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ã€‚è¿™ä¸€ç‚¹ï¼Œä¹Ÿæ˜¯å’Œ RocketMQ å’Œ Kafka ä¸åŒçš„åœ°æ–¹ã€‚

[![è§£å†³ä¹±åº](http://static2.iocoder.cn/f1bd6c79deaa6fae89a62d0e53f1ad43)](http://static2.iocoder.cn/f1bd6c79deaa6fae89a62d0e53f1ad43)è§£å†³ä¹±åº

å®é™…ä¸Šï¼Œæˆ‘ä»¬ä¼šå‘ç°ä¸Šè¿°çš„ä¸¤ä¸ªæ–¹æ¡ˆï¼Œå‰æéƒ½æ˜¯ä¸€ä¸ª queue åªèƒ½å¯åŠ¨ä¸€ä¸ª consumer å¯¹åº”ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ11. é¡ºåºæ¶ˆæ¯ã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚



## å¾…æ•´ç†èµ„æ–™

https://blog.csdn.net/mingongge/article/details/99512557

https://www.jianshu.com/p/78847c203b76



# Kafka 

## Apache Kafka æ˜¯ä»€ä¹ˆ?

Kafka æ˜¯åŸºäº**å‘å¸ƒä¸è®¢é˜…**çš„**æ¶ˆæ¯ç³»ç»Ÿ**ã€‚Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ï¼Œå¯åˆ†åŒºçš„ï¼Œå†—ä½™å¤‡ä»½çš„æŒä¹…æ€§çš„æ—¥å¿—æœåŠ¡ã€‚å®ƒä¸»è¦ç”¨äºå¤„ç†æ´»è·ƒçš„æµå¼æ•°æ®ã€‚

- Kafkaè¿è¡Œåœ¨JVMä¸Šï¼Œå¦‚æœå†…å­˜å †ä¸­çš„å¯¹è±¡å¤ªå¤šï¼Œå¿…ç„¶ä¼šåœ¨åƒåœ¾å›æ”¶æ—¶é€ æˆä¸¥é‡çš„å»¶è¿Ÿï¼Œä»è€Œå½±å“ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚

ğŸ¦… **Kafka çš„ä¸»è¦ç‰¹ç‚¹ï¼Ÿ**

- 1ã€é«˜ååã€‚ç”Ÿäº§25 w/sï¼ˆ50MBï¼‰ï¼Œæ¶ˆè´¹ 55 w/sï¼ˆ110MBï¼‰ã€‚
- 2ã€æŒä¹…åŒ–ã€‚
- 3ã€åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ— éœ€åœæœºã€æ˜“äºæ¨ªå‘æ‰©å±•ã€‚
- 4ã€æ¶ˆæ¯è¢«å¤„ç†çš„çŠ¶æ€æ˜¯åœ¨ Consumer ç«¯ç»´æŠ¤ã€‚
- 5ã€æ”¯æŒ onlineï¼ˆåœ¨çº¿ï¼‰ å’Œ offline ï¼ˆç¦»çº¿ï¼‰çš„åœºæ™¯ã€‚

ğŸ¦… **èŠèŠ Kafka çš„è®¾è®¡è¦ç‚¹ï¼Ÿ**

1ï¼‰ååé‡

- 1ã€æ•°æ®ç£ç›˜**æŒä¹…åŒ–**ï¼šç£ç›˜çš„**é¡ºåºè¯»å†™æ€§èƒ½**ã€‚

- 2ã€`zero-copy`

- 3ã€æ•°æ®**æ‰¹é‡å‘é€**

- 4ã€æ•°æ®**å‹ç¼©**

- 5ã€Topic åˆ’åˆ†ä¸ºå¤šä¸ª `Partition` ï¼Œæé«˜å¹¶è¡Œåº¦ã€‚

- 6ã€é¡ºåºIOï¼Œæäº¤æ—¥å¿—ä»¥è¿½åŠ çš„æ–¹å¼å†™å…¥åˆ†åŒºã€

  > æ•°æ®åœ¨ç£ç›˜ä¸Šå­˜å–ä»£ä»·ä¸º `O(1)`ã€‚
  >
  > - Kafka ä»¥ Topic æ¥è¿›è¡Œæ¶ˆæ¯ç®¡ç†ï¼Œæ¯ä¸ª Topic åŒ…å«å¤šä¸ª Partition ï¼Œæ¯ä¸ª Partition å¯¹åº”ä¸€ä¸ª**é€»è¾‘ log** ï¼Œç”±**å¤šä¸ª segment æ–‡ä»¶ç»„æˆ**ã€‚
  > - æ¯ä¸ª segment ä¸­å­˜å‚¨å¤šæ¡æ¶ˆæ¯ï¼ˆè§ä¸‹å›¾ï¼‰ï¼Œæ¶ˆæ¯ id ç”±å…¶é€»è¾‘ä½ç½®å†³å®šï¼Œå³**ä»æ¶ˆæ¯ id å¯ç›´æ¥å®šä½åˆ°æ¶ˆæ¯çš„å­˜å‚¨ä½ç½®**ï¼Œé¿å… id åˆ°ä½ç½®çš„é¢å¤–æ˜ å°„ã€‚
  > - **æ¯ä¸ª Partition åœ¨å†…å­˜ä¸­å¯¹åº”ä¸€ä¸ª index** ï¼Œè®°å½•æ¯ä¸ª segment ä¸­çš„ç¬¬ä¸€æ¡æ¶ˆæ¯åç§»ã€‚
  >
  > å‘å¸ƒè€…å‘åˆ°æŸä¸ª Topic çš„æ¶ˆæ¯ä¼šè¢«å‡åŒ€çš„åˆ†å¸ƒåˆ°å¤šä¸ª Partition ä¸Šï¼ˆéšæœºæˆ–æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„å›è°ƒå‡½æ•°è¿›è¡Œåˆ†å¸ƒï¼‰ï¼ŒBroker æ”¶åˆ°å‘å¸ƒæ¶ˆæ¯å¾€å¯¹åº” Partition çš„æœ€åä¸€ä¸ª segment ä¸Šæ·»åŠ è¯¥æ¶ˆæ¯ã€‚

- **å†…å­˜æ–‡ä»¶æ˜ å°„:å†…å­˜æ˜ å°„æ–‡ä»¶å°†ç£ç›˜ä¸Šçš„æ–‡ä»¶å†…å®¹ä¸å†…å­˜æ˜ å°„èµ·æ¥**ï¼Œæˆ‘ä»¬å¾€å†…å­˜é‡Œå†™å…¥æ•°æ®ï¼Œæ“ä½œç³»ç»Ÿä¼šåœ¨ç¨åæŠŠæ•°æ®å†²åˆ·åˆ°ç£ç›˜ä¸Šã€‚

  > ç›´æ¥ä½¿ç”¨ Linux æ–‡ä»¶ç³»ç»Ÿçš„ Cache ï¼Œæ¥é«˜æ•ˆç¼“å­˜æ•°æ®ã€‚
  >
  > å½“æŸä¸ª `segment`ä¸Š çš„æ¶ˆæ¯æ¡æ•°è¾¾åˆ°é…ç½®å€¼æˆ–æ¶ˆæ¯å‘å¸ƒæ—¶é—´è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œsegmentä¸Š çš„æ¶ˆæ¯ä¼š**è¢« flush åˆ°ç£ç›˜**ï¼Œ**åªæœ‰ flush åˆ°ç£ç›˜ä¸Šçš„æ¶ˆæ¯è®¢é˜…è€…æ‰èƒ½è®¢é˜…åˆ°**ï¼Œsegment è¾¾åˆ°ä¸€å®šçš„å¤§å°åå°†ä¸ä¼šå†å¾€è¯¥ segment å†™æ•°æ®ï¼ŒBroker ä¼šåˆ›å»ºæ–°çš„ segment æ–‡ä»¶ã€‚

2ï¼‰**è´Ÿè½½å‡è¡¡**

- 1ã€Producer æ ¹æ®ç”¨æˆ·**æŒ‡å®šçš„ç®—æ³•ï¼Œå°†æ¶ˆæ¯å‘é€åˆ°æŒ‡å®šçš„ Partition ä¸­**ã€‚
- 2ã€Topic å­˜åœ¨å¤šä¸ª `Partition` ï¼Œæ¯ä¸ª Partition æœ‰è‡ªå·±çš„`replica` ï¼Œæ¯ä¸ª replica åˆ†å¸ƒåœ¨ä¸åŒçš„ `Broker` èŠ‚ç‚¹ä¸Šã€‚å¤šä¸ªPartition éœ€è¦é€‰å–å‡º Leader partition ï¼Œ**Leader Partition è´Ÿè´£è¯»å†™**ï¼Œå¹¶ç”± Zookeeper è´Ÿè´£ fail over ï¼ˆ**å¤±æ•ˆè½¬ç§»**ï¼‰ã€‚
- 3ã€ç›¸åŒ Topic çš„å¤šä¸ª Partition ä¼šåˆ†é…ç»™ä¸åŒçš„ Consumer è¿›è¡Œæ‹‰å–æ¶ˆæ¯ï¼Œè¿›è¡Œæ¶ˆè´¹ã€‚

3ï¼‰**æ‹‰å–ç³»ç»Ÿ**

ç”±äº Kafka Broker ä¼šæŒä¹…åŒ–æ•°æ®ï¼ŒConsumer éå¸¸é€‚åˆé‡‡å– pull çš„æ–¹å¼æ¶ˆè´¹æ•°æ®ï¼Œå…·æœ‰ä»¥ä¸‹å‡ ç‚¹å¥½å¤„ï¼š

- 1ã€ç®€åŒ– Kafka è®¾è®¡ã€‚
- 2ã€Consumer è‡ªä¸»æ§åˆ¶æ¶ˆæ¯æ‹‰å–é€Ÿåº¦ã€‚
- 3ã€Consumer è‡ªä¸»é€‰æ‹©æ¶ˆè´¹æ¨¡å¼ï¼Œä¾‹å¦‚æ‰¹é‡ï¼Œé‡å¤æ¶ˆè´¹ï¼Œä»å°¾ç«¯å¼€å§‹æ¶ˆè´¹ç­‰ã€‚

4ï¼‰å¯æ‰©å±•æ€§

> é€šè¿‡ Zookeeper ç®¡ç† Broker ä¸ Consumer çš„åŠ¨æ€åŠ å…¥ä¸ç¦»å¼€ã€‚

- å½“éœ€è¦å¢åŠ  Broker èŠ‚ç‚¹æ—¶ï¼Œæ–°å¢çš„ Broker ä¼šå‘ Zookeeper æ³¨å†Œï¼Œè€Œ Producer åŠ Consumer ä¼šæ ¹æ®æ³¨å†Œåœ¨ Zookeeper ä¸Šçš„ watcher æ„ŸçŸ¥è¿™äº›å˜åŒ–ï¼Œå¹¶åŠæ—¶ä½œå‡ºè°ƒæ•´ã€‚
- å½“æ–°å¢å’Œåˆ é™¤ Consumer èŠ‚ç‚¹æ—¶ï¼Œç›¸åŒ Topic çš„å¤šä¸ª Partition ä¼šåˆ†é…ç»™å‰©ä½™çš„ Consumer ä»¬ã€‚

å¦å¤–ï¼Œæ¨èé˜…è¯» [ã€Šä¸ºä»€ä¹ˆ Kafka è¿™ä¹ˆå¿«ï¼Ÿã€‹](https://mp.weixin.qq.com/s/pzVS7r3QaQPFwob-fY8b4A) æ–‡ç« ï¼Œå†™çš„æ›´åŠ ç»†è‡´ã€‚

## Kafka çš„æ¶æ„æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

[![Kafka æ¶æ„å›¾](http://static2.iocoder.cn/ac883ce247c1ff31c7cd4244392dcaed)](http://static2.iocoder.cn/ac883ce247c1ff31c7cd4244392dcaed)Kafka æ¶æ„å›¾

Kafka çš„æ•´ä½“æ¶æ„éå¸¸ç®€å•ï¼Œæ˜¯åˆ†å¸ƒå¼æ¶æ„ï¼ŒProducerã€Broker å’ŒConsumer éƒ½å¯ä»¥æœ‰å¤šä¸ªã€‚

- Producerï¼ŒConsumer å®ç° Kafka æ³¨å†Œçš„æ¥å£ã€‚
- æ•°æ®ä» Producer å‘é€åˆ° Broker ä¸­ï¼ŒBroker æ‰¿æ‹…ä¸€ä¸ªä¸­é—´ç¼“å­˜å’Œåˆ†å‘çš„ä½œç”¨ã€‚
- Broker åˆ†å‘æ³¨å†Œåˆ°ç³»ç»Ÿä¸­çš„ Consumerã€‚Broker çš„ä½œç”¨ç±»ä¼¼äºç¼“å­˜ï¼Œå³æ´»è·ƒçš„æ•°æ®å’Œç¦»çº¿å¤„ç†ç³»ç»Ÿä¹‹é—´çš„ç¼“å­˜ã€‚
- å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„é€šä¿¡ï¼Œæ˜¯åŸºäºç®€å•ï¼Œé«˜æ€§èƒ½ï¼Œä¸”ä¸ç¼–ç¨‹è¯­è¨€æ— å…³çš„ TCP åè®®ã€‚

å‡ ä¸ªé‡è¦çš„åŸºæœ¬æ¦‚å¿µï¼š

- Topicï¼šç‰¹æŒ‡ Kafka å¤„ç†çš„æ¶ˆæ¯æºï¼ˆfeeds of messagesï¼‰çš„ä¸åŒåˆ†ç±»ã€‚

- Partitionï¼šTopic ç‰©ç†ä¸Šçš„åˆ†ç»„ï¼ˆåˆ†åŒºï¼‰ï¼Œä¸€ä¸ª Topic å¯ä»¥åˆ†ä¸ºå¤šä¸ª Partition ã€‚æ¯ä¸ª Partition éƒ½æ˜¯ä¸€ä¸ªæœ‰åºçš„é˜Ÿåˆ—ã€‚Partition ä¸­çš„æ¯æ¡æ¶ˆæ¯éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªæœ‰åºçš„ idï¼ˆoffsetï¼‰ã€‚

  > - replicasï¼šPartition çš„å‰¯æœ¬é›†ï¼Œä¿éšœ Partition çš„é«˜å¯ç”¨ã€‚
  > - leaderï¼šreplicas ä¸­çš„ä¸€ä¸ªè§’è‰²ï¼ŒProducer å’Œ Consumer åªè·Ÿ Leader äº¤äº’ã€‚
  > - followerï¼šreplicas ä¸­çš„ä¸€ä¸ªè§’è‰²ï¼Œä» leader ä¸­å¤åˆ¶æ•°æ®ï¼Œä½œä¸ºå‰¯æœ¬ï¼Œä¸€æ—¦ leader æŒ‚æ‰ï¼Œä¼šä»å®ƒçš„ followers ä¸­é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ leader ç»§ç»­æä¾›æœåŠ¡ã€‚

- Messageï¼šæ¶ˆæ¯ï¼Œæ˜¯é€šä¿¡çš„åŸºæœ¬å•ä½ï¼Œæ¯ä¸ª Producer å¯ä»¥å‘ä¸€ä¸ªTopicï¼ˆä¸»é¢˜ï¼‰å‘å¸ƒä¸€äº›æ¶ˆæ¯ã€‚

- Producersï¼šæ¶ˆæ¯å’Œæ•°æ®ç”Ÿäº§è€…ï¼Œå‘ Kafka çš„ä¸€ä¸ª Topic å‘å¸ƒæ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œå«åš producers ã€‚

- Consumersï¼šæ¶ˆæ¯å’Œæ•°æ®æ¶ˆè´¹è€…ï¼Œè®¢é˜… Topic ï¼Œå¹¶å¤„ç†å…¶å‘å¸ƒçš„æ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œå«åš consumers ã€‚

  > Consumer groupï¼šæ¯ä¸ª Consumer éƒ½å±äºä¸€ä¸ª Consumer groupï¼Œæ¯æ¡æ¶ˆæ¯åªèƒ½è¢« Consumer group ä¸­çš„ä¸€ä¸ª Consumer æ¶ˆè´¹ï¼Œä½†å¯ä»¥è¢«å¤šä¸ª Consumer group æ¶ˆè´¹ã€‚

- Brokerï¼šç¼“å­˜ä»£ç†ï¼ŒKafka é›†ç¾¤ä¸­çš„ä¸€å°æˆ–å¤šå°æœåŠ¡å™¨ç»Ÿç§°ä¸º broker ã€‚

  > Controllerï¼šKafka é›†ç¾¤ä¸­ï¼Œé€šè¿‡ Zookeeper é€‰ä¸¾æŸä¸ª Broker ä½œä¸º Controller ï¼Œç”¨æ¥è¿›è¡Œ leader election ä»¥åŠ å„ç§ failover ã€‚

- ZooKeeperï¼šKafka é€šè¿‡ ZooKeeper æ¥å­˜å‚¨é›†ç¾¤çš„ Topicã€Partition ç­‰å…ƒä¿¡æ¯ç­‰ã€‚

ğŸ˜ˆ å•çº¯è§’è‰²æ¥è¯´ï¼ŒKafka å’Œ RocketMQ æ˜¯åŸºæœ¬ä¸€è‡´çš„ã€‚æ¯”è¾ƒæ˜æ˜¾çš„å·®å¼‚æ˜¯ï¼š

> RocketMQ ä» Kafka æ¼”åŒ–è€Œæ¥ã€‚

- 1ã€Kafka ä½¿ç”¨ Zookeeper ä½œä¸ºå‘½åæœåŠ¡ï¼›RocketMQ è‡ªå·±å®ç°äº†ä¸€ä¸ªè½»é‡çº§çš„ Namesrv ã€‚

- 2ã€Kafka Broker çš„æ¯ä¸ªåˆ†åŒºéƒ½æœ‰ä¸€ä¸ªé¦–é¢†åˆ†åŒºï¼›RocketMQ æ¯ä¸ªåˆ†åŒºçš„â€œé¦–é¢†â€åˆ†åŒºï¼Œéƒ½åœ¨ Broker Master èŠ‚ç‚¹ä¸Šã€‚

  > RocketMQ æ²¡æœ‰é¦–é¢†åˆ†åŒºä¸€è¯´ï¼Œæ‰€ä»¥æ‰“ä¸Šäº†å¼•å·ã€‚

- 3ã€Kafka Consumer ä½¿ç”¨ poll çš„æ–¹å¼æ‹‰å–æ¶ˆæ¯ï¼›RocketMQ Consumer æä¾› poll çš„æ–¹å¼çš„åŒæ—¶ï¼Œå°è£…äº†ä¸€ä¸ª push çš„æ–¹å¼ã€‚

  > RocketMQ çš„ push çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯åŸºäº poll çš„æ–¹å¼çš„å°è£…ã€‚

- â€¦ å½“ç„¶è¿˜æœ‰å…¶å®ƒ â€¦

ğŸ¦… **Kafka ä¸ºä»€ä¹ˆè¦å°† Topic è¿›è¡Œåˆ†åŒºï¼Ÿ**

æ­£å¦‚æˆ‘ä»¬åœ¨ [ã€ŒèŠèŠ Kafka çš„è®¾è®¡è¦ç‚¹ï¼Ÿã€](http://svip.iocoder.cn/Kafka/Interview/#) é—®é¢˜ä¸­æ‰€çœ‹åˆ°çš„ï¼Œæ˜¯ä¸ºäº†è´Ÿè½½å‡è¡¡ï¼Œä»è€Œèƒ½å¤Ÿæ°´å¹³æ‹“å±•ã€‚

- Topic åªæ˜¯é€»è¾‘æ¦‚å¿µï¼Œé¢å‘çš„æ˜¯ Producer å’Œ Consumer ï¼Œè€Œ Partition åˆ™æ˜¯ç‰©ç†æ¦‚å¿µã€‚å¦‚æœ Topic ä¸è¿›è¡Œåˆ†åŒºï¼Œè€Œå°† Topic å†…çš„æ¶ˆæ¯å­˜å‚¨äºä¸€ä¸ª Brokerï¼Œé‚£ä¹ˆå…³äºè¯¥ Topic çš„æ‰€æœ‰è¯»å†™è¯·æ±‚éƒ½å°†ç”±è¿™ä¸€ä¸ª Broker å¤„ç†ï¼Œååé‡å¾ˆå®¹æ˜“é™·å…¥ç“¶é¢ˆï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸ç¬¦åˆé«˜ååé‡åº”ç”¨åœºæ™¯çš„ã€‚
- æœ‰äº† Partition æ¦‚å¿µä»¥åï¼Œå‡è®¾ä¸€ä¸ª Topic è¢«åˆ†ä¸º 10 ä¸ª Partitions ï¼ŒKafka ä¼šæ ¹æ®ä¸€å®šçš„ç®—æ³•å°† 10 ä¸ª Partition å°½å¯èƒ½å‡åŒ€çš„åˆ†å¸ƒåˆ°ä¸åŒçš„ Brokerï¼ˆæœåŠ¡å™¨ï¼‰ä¸Šã€‚
- å½“ Producer å‘å¸ƒæ¶ˆæ¯æ—¶ï¼ŒProducer å®¢æˆ·ç«¯å¯ä»¥é‡‡ç”¨ randomã€key-hash åŠè½®è¯¢ç­‰ç®—æ³•é€‰å®šç›®æ ‡ Partition ï¼Œè‹¥ä¸æŒ‡å®šï¼ŒKafka ä¹Ÿå°†æ ¹æ®ä¸€å®šç®—æ³•å°†å…¶ç½®äºæŸä¸€åˆ†åŒºä¸Šã€‚
- å½“ Consumer æ‹‰å–æ¶ˆæ¯æ—¶ï¼ŒConsumer å®¢æˆ·ç«¯å¯ä»¥é‡‡ç”¨ Rangeã€è½®è¯¢ ç­‰ç®—æ³•åˆ†é… Partition ï¼Œä»è€Œä»ä¸åŒçš„ Broker æ‹‰å–å¯¹åº”çš„ Partition çš„ leader åˆ†åŒºã€‚

æ‰€ä»¥ï¼ŒPartiton æœºåˆ¶å¯ä»¥æå¤§çš„æé«˜ååé‡ï¼Œå¹¶ä¸”ä½¿å¾—ç³»ç»Ÿå…·å¤‡è‰¯å¥½çš„æ°´å¹³æ‰©å±•èƒ½åŠ›ã€‚

## Kafka çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ

[![Kafka çš„åº”ç”¨åœºæ™¯](http://static2.iocoder.cn/3636ff4bd554ee1dfcfb92448073b5b8)](http://static2.iocoder.cn/3636ff4bd554ee1dfcfb92448073b5b8)Kafka çš„åº”ç”¨åœºæ™¯

1ï¼‰æ¶ˆæ¯é˜Ÿåˆ—

æ¯”èµ·å¤§å¤šæ•°çš„æ¶ˆæ¯ç³»ç»Ÿæ¥è¯´ï¼ŒKafka æœ‰æ›´å¥½çš„ååé‡ï¼Œå†…ç½®çš„åˆ†åŒºï¼Œå†—ä½™åŠå®¹é”™æ€§ï¼Œè¿™è®© Kafka æˆä¸ºäº†ä¸€ä¸ªå¾ˆå¥½çš„å¤§è§„æ¨¡æ¶ˆæ¯å¤„ç†åº”ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚æ¶ˆæ¯ç³»ç»Ÿä¸€èˆ¬ååé‡ç›¸å¯¹è¾ƒä½ï¼Œä½†æ˜¯éœ€è¦æ›´å°çš„ç«¯åˆ°ç«¯å»¶æ—¶ï¼Œå¹¶å¸¸å¸¸ä¾èµ–äº Kafka æä¾›çš„å¼ºå¤§çš„æŒä¹…æ€§ä¿éšœã€‚åœ¨è¿™ä¸ªé¢†åŸŸï¼ŒKafka è¶³ä»¥åª²ç¾ä¼ ç»Ÿæ¶ˆæ¯ç³»ç»Ÿï¼Œå¦‚ ActiveMQ æˆ– RabbitMQ ã€‚

2ï¼‰è¡Œä¸ºè·Ÿè¸ª

Kafka çš„å¦ä¸€ä¸ªåº”ç”¨åœºæ™¯ï¼Œæ˜¯è·Ÿè¸ªç”¨æˆ·æµè§ˆé¡µé¢ã€æœç´¢åŠå…¶ä»–è¡Œä¸ºï¼Œä»¥å‘å¸ƒè®¢é˜…çš„æ¨¡å¼å®æ—¶è®°å½•åˆ°å¯¹åº”çš„ Topic é‡Œã€‚é‚£ä¹ˆè¿™äº›ç»“æœè¢«è®¢é˜…è€…æ‹¿åˆ°åï¼Œå°±å¯ä»¥åšè¿›ä¸€æ­¥çš„å®æ—¶å¤„ç†ï¼Œæˆ–å®æ—¶ç›‘æ§ï¼Œæˆ–æ”¾åˆ° Hadoop / ç¦»çº¿æ•°æ®ä»“åº“é‡Œå¤„ç†ã€‚

3ï¼‰å…ƒä¿¡æ¯ç›‘æ§

ä½œä¸ºæ“ä½œè®°å½•çš„ç›‘æ§æ¨¡å—æ¥ä½¿ç”¨ï¼Œå³æ±‡é›†è®°å½•ä¸€äº›æ“ä½œä¿¡æ¯ï¼Œå¯ä»¥ç†è§£ä¸ºè¿ç»´æ€§è´¨çš„æ•°æ®ç›‘æ§å§ã€‚

4ï¼‰æ—¥å¿—æ”¶é›†

æ—¥å¿—æ”¶é›†æ–¹é¢ï¼Œå…¶å®å¼€æºäº§å“æœ‰å¾ˆå¤šï¼ŒåŒ…æ‹¬ Scribeã€Apache Flume ã€‚å¾ˆå¤šäººä½¿ç”¨ Kafka ä»£æ›¿æ—¥å¿—èšåˆï¼ˆlog aggregationï¼‰ã€‚æ—¥å¿—èšåˆä¸€èˆ¬æ¥è¯´æ˜¯ä»æœåŠ¡å™¨ä¸Šæ”¶é›†æ—¥å¿—æ–‡ä»¶ï¼Œç„¶åæ”¾åˆ°ä¸€ä¸ªé›†ä¸­çš„ä½ç½®ï¼ˆæ–‡ä»¶æœåŠ¡å™¨æˆ– HDFSï¼‰è¿›è¡Œå¤„ç†ã€‚

ç„¶è€Œï¼Œ Kafka å¿½ç•¥æ‰æ–‡ä»¶çš„ç»†èŠ‚ï¼Œå°†å…¶æ›´æ¸…æ™°åœ°æŠ½è±¡æˆä¸€ä¸ªä¸ªæ—¥å¿—æˆ–äº‹ä»¶çš„æ¶ˆæ¯æµã€‚è¿™å°±è®© Kafka å¤„ç†è¿‡ç¨‹å»¶è¿Ÿæ›´ä½ï¼Œæ›´å®¹æ˜“æ”¯æŒå¤šæ•°æ®æºå’Œåˆ†å¸ƒå¼æ•°æ®å¤„ç†ã€‚æ¯”èµ·ä»¥æ—¥å¿—ä¸ºä¸­å¿ƒçš„ç³»ç»Ÿæ¯”å¦‚ Scribe æˆ–è€… Flume æ¥è¯´ï¼ŒKafka æä¾›åŒæ ·é«˜æ•ˆçš„æ€§èƒ½å’Œå› ä¸ºå¤åˆ¶å¯¼è‡´çš„æ›´é«˜çš„è€ç”¨æ€§ä¿è¯ï¼Œä»¥åŠæ›´ä½çš„ç«¯åˆ°ç«¯å»¶è¿Ÿã€‚

5ï¼‰æµå¤„ç†

è¿™ä¸ªåœºæ™¯å¯èƒ½æ¯”è¾ƒå¤šï¼Œä¹Ÿå¾ˆå¥½ç†è§£ã€‚ä¿å­˜æ”¶é›†æµæ•°æ®ï¼Œä»¥æä¾›ä¹‹åå¯¹æ¥çš„ Storm æˆ–å…¶ä»–æµå¼è®¡ç®—æ¡†æ¶è¿›è¡Œå¤„ç†ã€‚å¾ˆå¤šç”¨æˆ·ä¼šå°†é‚£äº›ä»åŸå§‹ Topic æ¥çš„æ•°æ®è¿›è¡Œé˜¶æ®µæ€§å¤„ç†ï¼Œæ±‡æ€»ï¼Œæ‰©å……æˆ–è€…ä»¥å…¶ä»–çš„æ–¹å¼è½¬æ¢åˆ°æ–°çš„ Topic ä¸‹å†ç»§ç»­åé¢çš„å¤„ç†ã€‚

ä¾‹å¦‚ä¸€ä¸ªæ–‡ç« æ¨èçš„å¤„ç†æµç¨‹ï¼Œå¯èƒ½æ˜¯å…ˆä» RSS æ•°æ®æºä¸­æŠ“å–æ–‡ç« çš„å†…å®¹ï¼Œç„¶åå°†å…¶ä¸¢å…¥ä¸€ä¸ªå«åšâ€œæ–‡ç« â€çš„ Topic ä¸­ã€‚åç»­æ“ä½œå¯èƒ½æ˜¯éœ€è¦å¯¹è¿™ä¸ªå†…å®¹è¿›è¡Œæ¸…ç†ï¼Œæ¯”å¦‚å›å¤æ­£å¸¸æ•°æ®æˆ–è€…åˆ é™¤é‡å¤æ•°æ®ï¼Œæœ€åå†å°†å†…å®¹åŒ¹é…çš„ç»“æœè¿”è¿˜ç»™ç”¨æˆ·ã€‚è¿™å°±åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ Topic ä¹‹å¤–ï¼Œäº§ç”Ÿäº†ä¸€ç³»åˆ—çš„å®æ—¶æ•°æ®å¤„ç†çš„æµç¨‹ã€‚Strom å’Œ Samza æ˜¯éå¸¸è‘—åçš„å®ç°è¿™ç§ç±»å‹æ•°æ®è½¬æ¢çš„æ¡†æ¶ã€‚

6ï¼‰äº‹ä»¶æº

äº‹ä»¶æºï¼Œæ˜¯ä¸€ç§åº”ç”¨ç¨‹åºè®¾è®¡çš„æ–¹å¼ã€‚è¯¥æ–¹å¼çš„çŠ¶æ€è½¬ç§»è¢«è®°å½•ä¸ºæŒ‰æ—¶é—´é¡ºåºæ’åºçš„è®°å½•åºåˆ—ã€‚Kafka å¯ä»¥å­˜å‚¨å¤§é‡çš„æ—¥å¿—æ•°æ®ï¼Œè¿™ä½¿å¾—å®ƒæˆä¸ºä¸€ä¸ªå¯¹è¿™ç§æ–¹å¼çš„åº”ç”¨æ¥è¯´ç»ä½³çš„åå°ã€‚æ¯”å¦‚åŠ¨æ€æ±‡æ€»ï¼ˆNews feedï¼‰ã€‚

7ï¼‰æŒä¹…æ€§æ—¥å¿—ï¼ˆCommit Logï¼‰

Kafka å¯ä»¥ä¸ºä¸€ç§å¤–éƒ¨çš„æŒä¹…æ€§æ—¥å¿—çš„åˆ†å¸ƒå¼ç³»ç»Ÿæä¾›æœåŠ¡ã€‚è¿™ç§æ—¥å¿—å¯ä»¥åœ¨èŠ‚ç‚¹é—´å¤‡ä»½æ•°æ®ï¼Œå¹¶ä¸ºæ•…éšœèŠ‚ç‚¹æ•°æ®å›å¤æä¾›ä¸€ç§é‡æ–°åŒæ­¥çš„æœºåˆ¶ã€‚Kafka ä¸­æ—¥å¿—å‹ç¼©åŠŸèƒ½ä¸ºè¿™ç§ç”¨æ³•æä¾›äº†æ¡ä»¶ã€‚åœ¨è¿™ç§ç”¨æ³•ä¸­ï¼ŒKafka ç±»ä¼¼äº Apache BookKeeper é¡¹ç›®ã€‚

## Kafka æ¶ˆæ¯å‘é€å’Œæ¶ˆè´¹çš„ç®€åŒ–æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

[![Kafka æ¶ˆæ¯å‘é€å’Œæ¶ˆè´¹](http://static2.iocoder.cn/456f3adab70714c0a1b1fdbd8a686732)](http://static2.iocoder.cn/456f3adab70714c0a1b1fdbd8a686732)Kafka æ¶ˆæ¯å‘é€å’Œæ¶ˆè´¹

- 1ã€Producer ï¼Œæ ¹æ®æŒ‡å®šçš„ partition æ–¹æ³•ï¼ˆround-robinã€hashç­‰ï¼‰ï¼Œå°†æ¶ˆæ¯å‘å¸ƒåˆ°æŒ‡å®š Topic çš„ Partition é‡Œé¢ã€‚
- 2ã€Kafka é›†ç¾¤ï¼Œæ¥æ”¶åˆ° Producer å‘è¿‡æ¥çš„æ¶ˆæ¯åï¼Œå°†å…¶æŒä¹…åŒ–åˆ°ç¡¬ç›˜ï¼Œå¹¶ä¿ç•™æ¶ˆæ¯æŒ‡å®šæ—¶é•¿ï¼ˆå¯é…ç½®ï¼‰ï¼Œè€Œä¸å…³æ³¨æ¶ˆæ¯æ˜¯å¦è¢«æ¶ˆè´¹ã€‚
- 3ã€Consumer ï¼Œä» Kafka é›†ç¾¤ pull æ•°æ®ï¼Œå¹¶æ§åˆ¶è·å–æ¶ˆæ¯çš„ offset ã€‚è‡³äºæ¶ˆè´¹çš„è¿›åº¦ï¼Œå¯æ‰‹åŠ¨æˆ–è€…è‡ªåŠ¨æäº¤ç»™ Kafka é›†ç¾¤ã€‚

ğŸ¦… **1ï¼‰Producer å‘é€æ¶ˆæ¯**

Producer é‡‡ç”¨ push æ¨¡å¼å°†æ¶ˆæ¯å‘å¸ƒåˆ° Brokerï¼Œæ¯æ¡æ¶ˆæ¯éƒ½è¢« append åˆ° Patition ä¸­ï¼Œå±äºé¡ºåºå†™ç£ç›˜ï¼ˆé¡ºåºå†™ç£ç›˜æ•ˆç‡æ¯”éšæœºå†™å†…å­˜è¦é«˜ï¼Œä¿éšœ Kafka ååç‡ï¼‰ã€‚Producer å‘é€æ¶ˆæ¯åˆ° Broker æ—¶ï¼Œä¼šæ ¹æ®åˆ†åŒºç®—æ³•é€‰æ‹©å°†å…¶å­˜å‚¨åˆ°å“ªä¸€ä¸ª Partition ã€‚

å…¶è·¯ç”±æœºåˆ¶ä¸ºï¼š

- 1ã€æŒ‡å®šäº† Partition ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ã€‚
- 2ã€æœªæŒ‡å®š Partition ä½†æŒ‡å®š key ï¼Œé€šè¿‡å¯¹ key è¿›è¡Œ hash é€‰å‡ºä¸€ä¸ª Partition ã€‚
- 3ã€Partition å’Œ key éƒ½æœªæŒ‡å®šï¼Œä½¿ç”¨è½®è¯¢é€‰å‡ºä¸€ä¸ª Partition ã€‚

å†™å…¥æµç¨‹ï¼š

- 1ã€Producer å…ˆä» ZooKeeper çš„ `"/brokers/.../state"` èŠ‚ç‚¹æ‰¾åˆ°è¯¥ Partition çš„ leader ã€‚

  > æ³¨æ„å™¢ï¼ŒProducer åªå’Œ Partition çš„ leader è¿›è¡Œäº¤äº’ã€‚

- 2ã€Producer å°†æ¶ˆæ¯å‘é€ç»™è¯¥ leader ã€‚

- 3ã€leader å°†æ¶ˆæ¯å†™å…¥æœ¬åœ° log ã€‚

- 4ã€followers ä» leader pull æ¶ˆæ¯ï¼Œå†™å…¥æœ¬åœ° log å leader å‘é€ ACK ã€‚

- 5ã€leader æ”¶åˆ°æ‰€æœ‰ ISR ä¸­çš„ replica çš„ ACK åï¼Œå¢åŠ  HWï¼ˆhigh watermark ï¼Œæœ€å commit çš„ offsetï¼‰ å¹¶å‘ Producer å‘é€ ACK ã€‚

ğŸ¦… **2ï¼‰Broker å­˜å‚¨æ¶ˆæ¯**

ç‰©ç†ä¸ŠæŠŠ Topic åˆ†æˆä¸€ä¸ªæˆ–å¤šä¸ª Patitionï¼Œæ¯ä¸ª Patition ç‰©ç†ä¸Šå¯¹åº”ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼ˆè¯¥æ–‡ä»¶å¤¹å­˜å‚¨è¯¥ Patition çš„æ‰€æœ‰æ¶ˆæ¯å’Œç´¢å¼•æ–‡ä»¶ï¼‰ã€‚

ğŸ¦… **3ï¼‰Consumer æ¶ˆè´¹æ¶ˆæ¯**

high-level Consumer API æä¾›äº† consumer group çš„è¯­ä¹‰ï¼Œä¸€ä¸ªæ¶ˆæ¯åªèƒ½è¢« group å†…çš„ä¸€ä¸ª Consumer æ‰€æ¶ˆè´¹ï¼Œä¸” Consumer æ¶ˆè´¹æ¶ˆæ¯æ—¶ä¸å…³æ³¨ offset ï¼Œæœ€åä¸€ä¸ª offset ç”± ZooKeeper ä¿å­˜ï¼ˆä¸‹æ¬¡æ¶ˆè´¹æ—¶ï¼Œè¯¥ group ä¸­çš„ Consumer å°†ä» offset è®°å½•çš„ä½ç½®å¼€å§‹æ¶ˆè´¹ï¼‰ã€‚

æ³¨æ„ï¼š

- 1ã€å¦‚æœæ¶ˆè´¹çº¿ç¨‹å¤§äº Patition æ•°é‡ï¼Œåˆ™æœ‰äº›çº¿ç¨‹å°†æ”¶ä¸åˆ°æ¶ˆæ¯ã€‚
- 2ã€å¦‚æœ Patition æ•°é‡å¤§äºæ¶ˆè´¹çº¿ç¨‹æ•°ï¼Œåˆ™æœ‰äº›çº¿ç¨‹å¤šæ”¶åˆ°å¤šä¸ª Patition çš„æ¶ˆæ¯ã€‚
- 3ã€å¦‚æœä¸€ä¸ªçº¿ç¨‹æ¶ˆè´¹å¤šä¸ª Patitionï¼Œåˆ™æ— æ³•ä¿è¯ä½ æ”¶åˆ°çš„æ¶ˆæ¯çš„é¡ºåºï¼Œè€Œä¸€ä¸ª Patition å†…çš„æ¶ˆæ¯æ˜¯æœ‰åºçš„ã€‚

Consumer é‡‡ç”¨ pull æ¨¡å¼ä» Broker ä¸­è¯»å–æ•°æ®ã€‚

- push æ¨¡å¼ï¼Œå¾ˆéš¾é€‚åº”æ¶ˆè´¹é€Ÿç‡ä¸åŒçš„æ¶ˆè´¹è€…ï¼Œå› ä¸ºæ¶ˆæ¯å‘é€é€Ÿç‡æ˜¯ç”± Broker å†³å®šçš„ã€‚å®ƒçš„ç›®æ ‡æ˜¯å°½å¯èƒ½ä»¥æœ€å¿«é€Ÿåº¦ä¼ é€’æ¶ˆæ¯ï¼Œä½†æ˜¯è¿™æ ·å¾ˆå®¹æ˜“é€ æˆ Consumer æ¥ä¸åŠå¤„ç†æ¶ˆæ¯ï¼Œå…¸å‹çš„è¡¨ç°å°±æ˜¯æ‹’ç»æœåŠ¡ä»¥åŠç½‘ç»œæ‹¥å¡ã€‚è€Œ pull æ¨¡å¼ï¼Œåˆ™å¯ä»¥æ ¹æ® Consumer çš„æ¶ˆè´¹èƒ½åŠ›ä»¥é€‚å½“çš„é€Ÿç‡æ¶ˆè´¹æ¶ˆæ¯ã€‚
- å¯¹äº Kafka è€Œè¨€ï¼Œpull æ¨¡å¼æ›´åˆé€‚ï¼Œå®ƒå¯ç®€åŒ– Broker çš„è®¾è®¡ï¼ŒConsumer å¯è‡ªä¸»æ§åˆ¶æ¶ˆè´¹æ¶ˆæ¯çš„é€Ÿç‡ï¼ŒåŒæ—¶ Consumer å¯ä»¥è‡ªå·±æ§åˆ¶æ¶ˆè´¹æ–¹å¼â€”â€”å³å¯æ‰¹é‡æ¶ˆè´¹ä¹Ÿå¯é€æ¡æ¶ˆè´¹ï¼ŒåŒæ—¶è¿˜èƒ½é€‰æ‹©ä¸åŒçš„æäº¤æ–¹å¼ä»è€Œå®ç°ä¸åŒçš„ä¼ è¾“è¯­ä¹‰ã€‚

ğŸ¦… **Kafka Producer æœ‰å“ªäº›å‘é€æ¨¡å¼ï¼Ÿ**

Kafka çš„å‘é€æ¨¡å¼ç”± Producer ç«¯çš„é…ç½®å‚æ•° `producer.type`æ¥è®¾ç½®ã€‚

- è¿™ä¸ªå‚æ•°æŒ‡å®šäº†åœ¨åå°çº¿ç¨‹ä¸­æ¶ˆæ¯çš„å‘é€æ–¹å¼æ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„ï¼Œé»˜è®¤æ˜¯åŒæ­¥çš„æ–¹å¼ï¼Œå³ `producer.type=sync` ã€‚
- å¦‚æœè®¾ç½®æˆå¼‚æ­¥çš„æ¨¡å¼ï¼Œå³ `producer.type=async` ï¼Œå¯ä»¥æ˜¯ Producer ä»¥ batch çš„å½¢å¼ push æ•°æ®ï¼Œè¿™æ ·ä¼šæå¤§çš„æé«˜ Brokerçš„æ€§èƒ½ï¼Œä½†æ˜¯è¿™æ ·ä¼šå¢åŠ ä¸¢å¤±æ•°æ®çš„é£é™©ã€‚
- å¦‚æœéœ€è¦ç¡®ä¿æ¶ˆæ¯çš„å¯é æ€§ï¼Œå¿…é¡»è¦å°† `producer.type`è®¾ç½®ä¸º sync ã€‚

å¯¹äºå¼‚æ­¥æ¨¡å¼ï¼Œè¿˜æœ‰ 4 ä¸ªé…å¥—çš„å‚æ•°ï¼Œå¦‚ä¸‹ï¼š

[![å‚æ•°](http://static2.iocoder.cn/792a59a9b2b4f271c179e81cf4278322)](http://static2.iocoder.cn/792a59a9b2b4f271c179e81cf4278322)å‚æ•°

- ä»¥ batch çš„æ–¹å¼æ¨é€æ•°æ®å¯ä»¥æå¤§çš„æé«˜å¤„ç†æ•ˆç‡ï¼ŒKafka Producer å¯ä»¥å°†æ¶ˆæ¯åœ¨å†…å­˜ä¸­ç´¯è®¡åˆ°ä¸€å®šæ•°é‡åä½œä¸ºä¸€ä¸ª batch å‘é€è¯·æ±‚ã€‚batch çš„æ•°é‡å¤§å°å¯ä»¥é€šè¿‡ Producer çš„å‚æ•°ï¼ˆ`batch.num.messages`ï¼‰æ§åˆ¶ã€‚é€šè¿‡å¢åŠ  batch çš„å¤§å°ï¼Œå¯ä»¥å‡å°‘ç½‘ç»œè¯·æ±‚å’Œç£ç›˜ IO çš„æ¬¡æ•°ï¼Œå½“ç„¶å…·ä½“å‚æ•°è®¾ç½®éœ€è¦åœ¨æ•ˆç‡å’Œæ—¶æ•ˆæ€§æ–¹é¢åšä¸€ä¸ªæƒè¡¡ã€‚

- åœ¨æ¯”è¾ƒæ–°çš„ç‰ˆæœ¬ä¸­è¿˜æœ‰

   

  ```
  batch.size
  ```

   

  è¿™ä¸ªå‚æ•°ã€‚Producer ä¼šå°è¯•æ‰¹é‡å‘é€å±äºåŒä¸€ä¸ª Partition çš„æ¶ˆæ¯ä»¥å‡å°‘è¯·æ±‚çš„æ•°é‡. è¿™æ ·å¯ä»¥æå‡å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„æ€§èƒ½ã€‚é»˜è®¤å¤§å°æ˜¯ 16348 byte (16k).

  - å‘é€åˆ° Broker çš„è¯·æ±‚å¯ä»¥åŒ…å«å¤šä¸ª batch ï¼Œæ¯ä¸ª batch çš„æ•°æ®å±äºåŒä¸€ä¸ª Partition ã€‚
  - å¤ªå°çš„ batch ä¼šé™ä½åå. å¤ªå¤§ä¼šæµªè´¹å†…å­˜ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— Kafka å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ3. å¿«é€Ÿå…¥é—¨ã€](http://svip.iocoder.cn/Kafka/Interview/#)å’Œ[ã€Œ4. æ‰¹é‡å‘é€æ¶ˆæ¯ã€](http://svip.iocoder.cn/Kafka/Interview/#)å°èŠ‚ã€‚

ğŸ¦… **Kafka Consumer æ˜¯å¦å¯ä»¥æ¶ˆè´¹æŒ‡å®šçš„åˆ†åŒºæ¶ˆæ¯ï¼Ÿ**

Consumer æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œå‘ Broker å‘å‡ºâ€œfetchâ€è¯·æ±‚å»æ¶ˆè´¹ç‰¹å®šåˆ†åŒºçš„æ¶ˆæ¯ï¼ŒConsumer æŒ‡å®šæ¶ˆæ¯åœ¨æ—¥å¿—ä¸­çš„åç§»é‡(offset)ï¼Œå°±å¯ä»¥æ¶ˆè´¹ä»è¿™ä¸ªä½ç½®å¼€å§‹çš„æ¶ˆæ¯ï¼ŒConsumer æ‹¥æœ‰äº† offset çš„æ§åˆ¶æƒï¼Œå¯ä»¥å‘åå›æ»šå»é‡æ–°æ¶ˆè´¹ä¹‹å‰çš„æ¶ˆæ¯ï¼Œè¿™æ˜¯å¾ˆæœ‰æ„ä¹‰çš„ã€‚

ğŸ¦… **Kafka çš„ high-level API å’Œ low-level API çš„åŒºåˆ«ï¼Ÿ**

High Level API

- å±è”½äº†æ¯ä¸ª Topic çš„æ¯ä¸ª Partition çš„ offset ç®¡ç†ï¼ˆè‡ªåŠ¨è¯»å–Zookeeper ä¸­è¯¥ Consumer group çš„ last offsetï¼‰ã€Broker å¤±è´¥è½¬ç§»ã€ä»¥åŠå¢å‡ Partition æ—¶ Consumer æ—¶çš„è´Ÿè½½å‡è¡¡ï¼ˆKafka è‡ªåŠ¨è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼‰ã€‚
- å¦‚æœ Consumer æ¯” Partition å¤šï¼Œæ˜¯ä¸€ç§æµªè´¹ã€‚ä¸€ä¸ª Partition ä¸Šæ˜¯ä¸å…è®¸å¹¶å‘çš„ï¼Œæ‰€ä»¥ Consumer æ•°ä¸è¦å¤§äº Partition æ•°ã€‚

Low Level API

> Low-level API ä¹Ÿå°±æ˜¯ Simple Consumer API ï¼Œå®é™…ä¸Šéå¸¸å¤æ‚ã€‚

- API æ§åˆ¶æ›´çµæ´»ï¼Œä¾‹å¦‚æ¶ˆæ¯é‡å¤è¯»å–ï¼Œæ¶ˆæ¯ offset è·³è¯»ï¼ŒExactly Once åŸè¯­ã€‚
- API æ›´å¤æ‚ï¼Œoffset ä¸å†é€æ˜ï¼Œéœ€è¦è‡ªå·±ç®¡ç†ï¼ŒBroker è‡ªåŠ¨å¤±è´¥è½¬ç§»éœ€è¦å¤„ç†ï¼Œå¢åŠ  Consumerã€Partitionã€Broker éœ€è¦è‡ªå·±åšè´Ÿè½½å‡è¡¡ã€‚

## Kafka çš„ç½‘ç»œæ¨¡å‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

Kafka åŸºäºé«˜ååç‡å’Œæ•ˆç‡è€ƒè™‘ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨ç¬¬ä¸‰æ–¹ç½‘ç»œæ¡†æ¶ï¼Œè€Œä¸”è‡ªå·±åŸºäº Java NIO å°è£…çš„ã€‚

ğŸ¦… **1ï¼‰KafkaClient ï¼Œå•çº¿ç¨‹ Selector æ¨¡å‹ã€‚**

[![KafkaClient](http://static2.iocoder.cn/00e8ec59cf40c62db53b4d66dc45e17c)](http://static2.iocoder.cn/00e8ec59cf40c62db53b4d66dc45e17c)KafkaClient

> å®é™…ä¸Šï¼Œå°±æ˜¯ NettyClient çš„ NIO æ–¹å¼ã€‚

- å•çº¿ç¨‹æ¨¡å¼é€‚ç”¨äºå¹¶å‘é“¾æ¥æ•°å°ï¼Œé€»è¾‘ç®€å•ï¼Œæ•°æ®é‡å°ã€‚
- åœ¨ Kafka ä¸­ï¼ŒConsumer å’Œ Producer éƒ½æ˜¯ä½¿ç”¨çš„ä¸Šé¢çš„å•çº¿ç¨‹æ¨¡å¼ã€‚è¿™ç§æ¨¡å¼ä¸é€‚åˆ Kafka çš„æœåŠ¡ç«¯ï¼Œåœ¨æœåŠ¡ç«¯ä¸­è¯·æ±‚å¤„ç†è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä¼šé€ æˆçº¿ç¨‹é˜»å¡ï¼Œä¸€æ—¦å‡ºç°åç»­è¯·æ±‚å°±ä¼šæ— æ³•å¤„ç†ï¼Œä¼šé€ æˆå¤§é‡è¯·æ±‚è¶…æ—¶ï¼Œå¼•èµ·é›ªå´©ã€‚è€Œåœ¨æœåŠ¡å™¨ä¸­åº”è¯¥å……åˆ†åˆ©ç”¨å¤šçº¿ç¨‹æ¥å¤„ç†æ‰§è¡Œé€»è¾‘ã€‚

ğŸ¦… **2ï¼‰KafkaServer ï¼Œå¤šçº¿ç¨‹ Selector æ¨¡å‹ã€‚**

> KafkaServer ï¼ŒæŒ‡çš„æ˜¯ Kafka Broker ã€‚

[![KafkaServer](http://static.iocoder.cn/8493bc98876609462fba617d520d1b9a)](http://static.iocoder.cn/8493bc98876609462fba617d520d1b9a)KafkaServer

Broker çš„å†…éƒ¨å¤„ç†æµæ°´çº¿åŒ–ï¼Œåˆ†ä¸ºå¤šä¸ªé˜¶æ®µæ¥è¿›è¡Œ(SEDA)ï¼Œä»¥æé«˜ååé‡å’Œæ€§èƒ½ï¼Œå°½é‡é¿å… Thead ç›²ç­‰å¾…ï¼Œä»¥ä¸‹ä¸ºè¿‡ç¨‹è¯´æ˜ã€‚

> å®é™…ä¸Šï¼Œå°±æ˜¯ NettyServer çš„ NIO æ–¹å¼ã€‚

- Accept Thread è´Ÿè´£ä¸å®¢æˆ·ç«¯å»ºç«‹è¿æ¥é“¾è·¯ï¼Œç„¶åæŠŠ Socket è½®è½¬äº¤ç»™Process Thread ã€‚

  > ç›¸å½“äº Netty çš„ Boss EventLoop ã€‚

- Process Thread è´Ÿè´£æ¥æ”¶è¯·æ±‚å’Œå“åº”æ•°æ®ï¼ŒProcess Thread æ¯æ¬¡åŸºäº Selector äº‹ä»¶å¾ªç¯ï¼Œé¦–å…ˆä» Response Queue è¯»å–å“åº”æ•°æ®ï¼Œå‘å®¢æˆ·ç«¯å›å¤å“åº”ï¼Œç„¶åæ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åï¼Œè¯»å–æ•°æ®æ”¾å…¥ Request Queue ã€‚

  > ç›¸å½“äº Netty çš„ Worker EventLoop ã€‚

- Work Thread è´Ÿè´£ä¸šåŠ¡é€»è¾‘ã€IO ç£ç›˜å¤„ç†ç­‰ï¼Œè´Ÿè´£ä» Request Queue è¯»å–è¯·æ±‚ï¼Œå¹¶æŠŠå¤„ç†ç»“æœæ”¾å…¥ Response Queue ä¸­ï¼Œå¾… Process Thread å‘é€å‡ºå»ã€‚

  > ç›¸å½“äºä¸šåŠ¡çº¿ç¨‹æ± ã€‚

ğŸ˜ˆ å®é™…ä¸Šï¼Œè‰¿è‰¿çš„æƒ³æ³•ï¼Œå¦‚æœè‡ªå·±å®ç° MQ ï¼Œå®Œå…¨å¯ä»¥ç›´æ¥ä½¿ç”¨ Netty ä½œä¸ºç½‘ç»œé€šä¿¡æ¡†æ¶ã€‚åŒ…æ‹¬ï¼ŒRocketMQ å°±æ˜¯å¦‚æ­¤å®ç°çš„ã€‚

ğŸ¦… **è§£é‡Šå¦‚ä½•æé«˜è¿œç¨‹ç”¨æˆ·çš„ååé‡?**

å¦‚æœ Producerã€Consumer ä½äºä¸ Broker ä¸åŒçš„æ•°æ®ä¸­å¿ƒï¼Œåˆ™å¯èƒ½éœ€è¦è°ƒä¼˜å¥—æ¥å£ç¼“å†²åŒºå¤§å°ï¼Œä»¥å¯¹é•¿ç½‘ç»œå»¶è¿Ÿè¿›è¡Œæ‘Šé”€ã€‚

## Kafka çš„æ•°æ®å­˜å‚¨æ¨¡å‹æ˜¯æ€ä¹ˆæ ·çš„?

Kafka æ¯ä¸ª Topic ä¸‹é¢çš„æ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¯ä»¥ Partition çš„æ–¹å¼åˆ†å¸ƒå¼çš„å­˜å‚¨åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šã€‚åŒæ—¶åœ¨ Kafka çš„æœºå™¨ä¸Šï¼Œæ¯ä¸ª Partition å…¶å®éƒ½ä¼šå¯¹åº”ä¸€ä¸ªæ—¥å¿—ç›®å½•ï¼Œåœ¨ç›®å½•ä¸‹é¢ä¼šå¯¹åº”å¤šä¸ªæ—¥å¿—åˆ†æ®µï¼ˆLogSegmentï¼‰ã€‚

```
MacBook-Pro-5:test-0 yunai$ ls
00000000000000000000.index	00000000000000000000.timeindex	leader-epoch-checkpoint
00000000000000000000.log	00000000000000000004.snapshot
```

- Topic ä¸º `test` ï¼ŒPartition ä¸º 0 ï¼Œæ‰€ä»¥æ–‡ä»¶ç›®å½•æ˜¯ `test-0` ã€‚

LogSegment æ–‡ä»¶ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«ä¸º `.index` æ–‡ä»¶å’Œ `.log` æ–‡ä»¶ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸º segment **ç´¢å¼•**æ–‡ä»¶å’Œ**æ•°æ®**æ–‡ä»¶ã€‚è¿™ä¸¤ä¸ªæ–‡ä»¶çš„å‘½ä»¤è§„åˆ™ä¸ºï¼šPartition å…¨å±€çš„ç¬¬ä¸€ä¸ª segment ä» 0 å¼€å§‹ï¼Œåç»­æ¯ä¸ª segment æ–‡ä»¶åä¸ºä¸Šä¸€ä¸ª segment æ–‡ä»¶æœ€åä¸€æ¡æ¶ˆæ¯çš„ offset å€¼ï¼Œæ•°å€¼å¤§å°ä¸º 64 ä½ï¼Œ20 ä½æ•°å­—å­—ç¬¦é•¿åº¦ï¼Œæ²¡æœ‰æ•°å­—ç”¨ 0 å¡«å……ï¼Œå¦‚ä¸‹ï¼Œå‡è®¾æœ‰ 1000 æ¡æ¶ˆæ¯ï¼Œæ¯ä¸ª LogSegment å¤§å°ä¸º 100 ï¼Œä¸‹é¢å±•ç°äº† 900-1000 çš„ `.index` å’Œ `.log` æ–‡ä»¶ï¼š

[`.index` å’Œ `.log` æ–‡ä»¶](https://user-gold-cdn.xitu.io/2018/7/24/164ca4f7e778be7c?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

- ç”±äº Kafka æ¶ˆæ¯æ•°æ®å¤ªå¤§ï¼Œå¦‚æœå…¨éƒ¨å»ºç«‹ç´¢å¼•ï¼Œå³å äº†ç©ºé—´åˆå¢åŠ äº†è€—æ—¶ï¼Œæ‰€ä»¥ Kafka é€‰æ‹©äº†ç¨€ç–ç´¢å¼•çš„æ–¹å¼ï¼ˆé€šè¿‡ `.index` ç´¢å¼• `.log` æ–‡ä»¶ï¼‰ï¼Œè¿™æ ·çš„è¯ç´¢å¼•å¯ä»¥ç›´æ¥è¿›å…¥å†…å­˜ï¼ŒåŠ å¿«åæŸ¥è¯¢é€Ÿåº¦ã€‚

ğŸ¦… **ç®€å•ä»‹ç»ä¸€ä¸‹å¦‚ä½•è¯»å–æ•°æ®ï¼Ÿ**

å¦‚æœæˆ‘ä»¬è¦è¯»å–ç¬¬ 911 æ¡æ•°æ®ã€‚

- é¦–å…ˆç¬¬ä¸€æ­¥ï¼Œæ‰¾åˆ°å®ƒæ˜¯å±äºå“ªä¸€æ®µçš„ï¼Œæ ¹æ®äºŒåˆ†æ³•æŸ¥æ‰¾åˆ°ä»–å±äºçš„æ–‡ä»¶ï¼Œæ‰¾åˆ° `0000900.index` å’Œ `00000900.log` ä¹‹åã€‚

- ç„¶åï¼Œå» `.index` ä¸­å»æŸ¥æ‰¾ `(911-900) =11` è¿™ä¸ªç´¢å¼•æˆ–è€…å°äº 11 æœ€è¿‘çš„ç´¢å¼•ï¼Œåœ¨è¿™é‡Œé€šè¿‡äºŒåˆ†æ³•æˆ‘ä»¬æ‰¾åˆ°äº†ç´¢å¼•æ˜¯ `[10,1367]` ã€‚

  > - 10 è¡¨ç¤ºï¼Œç¬¬ 10 æ¡æ¶ˆæ¯å¼€å§‹ã€‚
  > - 1367 è¡¨ç¤ºï¼Œåœ¨ `.log` çš„ç¬¬ 1367 å­—èŠ‚å¼€å§‹ã€‚
  >
  > ğŸ˜ˆ æ‰€ä»¥ï¼Œæœ¬å›¾çš„ç¬¬ 911 æ¡çš„â€œ1360â€æ˜¯é”™çš„ï¼Œç›¸æ¯”â€œ1367â€ åå€’å°äº†ã€‚

- ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡è¿™æ¡ç´¢å¼•çš„ç‰©ç†ä½ç½® 1367 ï¼Œå¼€å§‹å¾€åæ‰¾ï¼Œç›´åˆ°æ‰¾åˆ° 911 æ¡æ•°æ®ã€‚

ä¸Šé¢è®²çš„æ˜¯å¦‚æœè¦æ‰¾æŸä¸ª offset çš„æµç¨‹ï¼Œä½†æ˜¯æˆ‘ä»¬å¤§å¤šæ•°æ—¶å€™å¹¶ä¸éœ€è¦æŸ¥æ‰¾æŸä¸ª offset ï¼Œåªéœ€è¦æŒ‰ç…§é¡ºåºè¯»å³å¯ã€‚è€Œåœ¨é¡ºåºè¯»ä¸­ï¼Œæ“ä½œç³»ç»Ÿä¼šå¯¹å†…å­˜å’Œç£ç›˜ä¹‹é—´æ·»åŠ  page cahe ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³å¸¸è§åˆ°çš„é¢„è¯»æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬çš„é¡ºåºè¯»æ“ä½œæ—¶é€Ÿåº¦å¾ˆå¿«ã€‚ä½†æ˜¯ Kafka æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœåˆ†åŒºè¿‡å¤šï¼Œé‚£ä¹ˆæ—¥å¿—åˆ†æ®µä¹Ÿä¼šå¾ˆå¤šï¼Œå†™çš„æ—¶å€™ç”±äºæ˜¯æ‰¹é‡å†™ï¼Œå…¶å®å°±ä¼šå˜æˆéšæœºå†™äº†ï¼Œéšæœº I/O è¿™ä¸ªæ—¶å€™å¯¹æ€§èƒ½å½±å“å¾ˆå¤§ã€‚æ‰€ä»¥ä¸€èˆ¬æ¥è¯´ Kafka ä¸èƒ½æœ‰å¤ªå¤šçš„Partition ã€‚é’ˆå¯¹è¿™ä¸€ç‚¹ï¼ŒRocketMQ æŠŠæ‰€æœ‰çš„æ—¥å¿—éƒ½å†™åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œå°±èƒ½å˜æˆé¡ºåºå†™ï¼Œé€šè¿‡ä¸€å®šä¼˜åŒ–ï¼Œè¯»ä¹Ÿèƒ½æ¥è¿‘äºé¡ºåºè¯»ã€‚

> å¹¶ä¸”ï¼Œæˆªæ­¢åˆ° RocketMQ4 ç‰ˆæœ¬ï¼Œç´¢å¼•æ–‡ä»¶ï¼Œå¯¹æ¯ä¸ªæ•°æ®æ–‡ä»¶ä¸­çš„æ¶ˆæ¯ï¼Œéƒ½æœ‰å¯¹åº”çš„ç´¢å¼•ã€‚è¿™ä¸ªæ˜¯å’Œ Kafka çš„ç¨€ç–ç´¢å¼•ä¸å¤ªä¸€æ ·çš„åœ°æ–¹ã€‚

æ›´è¯¦å°½çš„ï¼Œæ¨èé˜…è¯» [ã€ŠKafka ä¹‹æ•°æ®å­˜å‚¨ã€‹](http://matt33.com/2016/03/08/kafka-store/) æ–‡ç« ã€‚

ğŸ¦… **ä¸ºä»€ä¹ˆä¸èƒ½ä»¥ Partition ä½œä¸ºå­˜å‚¨å•ä½ï¼Ÿ**

å¦‚æœå°±ä»¥ Partition ä¸ºæœ€å°å­˜å‚¨å•ä½ï¼Œå¯ä»¥æƒ³è±¡ï¼Œå½“ Kafka Producer ä¸æ–­å‘é€æ¶ˆæ¯ï¼Œå¿…ç„¶ä¼šå¼•èµ· Partition æ–‡ä»¶çš„æ— é™æ‰©å¼ ï¼Œå°†å¯¹æ¶ˆæ¯æ–‡ä»¶çš„ç»´æŠ¤ä»¥åŠå·²æ¶ˆè´¹çš„æ¶ˆæ¯çš„æ¸…ç†å¸¦æ¥ä¸¥é‡çš„å½±å“ï¼Œå› æ­¤ï¼Œéœ€ä»¥ segment ä¸ºå•ä½å°† Partition è¿›ä¸€æ­¥ç»†åˆ†ã€‚

æ¯ä¸ª Partitionï¼ˆç›®å½•ï¼‰ç›¸å½“äºä¸€ä¸ªå·¨å‹æ–‡ä»¶ï¼Œè¢«å¹³å‡åˆ†é…åˆ°å¤šä¸ªå¤§å°ç›¸ç­‰çš„ segmentï¼ˆæ®µï¼‰æ•°æ®æ–‡ä»¶ä¸­ï¼ˆæ¯ä¸ª segment æ–‡ä»¶ä¸­æ¶ˆæ¯æ•°é‡ä¸ä¸€å®šç›¸ç­‰ï¼‰ï¼Œè¿™ç§ç‰¹æ€§ä¹Ÿæ–¹ä¾¿ old segment çš„åˆ é™¤ï¼Œå³æ–¹ä¾¿å·²è¢«æ¶ˆè´¹çš„æ¶ˆæ¯çš„æ¸…ç†ï¼Œæé«˜ç£ç›˜çš„åˆ©ç”¨ç‡ã€‚æ¯ä¸ª Partition åªéœ€è¦æ”¯æŒé¡ºåºè¯»å†™å°±è¡Œï¼Œsegment çš„æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç”±æœåŠ¡ç«¯é…ç½®å‚æ•°ï¼ˆ`log.segment.bytes`ï¼Œ`log.roll.{ms,hours}` ç­‰è‹¥å¹²å‚æ•°ï¼‰å†³å®šã€‚

## Kafka çš„æ¶ˆæ¯æ ¼å¼æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

message ä¸­çš„ç‰©ç†ç»“æ„ä¸ºï¼š

[![message ç‰©ç†ç»“æ„](http://static2.iocoder.cn/a034ab2df1d5b67520432355e0bbf95b)](http://static2.iocoder.cn/a034ab2df1d5b67520432355e0bbf95b)message ç‰©ç†ç»“æ„

å‚æ•°è¯´æ˜ï¼š

| å…³é”®å­—              | è§£é‡Šè¯´æ˜                                                     |
| :------------------ | :----------------------------------------------------------- |
| 8 byte offset       | åœ¨parition(åˆ†åŒº)å†…çš„æ¯æ¡æ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªæœ‰åºçš„idå·ï¼Œè¿™ä¸ªidå·è¢«ç§°ä¸ºåç§»(offset),å®ƒå¯ä»¥å”¯ä¸€ç¡®å®šæ¯æ¡æ¶ˆæ¯åœ¨parition(åˆ†åŒº)å†…çš„ä½ç½®ã€‚å³offsetè¡¨ç¤ºpartiionçš„ç¬¬å¤šå°‘message |
| 4 byte message size | messageå¤§å°                                                  |
| 4 byte CRC32        | ç”¨crc32æ ¡éªŒmessage                                           |
| 1 byte â€œmagicâ€      | è¡¨ç¤ºæœ¬æ¬¡å‘å¸ƒKafkaæœåŠ¡ç¨‹åºåè®®ç‰ˆæœ¬å·                          |
| 1 byte â€œattributesâ€ | è¡¨ç¤ºä¸ºç‹¬ç«‹ç‰ˆæœ¬ã€æˆ–æ ‡è¯†å‹ç¼©ç±»å‹ã€æˆ–ç¼–ç ç±»å‹                   |
| 4 byte key length   | è¡¨ç¤ºkeyçš„é•¿åº¦,å½“keyä¸º-1æ—¶ï¼ŒK byte keyå­—æ®µä¸å¡«                |
| K byte key          | å¯é€‰                                                         |
| value bytes payload | è¡¨ç¤ºå®é™…æ¶ˆæ¯æ•°æ®                                             |

ä¸è¿‡ï¼Œè¿™æ˜¯æ—©æœŸ Kafka çš„ç‰ˆæœ¬ï¼Œæœ€æ–°ç‰ˆæœ¬çš„æ ¼å¼ï¼Œæ¨èé˜…è¯»å¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼š

- [ã€Šä¸€æ–‡çœ‹æ‡‚ Kafka æ¶ˆæ¯æ ¼å¼çš„æ¼”å˜ã€‹](http://www.iocoder.cn/Kafka/message-format/?vip)
- [ã€ŠKafka æ¶ˆæ¯æ ¼å¼ä¸­çš„å˜é•¿å­—æ®µï¼ˆVarintsï¼‰ã€‹](http://www.iocoder.cn/Kafka/varints/)

å½“ç„¶ï¼Œçœ‹æ‡‚è¿™ä¸ªæ•°æ®æ ¼å¼ï¼ŒåŸºæœ¬ä¹Ÿèƒ½çŸ¥é“æ¶ˆæ¯çš„å¤§ä½“æ ¼å¼ã€‚

## Kafka çš„å‰¯æœ¬æœºåˆ¶æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

Kafka çš„å‰¯æœ¬æœºåˆ¶ï¼Œæ˜¯å¤šä¸ª Broker èŠ‚ç‚¹å¯¹å…¶ä»–èŠ‚ç‚¹çš„ Topic åˆ†åŒºçš„æ—¥å¿—è¿›è¡Œå¤åˆ¶ã€‚å½“é›†ç¾¤ä¸­çš„æŸä¸ªèŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œè®¿é—®æ•…éšœèŠ‚ç‚¹çš„è¯·æ±‚ä¼šè¢«è½¬ç§»åˆ°å…¶ä»–æ­£å¸¸èŠ‚ç‚¹(è¿™ä¸€è¿‡ç¨‹é€šå¸¸å« Reblance)ï¼ŒKafka æ¯ä¸ªä¸»é¢˜çš„æ¯ä¸ªåˆ†åŒºéƒ½æœ‰ä¸€ä¸ªä¸»å‰¯æœ¬ä»¥åŠ 0 ä¸ªæˆ–è€…å¤šä¸ªå‰¯æœ¬ï¼Œå‰¯æœ¬ä¿æŒå’Œä¸»å‰¯æœ¬çš„æ•°æ®åŒæ­¥ï¼Œå½“ä¸»å‰¯æœ¬å‡ºæ•…éšœæ—¶å°±ä¼šè¢«æ›¿ä»£ã€‚

[![å‰¯æœ¬æœºåˆ¶](http://static2.iocoder.cn/1f42986437f76c108007e86a51ae1287)](http://static2.iocoder.cn/1f42986437f76c108007e86a51ae1287)å‰¯æœ¬æœºåˆ¶

> æ³¨æ„å“ˆï¼Œä¸‹é¢è¯´çš„ Leader æŒ‡çš„æ˜¯æ¯ä¸ª Topic çš„æŸä¸ªåˆ†åŒºçš„ Leader ï¼Œè€Œä¸æ˜¯ Broker é›†ç¾¤ä¸­çš„ã€é›†ç¾¤æ§åˆ¶å™¨ã€‘ã€‚

åœ¨ Kafka ä¸­å¹¶ä¸æ˜¯æ‰€æœ‰çš„å‰¯æœ¬éƒ½èƒ½è¢«æ‹¿æ¥æ›¿ä»£ä¸»å‰¯æœ¬ï¼Œæ‰€ä»¥åœ¨ Kafka çš„Leader èŠ‚ç‚¹ä¸­ç»´æŠ¤ç€ä¸€ä¸ª ISRï¼ˆIn sync Replicasï¼‰é›†åˆï¼Œç¿»è¯‘è¿‡æ¥ä¹Ÿå«æ­£åœ¨åŒæ­¥ä¸­é›†åˆï¼Œåœ¨è¿™ä¸ªé›†åˆä¸­çš„éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶:

- 1ã€èŠ‚ç‚¹å¿…é¡»å’Œ Zookeeper ä¿æŒè¿æ¥ã€‚
- 2ã€åœ¨åŒæ­¥çš„è¿‡ç¨‹ä¸­è¿™ä¸ªå‰¯æœ¬ä¸èƒ½è½åä¸»å‰¯æœ¬å¤ªå¤šã€‚

å¦å¤–è¿˜æœ‰ä¸ª ARï¼ˆAssigned Replicasï¼‰ç”¨æ¥æ ‡è¯†å‰¯æœ¬çš„å…¨é›†ï¼ŒOSR ç”¨æ¥è¡¨ç¤ºç”±äºè½åè¢«å‰”é™¤çš„å‰¯æœ¬é›†åˆï¼Œæ‰€ä»¥å…¬å¼å¦‚ä¸‹ï¼š

- ISR = Leader + æ²¡æœ‰è½åå¤ªå¤šçš„å‰¯æœ¬ã€‚
- AR = OSR + ISR ã€‚

è¿™é‡Œå…ˆè¦è¯´ä¸‹ä¸¤ä¸ªåè¯ï¼šHW å’Œ LEO ã€‚

- HWï¼ˆé«˜æ°´ä½ HighWatermarkï¼‰ï¼Œæ˜¯ Consumer èƒ½å¤Ÿçœ‹åˆ°çš„æ­¤ Partition çš„ä½ç½®ã€‚
- LEOï¼ˆlogEndOffsetï¼‰ï¼Œæ˜¯æ¯ä¸ª Partition çš„ log æœ€åä¸€æ¡ Message çš„ä½ç½®ã€‚
- HW èƒ½ä¿è¯ Leader æ‰€åœ¨çš„ Broker å¤±æ•ˆï¼Œè¯¥æ¶ˆæ¯ä»ç„¶å¯ä»¥ä»æ–°é€‰ä¸¾çš„Leader ä¸­è·å–ï¼Œä¸ä¼šé€ æˆæ¶ˆæ¯ä¸¢å¤±ã€‚

å½“ Producer å‘ Leader å‘é€æ•°æ®æ—¶ï¼Œå¯ä»¥é€šè¿‡`request.required.acks` å‚æ•°æ¥è®¾ç½®æ•°æ®å¯é æ€§çš„çº§åˆ«ï¼š

- 1ï¼ˆé»˜è®¤ï¼‰ï¼šè¿™æ„å‘³ç€ Producer åœ¨ ISR ä¸­çš„ Leader å·²æˆåŠŸæ”¶åˆ°çš„æ•°æ®å¹¶å¾—åˆ°ç¡®è®¤åå‘é€ä¸‹ä¸€æ¡ message ã€‚å¦‚æœ Leader å®•æœºäº†ï¼Œåˆ™ä¼šä¸¢å¤±æ•°æ®ã€‚
- 0ï¼šè¿™æ„å‘³ç€ Producer æ— éœ€ç­‰å¾…æ¥è‡ª Broker çš„ç¡®è®¤è€Œç»§ç»­å‘é€ä¸‹ä¸€æ‰¹æ¶ˆæ¯ã€‚è¿™ç§æƒ…å†µä¸‹æ•°æ®ä¼ è¾“æ•ˆç‡æœ€é«˜ï¼Œä½†æ˜¯æ•°æ®å¯é æ€§ç¡®æ˜¯æœ€ä½çš„ã€‚
- -1ï¼šProducer éœ€è¦ç­‰å¾… ISR ä¸­çš„æ‰€æœ‰ Follower éƒ½ç¡®è®¤æ¥æ”¶åˆ°æ•°æ®åæ‰ç®—ä¸€æ¬¡å‘é€å®Œæˆï¼Œå¯é æ€§æœ€é«˜ã€‚ä½†æ˜¯è¿™æ ·ä¹Ÿä¸èƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œæ¯”å¦‚å½“ ISR ä¸­åªæœ‰ Leader æ—¶(å…¶ä»–èŠ‚ç‚¹éƒ½å’Œ Zookeeper æ–­å¼€è¿æ¥ï¼Œæˆ–è€…éƒ½æ²¡è¿½ä¸Š)ï¼Œè¿™æ ·å°±å˜æˆäº† `acks=1` çš„æƒ…å†µã€‚

å…³äºè¿™å—è¯¦è¯¦ç»†çš„å†…å®¹ï¼Œæ¨èé˜…è¯»

- [ã€ŠKafka æ•°æ®å¯é æ€§æ·±åº¦è§£è¯»ã€‹](https://blog.csdn.net/u013256816/article/details/71091774) çš„ [ã€Œ3 é«˜å¯é æ€§å­˜å‚¨åˆ†æã€](http://svip.iocoder.cn/Kafka/Interview/#) å°èŠ‚
- [ã€ŠKafka é›†ç¾¤å†…å¤åˆ¶åŠŸèƒ½æ·±å…¥å‰–æã€‹](https://www.jianshu.com/p/03d6a335237f)

## ZooKeeper åœ¨ Kafka ä¸­èµ·åˆ°ä»€ä¹ˆä½œç”¨ï¼Ÿ

å…³äº ZooKeeper æ˜¯ä»€ä¹ˆï¼Œä¸äº†è§£çš„èƒ–å‹ï¼Œç›´æ¥å»çœ‹ [ã€Šç²¾å°½ Zookeeper é¢è¯•é¢˜ã€‹](http://svip.iocoder.cn/Zookeeper/Interview/) ã€‚

åœ¨åŸºäº Kafka çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼ŒZooKeeper çš„ä½œç”¨æœ‰ï¼š

- 1ã€Broker åœ¨ ZooKeeper ä¸­çš„æ³¨å†Œã€‚

- 2ã€Topic åœ¨ ZooKeeper ä¸­çš„æ³¨å†Œã€‚

- 3ã€Consumer åœ¨ ZooKeeper ä¸­çš„æ³¨å†Œã€‚

- 4ã€Producer è´Ÿè½½å‡è¡¡ã€‚

  > ä¸»è¦æŒ‡çš„æ˜¯ï¼ŒProducer ä» Zookeeper æ‹‰å– Topic å…ƒæ•°æ®ï¼Œä»è€Œèƒ½å¤Ÿå°†æ¶ˆæ¯å‘é€è´Ÿè½½å‡è¡¡åˆ°å¯¹åº” Topic çš„åˆ†åŒºä¸­ã€‚

- 5ã€Consumer è´Ÿè½½å‡è¡¡ã€‚

- 6ã€è®°å½•æ¶ˆè´¹è¿›åº¦ Offset ã€‚

  > Kafka å·²æ¨èå°† consumer çš„ Offset ä¿¡æ¯ä¿å­˜åœ¨ Kafka å†…éƒ¨çš„ Topic ä¸­ã€‚

- 7ã€è®°å½• Partition ä¸ Consumer çš„å…³ç³»ã€‚

å…¶å®ï¼Œæ€»ç»“èµ·æ¥ï¼Œå°±æ˜¯ä¸¤ç±»åŠŸèƒ½ï¼š

- Brokerã€Producerã€Consumer å’Œ Zookeeper çš„äº¤äº’ã€‚

  > å¯¹åº” 1ã€2ã€3ã€5 ã€‚

- ç›¸åº”çš„çŠ¶æ€å­˜å‚¨åˆ° Zookeeper ä¸­ã€‚

  > å¯¹åº” 4ã€6ã€7 ã€‚

è¯¦ç»†çš„æ¯ä¸€ç‚¹ï¼Œçœ‹ [ã€Šå†è°ˆåŸºäº Kafka å’Œ ZooKeeper çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—åŸç†ã€‹](https://gitbook.cn/books/5bc446269a9adf54c7ccb8bc/index.html) çš„ [ã€ŒKafka æ¶æ„ä¸­ ZooKeeper ä»¥æ€æ ·çš„å½¢å¼å­˜åœ¨ï¼Ÿã€](http://svip.iocoder.cn/Kafka/Interview/#) å°èŠ‚ã€‚

## Kafka å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ

åœ¨ [ã€ŒKafka çš„æ¶æ„æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿã€](http://svip.iocoder.cn/Kafka/Interview/#) é—®é¢˜ä¸­ï¼Œå·²ç»åŸºæœ¬å›ç­”äº†è¿™ä¸ªé—®é¢˜ã€‚

[Kafka é›†ç¾¤](https://segmentfault.com/img/bVbcmpm?w=776&h=436)

- Zookeeper éƒ¨ç½² 2N+1 èŠ‚ç‚¹ï¼Œå½¢æˆ Zookeeper é›†ç¾¤ï¼Œä¿è¯é«˜å¯ç”¨ã€‚

- Kafka Broker éƒ¨ç½²é›†ç¾¤ã€‚æ¯ä¸ª Topic çš„ Partition ï¼ŒåŸºäºã€å‰¯æœ¬æœºåˆ¶ã€‘ï¼Œåœ¨ Broker é›†ç¾¤ä¸­å¤åˆ¶ï¼Œå½¢æˆ replica å‰¯æœ¬ï¼Œä¿è¯æ¶ˆæ¯å­˜å‚¨çš„å¯é æ€§ã€‚æ¯ä¸ª replica å‰¯æœ¬ï¼Œéƒ½ä¼šé€‰æ‹©å‡ºä¸€ä¸ª leader åˆ†åŒºï¼ˆPartitionï¼‰ï¼Œæä¾›ç»™å®¢æˆ·ç«¯ï¼ˆProducer å’Œ Consumerï¼‰è¿›è¡Œè¯»å†™ã€‚

- Kafka Producer æ— éœ€è€ƒè™‘é›†ç¾¤ï¼Œå› ä¸ºå’Œä¸šåŠ¡æœåŠ¡éƒ¨ç½²åœ¨ä¸€èµ·ã€‚Producer ä» Zookeeper æ‹‰å–åˆ° Topic çš„å…ƒæ•°æ®åï¼Œé€‰æ‹©å¯¹åº”çš„ Topic çš„ leader åˆ†åŒºï¼Œè¿›è¡Œæ¶ˆæ¯å‘é€å†™å…¥ã€‚è€Œ Broker æ ¹æ® Producer çš„ `request.required.acks` é…ç½®ï¼Œæ˜¯å†™å…¥è‡ªå·±å®Œæˆå°±å“åº”ç»™ Producer æˆåŠŸï¼Œè¿˜æ˜¯å†™å…¥æ‰€æœ‰ Broker å®Œæˆå†å“åº”ã€‚è¿™ä¸ªï¼Œå°±æ˜¯èƒ–å‹è‡ªå·±å¯¹æ¶ˆæ¯çš„å¯é æ€§çš„é€‰æ‹©ã€‚

- Kafka Consumer éƒ¨ç½²é›†ç¾¤ã€‚æ¯ä¸ª Consumer åˆ†é…å…¶å¯¹åº”çš„ Topic Partition ï¼Œæ ¹æ®å¯¹åº”çš„åˆ†é…ç­–ç•¥ã€‚å¹¶ä¸”ï¼ŒConsumer åªä» leader åˆ†åŒºï¼ˆPartitionï¼‰æ‹‰å–æ¶ˆæ¯ã€‚å¦å¤–ï¼Œå½“æœ‰æ–°çš„ Consumer åŠ å…¥æˆ–è€…è€çš„ Consumer ç¦»å¼€ï¼Œéƒ½ä¼šå°† Topic Partition å†å‡è¡¡ï¼Œé‡æ–°åˆ†é…ç»™ Consumer ã€‚

  > æ³¨æ„å™¢ï¼Œæ­¤å¤„è¯´çš„éƒ½æ˜¯åŒä¸€ä¸ª Kafka Consumer group ã€‚

æ€»çš„æ¥è¯´ï¼ŒKafka å’Œ RocketMQ çš„é«˜å¯ç”¨æ–¹å¼æ˜¯æ¯”è¾ƒç±»ä¼¼çš„ï¼Œä¸»è¦çš„å·®å¼‚åœ¨ Kafka Broker çš„å‰¯æœ¬æœºåˆ¶ï¼Œå’Œ RocketMQ Broker çš„ä¸»ä»å¤åˆ¶ï¼Œä¸¤è€…çš„å·®å¼‚ï¼Œä»¥åŠå·®å¼‚å¸¦æ¥çš„ç”Ÿäº§å’Œæ¶ˆè´¹ä¸åŒã€‚ğŸ˜ˆ å½“ç„¶ï¼Œå®é™…ä¸Šï¼Œéƒ½æ˜¯å’Œâ€œä¸»â€ Broker åšæ¶ˆæ¯çš„å‘é€å’Œè¯»å–ä¸æ˜¯ï¼Ÿï¼

## ä»€ä¹ˆæ˜¯ Kafka äº‹åŠ¡ï¼Ÿ

æ¨èé˜…è¯» [ã€ŠKafka äº‹åŠ¡ç®€ä»‹ã€‹](https://blog.csdn.net/ransom0512/article/details/78840042) æ–‡ç« ã€‚

ğŸ˜ˆ å’Œæƒ³è±¡ä¸­çš„ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹å·®åˆ«ï¼Ÿï¼

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— Kafka å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ11. äº‹åŠ¡æ¶ˆæ¯ã€](http://svip.iocoder.cn/Kafka/Interview/#)å°èŠ‚ã€‚

## Kafka æ˜¯å¦ä¼šå¼„ä¸¢æ•°æ®ï¼Ÿ

> è‰¿è‰¿ï¼šæ³¨æ„ï¼ŒKafka æ˜¯å¦ä¼šä¸¢æ•°æ®ï¼Œä¸»è¦å–å†³äºæˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ã€‚è¿™ç‚¹ï¼Œéå¸¸é‡è¦å™¢ã€‚

ğŸ¦… **æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ®ï¼Ÿ**

å”¯ä¸€å¯èƒ½å¯¼è‡´æ¶ˆè´¹è€…å¼„ä¸¢æ•°æ®çš„æƒ…å†µï¼Œå°±æ˜¯è¯´ï¼Œä½ æ¶ˆè´¹åˆ°äº†è¿™ä¸ªæ¶ˆæ¯ï¼Œç„¶åæ¶ˆè´¹è€…é‚£è¾¹è‡ªåŠ¨æäº¤äº† offset ï¼Œè®© Broker ä»¥ä¸ºä½ å·²ç»æ¶ˆè´¹å¥½äº†è¿™ä¸ªæ¶ˆæ¯ï¼Œä½†å…¶å®ä½ æ‰åˆšå‡†å¤‡å¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œä½ è¿˜æ²¡å¤„ç†ï¼Œä½ è‡ªå·±å°±æŒ‚äº†ï¼Œæ­¤æ—¶è¿™æ¡æ¶ˆæ¯å°±ä¸¢å’¯ã€‚

è¿™ä¸æ˜¯è·Ÿ RabbitMQ å·®ä¸å¤šå—ï¼Œå¤§å®¶éƒ½çŸ¥é“ Kafka ä¼šè‡ªåŠ¨æäº¤ offset ï¼Œé‚£ä¹ˆåªè¦å…³é—­è‡ªåŠ¨æäº¤ offset ï¼Œåœ¨å¤„ç†å®Œä¹‹åè‡ªå·±æ‰‹åŠ¨æäº¤ offset ï¼Œå°±å¯ä»¥ä¿è¯æ•°æ®ä¸ä¼šä¸¢ã€‚ä½†æ˜¯æ­¤æ—¶ç¡®å®è¿˜æ˜¯å¯èƒ½ä¼šæœ‰é‡å¤æ¶ˆè´¹ï¼Œæ¯”å¦‚ä½ åˆšå¤„ç†å®Œï¼Œè¿˜æ²¡æäº¤ offset ï¼Œç»“æœè‡ªå·±æŒ‚äº†ï¼Œæ­¤æ—¶è‚¯å®šä¼šé‡å¤æ¶ˆè´¹ä¸€æ¬¡ï¼Œè‡ªå·±ä¿è¯å¹‚ç­‰æ€§å°±å¥½äº†ã€‚

> RocketMQ push æ¨¡å¼ä¸‹ï¼Œåœ¨ç¡®è®¤æ¶ˆæ¯è¢«æ¶ˆè´¹å®Œæˆï¼Œæ‰ä¼šæäº¤ Offset ç»™ Broker ã€‚

ç”Ÿäº§ç¯å¢ƒç¢°åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¯´æˆ‘ä»¬çš„ Kafka æ¶ˆè´¹è€…æ¶ˆè´¹åˆ°äº†æ•°æ®ä¹‹åæ˜¯å†™åˆ°ä¸€ä¸ªå†…å­˜çš„ queue é‡Œå…ˆç¼“å†²ä¸€ä¸‹ï¼Œç»“æœæœ‰çš„æ—¶å€™ï¼Œä½ åˆšæŠŠæ¶ˆæ¯å†™å…¥å†…å­˜ queue ï¼Œç„¶åæ¶ˆè´¹è€…ä¼šè‡ªåŠ¨æäº¤ offset ã€‚ç„¶åæ­¤æ—¶æˆ‘ä»¬é‡å¯äº†ç³»ç»Ÿï¼Œå°±ä¼šå¯¼è‡´å†…å­˜ queue é‡Œè¿˜æ²¡æ¥å¾—åŠå¤„ç†çš„æ•°æ®å°±ä¸¢å¤±äº†ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— Kafka å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ12. æ¶ˆè´¹è¿›åº¦çš„æäº¤æœºåˆ¶ã€](http://svip.iocoder.cn/Kafka/Interview/#)å°èŠ‚ã€‚

ğŸ¦… **Broker å¼„ä¸¢äº†æ•°æ®ï¼Ÿ**

è¿™å—æ¯”è¾ƒå¸¸è§çš„ä¸€ä¸ªåœºæ™¯ï¼Œå°±æ˜¯ Kafka æŸä¸ª Broker å®•æœºï¼Œç„¶åé‡æ–°é€‰ä¸¾ Partition çš„ leaderã€‚å¤§å®¶æƒ³æƒ³ï¼Œè¦æ˜¯æ­¤æ—¶å…¶ä»–çš„ follower åˆšå¥½è¿˜æœ‰äº›æ•°æ®æ²¡æœ‰åŒæ­¥ï¼Œç»“æœæ­¤æ—¶ leader æŒ‚äº†ï¼Œç„¶åé€‰ä¸¾æŸä¸ª follower æˆ leader ä¹‹åï¼Œä¸å°±å°‘äº†ä¸€äº›æ•°æ®ï¼Ÿè¿™å°±ä¸¢äº†ä¸€äº›æ•°æ®å•Šã€‚

ç”Ÿäº§ç¯å¢ƒä¹Ÿé‡åˆ°è¿‡ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯ï¼Œä¹‹å‰ Partition çš„ leader æœºå™¨å®•æœºäº†ï¼Œå°† follower åˆ‡æ¢ä¸º leader ä¹‹åï¼Œå°±ä¼šå‘ç°è¯´è¿™ä¸ªæ•°æ®å°±ä¸¢äº†ã€‚

æ‰€ä»¥æ­¤æ—¶ä¸€èˆ¬æ˜¯è¦æ±‚èµ·ç è®¾ç½®å¦‚ä¸‹ 4 ä¸ªå‚æ•°ï¼š

- ç»™ Topic è®¾ç½® `replication.factor` å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº 1ï¼Œè¦æ±‚æ¯ä¸ª partition å¿…é¡»æœ‰è‡³å°‘ 2 ä¸ªå‰¯æœ¬ã€‚

- åœ¨ Kafka æœåŠ¡ç«¯è®¾ç½® `min.insync.replicas` å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº 1 ï¼Œè¿™ä¸ªæ˜¯è¦æ±‚ä¸€ä¸ª leader è‡³å°‘æ„ŸçŸ¥åˆ°æœ‰è‡³å°‘ä¸€ä¸ª follower è¿˜è·Ÿè‡ªå·±ä¿æŒè”ç³»ï¼Œæ²¡æ‰é˜Ÿï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿ leader æŒ‚äº†è¿˜æœ‰ä¸€ä¸ª follower å§ã€‚

- åœ¨ Producer ç«¯è®¾ç½® `acks=all`ï¼šè¿™ä¸ªæ˜¯è¦æ±‚æ¯æ¡æ•°æ®ï¼Œå¿…é¡»æ˜¯**å†™å…¥æ‰€æœ‰ replica ä¹‹åï¼Œæ‰èƒ½è®¤ä¸ºæ˜¯å†™æˆåŠŸäº†**ã€‚

  > ä¸è¿‡è¿™ä¸ªä¹Ÿä¸ä¸€å®šèƒ½å¤Ÿç»å¯¹ä¿è¯ï¼Œä¾‹å¦‚è¯´ï¼ŒBroker é›†ç¾¤é‡Œï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æŒ‚äº†ï¼Œåªå‰©ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚æ­¤æ—¶ï¼Œ`acks=all` å’Œ `acks=1` å°±ç­‰ä»·äº†ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½® `min.insync.replics` å‚æ•°ï¼Œæ¯æ¬¡å†™å…¥è¦æ±‚æœ€å°çš„åŒæ­¥å‰¯æœ¬æ•°ã€‚
  >
  > è¿™å—ä¹Ÿå’Œæœ‹å‹äº¤æµäº†ä¸‹ï¼Œä»–ä»¬é‡‘èåœºæ™¯ä¸‹ï¼Œ`acks=all` ä¹Ÿæ˜¯è¿™ä¹ˆé…ç½®çš„ã€‚åŸå› å˜›ï¼Œå› ä¸ºä»–ä»¬æ˜¯é‡‘èåœºæ™¯å‘€ã€‚

- åœ¨ Producer ç«¯è®¾ç½® `retries=MAX`ï¼ˆå¾ˆå¤§å¾ˆå¤§å¾ˆå¤§çš„ä¸€ä¸ªå€¼ï¼Œæ— é™æ¬¡é‡è¯•çš„æ„æ€ï¼‰ï¼šè¿™ä¸ªæ˜¯**è¦æ±‚ä¸€æ—¦å†™å…¥å¤±è´¥ï¼Œå°±æ— é™é‡è¯•**ï¼Œå¡åœ¨è¿™é‡Œäº†ã€‚

æˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒå°±æ˜¯æŒ‰ç…§ä¸Šè¿°è¦æ±‚é…ç½®çš„ï¼Œè¿™æ ·é…ç½®ä¹‹åï¼Œè‡³å°‘åœ¨ Kafka broker ç«¯å°±å¯ä»¥ä¿è¯åœ¨ leader æ‰€åœ¨ Broker å‘ç”Ÿæ•…éšœï¼Œè¿›è¡Œ leader åˆ‡æ¢æ—¶ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚

ğŸ¦… **ç”Ÿäº§è€…ä¼šä¸ä¼šå¼„ä¸¢æ•°æ®ï¼Ÿ**

å¦‚æœæŒ‰ç…§ä¸Šè¿°çš„æ€è·¯è®¾ç½®äº† `acks=all` ï¼Œä¸€å®šä¸ä¼šä¸¢ï¼Œè¦æ±‚æ˜¯ï¼Œä½ çš„ leader æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œæ‰€æœ‰çš„ follower éƒ½åŒæ­¥åˆ°äº†æ¶ˆæ¯ä¹‹åï¼Œæ‰è®¤ä¸ºæœ¬æ¬¡å†™æˆåŠŸäº†ã€‚å¦‚æœæ²¡æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œç”Ÿäº§è€…ä¼šè‡ªåŠ¨ä¸æ–­çš„é‡è¯•ï¼Œé‡è¯•æ— é™æ¬¡ã€‚

- å…³äº Kafka Producer é‡è¯•å‘é€æ¶ˆæ¯çš„é€»è¾‘çš„æºç è§£æï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠKafka é‡è¯•æœºåˆ¶è§£è¯»ã€‹](https://www.jianshu.com/p/5bf9c7c02ada) ã€‚

------

ğŸ˜ˆ å¦å¤–ï¼Œåœ¨æ¨èä¸€ç¯‡æ–‡ç«  [ã€Š360 åº¦æµ‹è¯•ï¼šKAFKA ä¼šä¸¢æ•°æ®ä¹ˆï¼Ÿå…¶é«˜å¯ç”¨æ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Ÿã€‹](https://juejin.im/post/5bf8f2bee51d4507c12bc722) ï¼Œæä¾›äº†ä¸€äº›æµ‹è¯•ç¤ºä¾‹ã€‚

å…³äºè¿™ä¸€å—ï¼Œå¯ä»¥é‡ç‚¹çœ‹çœ‹ [ã€ŠKafka æƒå¨æŒ‡å—ã€‹](https://u.jd.com/jJpbF8) çš„ [ã€Œ6.4 åœ¨å¯é çš„ç³»ç»Ÿé‡Œä½¿ç”¨ç”Ÿäº§è€…ã€](http://svip.iocoder.cn/Kafka/Interview/#) å’Œ [ã€Œ6.5 åœ¨å¯é çš„ç³»ç»Ÿé‡Œä½¿ç”¨æ¶ˆè´¹è€…ã€](http://svip.iocoder.cn/Kafka/Interview/#) å°èŠ‚ã€‚

## Kafka å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ

Kafka æœ¬èº«ï¼Œå¹¶ä¸åƒ RocketMQ ä¸€æ ·ï¼Œæä¾›é¡ºåºæ€§çš„æ¶ˆæ¯ã€‚æ‰€ä»¥ï¼Œæä¾›çš„æ–¹æ¡ˆï¼Œéƒ½æ˜¯ç›¸å¯¹æœ‰æŸçš„ã€‚å¦‚ä¸‹ï¼š

> è¿™é‡Œçš„é¡ºåºæ¶ˆæ¯ï¼Œæˆ‘ä»¬æ›´å¤šæŒ‡çš„æ˜¯ï¼Œå•ä¸ª Partition çš„æ¶ˆæ¯ï¼Œè¢«é¡ºåºæ¶ˆè´¹ã€‚

- æ–¹å¼ä¸€ï¼ŒConsumer ï¼Œå¯¹æ¯ä¸ª Partition å†…éƒ¨å•çº¿ç¨‹æ¶ˆè´¹ï¼Œå•çº¿ç¨‹ååé‡å¤ªä½ï¼Œä¸€èˆ¬ä¸ä¼šç”¨è¿™ä¸ªã€‚

- æ–¹å¼äºŒï¼ŒConsumer ï¼Œæ‹‰å–åˆ°æ¶ˆæ¯åï¼Œå†™åˆ° N ä¸ªå†…å­˜ queueï¼Œå…·æœ‰ç›¸åŒ key çš„æ•°æ®éƒ½åˆ°åŒä¸€ä¸ªå†…å­˜ queue ã€‚ç„¶åï¼Œå¯¹äº N ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åˆ†åˆ«æ¶ˆè´¹ä¸€ä¸ªå†…å­˜ queue å³å¯ï¼Œè¿™æ ·å°±èƒ½ä¿è¯é¡ºåºæ€§ã€‚

  > è¿™ç§æ–¹å¼ï¼Œç›¸å½“äºå¯¹ã€æ–¹å¼ä¸€ã€‘çš„æ”¹è¿›ï¼Œå°†ç›¸åŒ Partition çš„æ¶ˆæ¯è¿›ä¸€æ­¥æ‹†åˆ†ï¼Œä¿è¯ç›¸åŒ key çš„æ•°æ®æ¶ˆè´¹æ˜¯é¡ºåºçš„ã€‚
  >
  > ä¸è¿‡è¿™ç§æ–¹å¼ï¼Œæ¶ˆè´¹è¿›åº¦çš„æ›´æ–°ä¼šæ¯”è¾ƒéº»çƒ¦ã€‚

å½“ç„¶ï¼Œå®é™…æƒ…å†µä¹Ÿä¸å¤ªéœ€è¦è€ƒè™‘æ¶ˆæ¯çš„é¡ºåºæ€§ï¼ŒåŸºæœ¬æ²¡æœ‰ä¸šåŠ¡éœ€è¦ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— Kafka å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ10. é¡ºåºæ¶ˆæ¯ã€](http://svip.iocoder.cn/Kafka/Interview/#)å°èŠ‚ã€‚

## 666. å½©è›‹

ğŸ˜ˆ ç•¥æ˜¾ä»“ä¿ƒçš„ä¸€ç¯‡æ–‡ç« ï¼Œåç»­ä¼šé‡æ–°åœ¨æ¢³ç†ä¸€ä¸‹ã€‚å¦‚æœèƒ–å‹å¯¹ Kafka æœ‰ä»€ä¹ˆç–‘æƒ‘ï¼Œä¸€å®šè¦åœ¨æ˜Ÿçƒé‡Œæå‡ºï¼Œæˆ‘ä»¬ä¸€èµ·åœ¨è®¨è®ºå’Œè§£ç­”ä¸€æ³¢ï¼Œç„¶åæ•´ç†åˆ°è¿™ç¯‡æ–‡ç« ä¸­ã€‚

åŒæ—¶ï¼ŒæœŸå¾…ä¸‹å®å¤§çš„ Kafka æ–°ä¹¦ã€‚

å‚è€ƒä¸æ¨èå¦‚ä¸‹æ–‡ç« ï¼š

- [ã€Šé«˜å¹¶å‘é¢è¯•å¿…é—®ï¼šåˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿ Kafka ç®€ä»‹ã€‹](https://blog.csdn.net/caisini_vc/article/details/48007297)

- [ã€Š14 ä¸ªæœ€å¸¸è§çš„ Kafka é¢è¯•é¢˜åŠç­”æ¡ˆã€‹](https://blog.csdn.net/yjh314/article/details/77568580)

  > è¿™ç¯‡åšå®¢ï¼Œæœ‰ç‚¹å‚»é€¼ã€‚ã€‚ã€‚ã€‚

- [ã€Šä½ éœ€è¦çŸ¥é“çš„ Kafkaã€‹](https://juejin.im/post/5b573eafe51d45198f5c80a4)

- [ã€ŠKafka å†…éƒ¨ç½‘ç»œæ¡†æ¶æ¨¡å‹åˆ†æã€‹](https://blog.csdn.net/lizhitao/article/details/52332749)

- [ã€Šå†è°ˆåŸºäº Kafka å’Œ ZooKeeper çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—åŸç†ã€‹](https://gitbook.cn/books/5bc446269a9adf54c7ccb8bc/index.html)

- [ã€Šå¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ä¼ è¾“ï¼Ÿï¼ˆå¦‚ä½•å¤„ç†æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜ï¼‰ã€‹](https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/how-to-ensure-the-reliable-transmission-of-messages.md)

**æ–‡ç« ç›®å½•**

1. [Apache Kafka æ˜¯ä»€ä¹ˆ?](http://svip.iocoder.cn/Kafka/Interview/#Apache-Kafka-æ˜¯ä»€ä¹ˆ)
2. [Kafka çš„æ¶æ„æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ](http://svip.iocoder.cn/Kafka/Interview/#Kafka-çš„æ¶æ„æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ)
3. [Kafka çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ](http://svip.iocoder.cn/Kafka/Interview/#Kafka-çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ)
4. [Kafka æ¶ˆæ¯å‘é€å’Œæ¶ˆè´¹çš„ç®€åŒ–æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ](http://svip.iocoder.cn/Kafka/Interview/#Kafka-æ¶ˆæ¯å‘é€å’Œæ¶ˆè´¹çš„ç®€åŒ–æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ)
5. [Kafka çš„ç½‘ç»œæ¨¡å‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ](http://svip.iocoder.cn/Kafka/Interview/#Kafka-çš„ç½‘ç»œæ¨¡å‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ)
6. [Kafka çš„æ•°æ®å­˜å‚¨æ¨¡å‹æ˜¯æ€ä¹ˆæ ·çš„?](http://svip.iocoder.cn/Kafka/Interview/#Kafka-çš„æ•°æ®å­˜å‚¨æ¨¡å‹æ˜¯æ€ä¹ˆæ ·çš„)
7. [Kafka çš„æ¶ˆæ¯æ ¼å¼æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ](http://svip.iocoder.cn/Kafka/Interview/#Kafka-çš„æ¶ˆæ¯æ ¼å¼æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ)
8. [Kafka çš„å‰¯æœ¬æœºåˆ¶æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ](http://svip.iocoder.cn/Kafka/Interview/#Kafka-çš„å‰¯æœ¬æœºåˆ¶æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ)
9. [ZooKeeper åœ¨ Kafka ä¸­èµ·åˆ°ä»€ä¹ˆä½œç”¨ï¼Ÿ](http://svip.iocoder.cn/Kafka/Interview/#ZooKeeper-åœ¨-Kafka-ä¸­èµ·åˆ°ä»€ä¹ˆä½œç”¨ï¼Ÿ)
10. [Kafka å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ](http://svip.iocoder.cn/Kafka/Interview/#Kafka-å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ)
11. [ä»€ä¹ˆæ˜¯ Kafka äº‹åŠ¡ï¼Ÿ](http://svip.iocoder.cn/Kafka/Interview/#ä»€ä¹ˆæ˜¯-Kafka-äº‹åŠ¡ï¼Ÿ)
12. [Kafka æ˜¯å¦ä¼šå¼„ä¸¢æ•°æ®ï¼Ÿ](http://svip.iocoder.cn/Kafka/Interview/#Kafka-æ˜¯å¦ä¼šå¼„ä¸¢æ•°æ®ï¼Ÿ)
13. [Kafka å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ](http://svip.iocoder.cn/Kafka/Interview/#Kafka-å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ)
14. [666. å½©è›‹](http://svip.iocoder.cn/Kafka/Interview/#666-å½©è›‹)

Â© 2014 - 2020 èŠ‹é“æºç  | 

æ€»è®¿å®¢æ•° 806807 æ¬¡ && æ€»è®¿é—®é‡ 3936675 æ¬¡

[å›åˆ°é¦–é¡µ](http://svip.iocoder.cn/index)