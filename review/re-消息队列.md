# 消息队列 

#### 消息队列

消息队列，是**分布式系统**中不可缺少的**中间件**。可实现**高性能**，**高可用**，**可伸缩和最终一致性架构**

目前主流的消息队列有

- Kafka
- RabbitMQ
- RocketMQ 
- ActiveMQ 

#### 角色

- 生产者（Producer）

- 消费者（Consumer

- 消息代理（Message Broker）：负责**存储消息**和**转发消息**两件事情。

  其中，**转发消息**分为推送和拉取两种方式。

  - **拉取**（Pull）
  - **推送**（Push）

#### 应用场景

- 应用解耦
  - 解耦：从主动调用的方式，变成了消息的订阅发布
- 异步处理
  - 串行调用变为异步，提升速度。
  - 前提，返回的结果不依赖于处理的结果。
- 流量削峰
  - 转发到消息队列中，慢慢处理。
  - 生产中，如果对时效没有要求，可以允许短暂的高峰期积压
- 消息通讯
  - 消息通讯
- 日志处理（异步处理）
  - 解决大量**日志传输**的问题（ELK+kafka）

#### 缺点

- 复杂度提高
  - 1）消息怎么不重复消息。
  - 2）消息怎么保证不丢失。
  - 3）需要消息顺序的业务场景，怎么处理。
- 可用性降低
- 一致性问题。**一定要达到数据的最终一致性**

#### 消费语义

1. 消息至多被消费一次（At most once）：消息可能会丢失，但绝不重传。

   - 吞吐量大，容忍消息丢失。
   - Message Broker不对接收到的消息响应确认
   - Message Broker转发不要求持久性，也不关心消费者是否真的收到
   - Message Broker消息被拿走就删除，不关心消费者，消费情况

2. 消息至少被消费一次（At least once）：消息可以重传，但绝不丢失。

   - Message Broker 必须响应对消息的确认，并提供持久性保障
   - 接收到消费者通知后，才删除消息。

3. 消息仅被消费一次（Exactly once）：每一条消息只被传递一次。

   - Message Broker 上存储的消息被 Consumer 仅消费一次。

     - Message Broker不对接收到的消息响应确认

     - Message Broker 提供持久性保障
     - 消息有唯一标识，消费者记录唯一标准，防止重复消费

   - Producer 上产生的消息被 Consumer 仅消费一次。

     - Message Broker对接收到的消息响应确认。 Producer 负责为该消息产生唯一标识，以防止 Consumer 重复消费
     - Message Broker 提供持久性保障，消息队列里有唯一标识
     - 消费者记录唯一标识，防止重复消费

#### 消息队列有几种投递方式？分别有什么优缺点

push

- 优点：即时
- 缺点：就是受限于消费者的消费能力，可能造成消息的堆积

