# Zookeeper 

## Zookeeper æ˜¯ä»€ä¹ˆï¼Ÿ

ZooKeeper æ˜¯ä¸€ä¸ª**é’ˆå¯¹å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿ**çš„å¼€æ”¾æºç çš„**åˆ†å¸ƒå¼åè°ƒç³»ç»Ÿï¼Œä½œç”¨çš„å¯¹è±¡æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå®ƒæ˜¯é›†ç¾¤çš„ç®¡ç†è€…**ï¼Œç›‘è§†ç€é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€æ ¹æ®èŠ‚ç‚¹æäº¤çš„åé¦ˆè¿›è¡Œä¸‹ä¸€æ­¥åˆç†æ“ä½œã€‚

åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºå¯ä»¥åŸºäº Zookeeper å®ç°

- æ•°æ®å‘å¸ƒ/è®¢é˜…
- **è´Ÿè½½å‡è¡¡**
- å‘½åæœåŠ¡
- **åˆ†å¸ƒå¼åè°ƒ/é€šçŸ¥**
- **é›†ç¾¤ç®¡ç†**
- **Master é€‰ä¸¾**
- **åˆ†å¸ƒå¼é”**
- åˆ†å¸ƒå¼é˜Ÿåˆ—
- **æ³¨å†Œä¸­å¿ƒ**
- ç­‰åŠŸèƒ½ã€‚

### Zookeeper ç‰¹æ€§

- **é¡ºåºä¸€è‡´æ€§(æœ‰åºæ€§)**

  > ä»åŒä¸€ä¸ªå®¢æˆ·ç«¯å‘èµ·çš„äº‹åŠ¡è¯·æ±‚ï¼Œæœ€ç»ˆå°†ä¼šä¸¥æ ¼åœ°æŒ‰ç…§å…¶å‘èµ·é¡ºåºè¢«åº”ç”¨åˆ° Zookeeper ä¸­å»ã€‚
  >
  > æœ‰åºæ€§æ˜¯ Zookeeper ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªç‰¹æ€§ã€‚
  >
  > - æ‰€æœ‰çš„æ›´æ–°éƒ½æ˜¯å…¨å±€æœ‰åºçš„ï¼Œ**æ¯ä¸ªæ›´æ–°éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´æˆ³**ï¼Œè¿™ä¸ªæ—¶é—´æˆ³ç§°ä¸º`zxid(Zookeeper Transaction Id)`ã€‚
  > - è€Œè¯»è¯·æ±‚åªä¼šç›¸å¯¹äºæ›´æ–°æœ‰åºï¼Œä¹Ÿå°±æ˜¯**è¯»è¯·æ±‚çš„è¿”å›ç»“æœä¸­ä¼šå¸¦æœ‰è¿™ä¸ª Zookeeper æœ€æ–°çš„ zxid** ã€‚

- åŸå­æ€§

  > æ‰€æœ‰**äº‹åŠ¡**è¯·æ±‚çš„å¤„ç†ç»“æœåœ¨æ•´ä¸ªé›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨ä¸Šçš„åº”ç”¨æƒ…å†µæ˜¯ä¸€è‡´çš„ï¼Œå³æ•´ä¸ªé›†ç¾¤è¦ä¹ˆéƒ½æˆåŠŸåº”ç”¨äº†æŸä¸ªäº‹åŠ¡ï¼Œè¦ä¹ˆéƒ½æ²¡æœ‰åº”ç”¨ã€‚

- å•ä¸€è§†å›¾

  > æ— è®ºå®¢æˆ·ç«¯è¿æ¥çš„æ˜¯å“ªä¸ª Zookeeper æœåŠ¡å™¨ï¼Œå…¶çœ‹åˆ°çš„æœåŠ¡ç«¯æ•°æ®æ¨¡å‹éƒ½æ˜¯ä¸€è‡´çš„ã€‚

- å¯é æ€§

  > ä¸€æ—¦æœåŠ¡ç«¯æˆåŠŸåœ°åº”ç”¨äº†ä¸€ä¸ªäº‹åŠ¡ï¼Œå¹¶å®Œæˆå¯¹å®¢æˆ·ç«¯çš„å“åº”ï¼Œé‚£ä¹ˆè¯¥äº‹åŠ¡æ‰€å¼•èµ·çš„æœåŠ¡ç«¯çŠ¶æ€å˜æ›´å°†ä¼šä¸€ç›´è¢«ä¿ç•™ï¼Œé™¤éæœ‰å¦ä¸€ä¸ªäº‹åŠ¡å¯¹å…¶è¿›è¡Œäº†å˜æ›´ã€‚

- å®æ—¶æ€§

  > Zookeeper ä¿è¯åœ¨ä¸€å®šçš„æ—¶é—´æ®µå†…ï¼Œå®¢æˆ·ç«¯æœ€ç»ˆä¸€å®šèƒ½å¤Ÿä»æœåŠ¡ç«¯ä¸Šè¯»å–åˆ°æœ€æ–°çš„æ•°æ®çŠ¶æ€ã€‚

### Zookeeper è¯»å†™è¯·æ±‚

- å®¢æˆ·ç«¯çš„è¯»è¯·æ±‚**å¯ä»¥è¢«é›†ç¾¤ä¸­çš„ä»»æ„ä¸€å°æœºå™¨å¤„ç†**ï¼Œå¦‚æœè¯»è¯·æ±‚åœ¨èŠ‚ç‚¹ä¸Šæ³¨å†Œäº†ç›‘å¬å™¨ï¼Œè¿™ä¸ªç›‘å¬å™¨ä¹Ÿæ˜¯ç”±æ‰€è¿æ¥çš„ Zookeeper æœºå™¨æ¥å¤„ç†ã€‚
- å¯¹äº**å†™è¯·æ±‚**ï¼Œè¿™äº›è¯·æ±‚ä¼š**åŒæ—¶å‘ç»™å…¶ä»– Zookeeper æœºå™¨å¹¶ä¸”è¾¾æˆä¸€è‡´å**ï¼Œè¯·æ±‚æ‰ä¼šè¿”å›æˆåŠŸã€‚å› æ­¤ï¼Œéšç€ Zookeeper çš„é›†ç¾¤æœºå™¨å¢å¤šï¼Œè¯»è¯·æ±‚çš„ååä¼šæé«˜ä½†æ˜¯å†™è¯·æ±‚çš„ååä¼šä¸‹é™ã€‚

### Chubby æ˜¯ä»€ä¹ˆï¼Ÿå’Œ Zookeeper å¯¹æ¯”ä½ æ€ä¹ˆçœ‹ï¼Ÿ

- Chubby æ˜¯ Google çš„ï¼Œå®Œå…¨å®ç° Paxos ç®—æ³•ï¼Œä¸å¼€æºã€‚
- Zookeeper æ˜¯ Chubby çš„å¼€æºå®ç°ï¼Œä½¿ç”¨ ZAB åè®®(Paxos ç®—æ³•çš„å˜ç§)ã€‚

### Zookeeper çš„ Java å®¢æˆ·ç«¯éƒ½æœ‰å“ªäº›ï¼Ÿ

- Zookeeper è‡ªå¸¦çš„ `zkclient`

- Apache å¼€æºçš„ `Curator`

  > å®é™…é¡¹ç›®ä¸­ï¼Œé‡‡ç”¨ Curator å±…å¤šã€‚å› ä¸ºï¼ŒåŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚

å…·ä½“çš„ä½¿ç”¨ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠZK å®¢æˆ·ç«¯æ“ä½œã€‹](https://www.zybuluo.com/boothsun/note/990793) æ–‡ç« ã€‚

Zookeeper æ²¡æœ‰ç‰¹åˆ«å¥½ç”¨çš„ GUI å·¥å…·ï¼Œå¯ä»¥çœ‹çœ‹ [ZooInspector](https://blog.52itstyle.com/archives/343/) ï¼Œå‡‘æ´»èƒ½ç”¨ã€‚

## Zookeeper çš„è®¾è®¡ç›®æ ‡ï¼Ÿ

- 1ã€**ç®€å•çš„æ•°æ®ç»“æ„**ï¼ŒZookeeper ä½¿å¾—åˆ†å¸ƒå¼ç¨‹åºèƒ½å¤Ÿé€šè¿‡ä¸€ä¸ªå…±äº«çš„**æ ‘å½¢ç»“æ„çš„åå­—ç©ºé—´**æ¥è¿›è¡Œç›¸äº’åè°ƒï¼Œå³ Zookeeper æœåŠ¡å™¨å†…å­˜ä¸­çš„æ•°æ®æ¨¡å‹ç”±ä¸€ç³»åˆ—è¢«ç§°ä¸º `ZNode` çš„æ•°æ®èŠ‚ç‚¹ç»„æˆï¼Œ**Zookeeper å°†å…¨é‡çš„æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­**ï¼Œä»¥æ­¤æ¥æé«˜æœåŠ¡å™¨ååã€å‡å°‘å»¶è¿Ÿçš„ç›®çš„ã€‚
- 2ã€å¯ä»¥æ„å»ºé›†ç¾¤ Zookeeper **é›†ç¾¤**é€šå¸¸ç”±ä¸€ç»„æœºå™¨æ„æˆï¼Œç»„æˆ Zookeeper é›†ç¾¤çš„è€Œæ¯å°æœºå™¨éƒ½ä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤å½“å‰æœåŠ¡å™¨çŠ¶æ€ï¼Œå¹¶ä¸”æ¯å°æœºå™¨ä¹‹é—´éƒ½ç›¸äº’é€šä¿¡ã€‚
- 3ã€**é¡ºåºè®¿é—®**ï¼Œå¯¹äºæ¥è‡ªå®¢æˆ·ç«¯çš„**æ¯ä¸ªæ›´æ–°è¯·æ±‚**ï¼ŒZookeeper éƒ½ä¼š**åˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„é€’å¢ç¼–å·**ï¼Œè¿™ä¸ªç¼–å·åæ˜ äº†æ‰€æœ‰äº‹åŠ¡æ“ä½œçš„å…ˆåé¡ºåºã€‚
- 4ã€**é«˜æ€§èƒ½**ï¼ŒZookeeper å’Œ Redis ä¸€æ ·å…¨é‡æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œ100%è¯»è¯·æ±‚å‹æµ‹ `QPS 12-13W` ã€‚

## Zookeeper æœ‰å“ªäº›åº”ç”¨åœºæ™¯ï¼Ÿ

Zookeeper çš„åŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œåº”ç”¨åœºæ™¯å¾ˆå¤šï¼Œç»“åˆæˆ‘ä»¬å®é™…å·¥ä½œä¸­ä½¿ç”¨ Dubbo æ¡†æ¶çš„æƒ…å†µï¼ŒZookeeper ä¸»è¦æ˜¯åš

- **æ³¨å†Œä¸­å¿ƒç”¨**ã€‚

- ç»Ÿä¸€å‘½åæœåŠ¡ï¼ˆæœåŠ¡åˆ—è¡¨ï¼‰ã€‚

  > å‘½åæœåŠ¡æ˜¯**æŒ‡é€šè¿‡æŒ‡å®šçš„åå­—æ¥è·å–èµ„æºæˆ–æœåŠ¡çš„åœ°å€**ï¼Œåˆ©ç”¨zkåˆ›å»ºä¸€ä¸ªå…¨å±€çš„è·¯å¾„ï¼Œå³æ—¶å”¯ä¸€çš„è·¯å¾„ï¼Œè¿™ä¸ªè·¯å¾„å°±å¯ä»¥ä½œä¸ºä¸€ä¸ªåå­—ï¼ŒæŒ‡å‘é›†ç¾¤ä¸­æœºå™¨æˆ–è€…æä¾›æœåŠ¡çš„åœ°å€ï¼Œåˆæˆ–è€…ä¸€ä¸ªè¿œç¨‹çš„å¯¹è±¡ç­‰ã€‚

- åˆ†å¸ƒå¼é”æœåŠ¡ã€‚

  > è¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ï¼ŒZookeeper å®ç°çš„åˆ†å¸ƒå¼é”çš„**å¯é æ€§**ä¼šæ¯” Redis å®ç°çš„åˆ†å¸ƒå¼é”**é«˜**ï¼Œå½“ç„¶ç›¸å¯¹æ¥è¯´ï¼Œ**æ€§èƒ½ä¼šä½**ã€‚

- **é…ç½®ç®¡ç†(é…ç½®ä¸­å¿ƒ)**ã€‚

  > ä¾‹å¦‚è¯´ï¼Œ[Spring Cloud Config Zookeeper](https://blog.csdn.net/CSDN_Stephen/article/details/78856323) ï¼Œå°±å®ç°äº†åŸºäº Zookeeper çš„ Spring Cloud Config çš„å®ç°ï¼Œæä¾›é…ç½®ä¸­å¿ƒçš„æœåŠ¡ã€‚

- **é›†ç¾¤ç®¡ç†ï¼ˆæ³¨å†Œä¸å‘ç°ï¼‰**ã€‚

  > æ˜¯å¦æœ‰æœºå™¨åŠ å…¥æˆ–é€€å‡º
  >
  > æ‰€æœ‰æœºå™¨çº¦å®šåœ¨çˆ¶ç›®å½•ä¸‹åˆ›å»ºä¸´æ—¶ç›®å½•èŠ‚ç‚¹ï¼Œç„¶åç›‘å¬çˆ¶ç›®å½•èŠ‚ç‚¹ä¸‹çš„å­èŠ‚ç‚¹å˜åŒ–ã€‚ä¸€æ—¦æœ‰æœºå™¨æŒ‚æ‰ï¼Œè¯¥æœºå™¨ä¸ ZooKeeper çš„è¿æ¥æ–­å¼€ï¼Œå…¶æ‰€åˆ›å»ºçš„ä¸´æ—¶ç›®å½•èŠ‚ç‚¹ä¹Ÿè¢«åˆ é™¤ï¼Œæ‰€æœ‰å…¶ä»–æœºå™¨éƒ½æ”¶åˆ°é€šçŸ¥ï¼šæŸä¸ªèŠ‚ç‚¹è¢«åˆ é™¤äº†ã€‚

- **Master é€‰ä¸¾**ã€‚

  > åŸºäº Zookeeper **å®ç°åˆ†å¸ƒå¼åè°ƒï¼Œä»è€Œå®ç°ä¸»ä»çš„é€‰ä¸¾**ã€‚è¿™ä¸ªåœ¨ Kafkaã€Elastic-Job ç­‰ç­‰ä¸­é—´ä»¶ï¼Œéƒ½æœ‰æ‰€ä½¿ç”¨åˆ°ã€‚

- **åˆ†å¸ƒå¼é”**ã€‚

  > æœ‰äº† **ZooKeeper çš„ä¸€è‡´æ€§æ–‡ä»¶ç³»ç»Ÿ**ï¼Œé”çš„é—®é¢˜å˜å¾—å®¹æ˜“ã€‚é”æœåŠ¡å¯ä»¥åˆ†æˆä¸¤ç±»ï¼Œä¸€ä¸ªæ˜¯ä¿æŒç‹¬å ï¼Œå¦ä¸€ä¸ªæ˜¯æ§åˆ¶æ—¶åºã€‚
  >
  > - 1ã€**ä¿æŒç‹¬å **ï¼Œæˆ‘ä»¬**æŠŠ znode çœ‹ä½œæ˜¯ä¸€æŠŠé”ï¼Œé€šè¿‡ createZnode çš„æ–¹å¼æ¥å®ç°**ã€‚æ‰€æœ‰å®¢æˆ·ç«¯éƒ½å»åˆ›å»º `/distribute_lock` èŠ‚ç‚¹ï¼Œæœ€ç»ˆæˆåŠŸåˆ›å»ºçš„é‚£ä¸ªå®¢æˆ·ç«¯ä¹Ÿå³æ‹¥æœ‰äº†è¿™æŠŠé”ã€‚ç”¨å®Œåˆ é™¤æ‰è‡ªå·±åˆ›å»ºçš„ `/distribute_lock` èŠ‚ç‚¹å°±é‡Šæ”¾å‡ºé”ã€‚
  > - 2ã€**æ§åˆ¶æ—¶åº**ï¼Œ`/distribute_lock` å·²ç»é¢„å…ˆå­˜åœ¨ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯åœ¨å®ƒä¸‹é¢åˆ›å»º**ä¸´æ—¶é¡ºåºç¼–å·ç›®å½•èŠ‚ç‚¹ï¼Œå’Œ Master ä¸€æ ·ï¼Œç¼–å·æœ€å°çš„è·å¾—é”ï¼Œç”¨å®Œåˆ é™¤**ï¼Œä¾æ¬¡æ–¹ä¾¿ã€‚

- é˜Ÿåˆ—ç®¡ç†

  > ä¸¤ç§ç±»å‹çš„é˜Ÿåˆ—ã€‚
  >
  > - 1ã€åŒæ­¥é˜Ÿåˆ—ï¼Œå½“ä¸€ä¸ªé˜Ÿåˆ—çš„**æˆå‘˜éƒ½èšé½**æ—¶ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ‰å¯ç”¨ï¼Œå¦åˆ™ä¸€ç›´ç­‰å¾…ã€‚åœ¨çº¦å®šçš„ç›®å½•ä¸‹åˆ›**å»ºä¸´æ—¶ç›®å½•èŠ‚ç‚¹**ï¼Œ**ç›‘å¬èŠ‚ç‚¹æ•°ç›®**æ˜¯å¦æ˜¯æˆ‘ä»¬è¦æ±‚çš„æ•°ç›®ã€‚
  > - 2ã€é˜Ÿåˆ—æŒ‰ç…§ `FIFO` æ–¹å¼è¿›è¡Œå…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œã€‚å’Œåˆ†å¸ƒå¼é”æœåŠ¡ä¸­çš„æ§åˆ¶æ—¶åºçš„åœºæ™¯åŸºæœ¬åŸç†ä¸€è‡´ï¼Œ`å…¥åˆ—æœ‰ç¼–å·ï¼Œå‡ºåˆ—æŒ‰ç¼–å·`ã€‚åˆ›å»º PERSISTENT_SEQUENTIAL èŠ‚ç‚¹ï¼Œåˆ›å»ºæˆåŠŸæ—¶ `Watcher é€šçŸ¥ç­‰å¾…`çš„é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—åˆ é™¤åºåˆ—å·æœ€å°çš„èŠ‚ç‚¹ä»¥æ¶ˆè´¹ã€‚æ­¤åœºæ™¯ä¸‹ï¼Œ`znode ç”¨äºæ¶ˆæ¯å­˜å‚¨`ï¼Œznode å­˜å‚¨çš„æ•°æ®å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å†…å®¹ï¼ŒSEQUENTIAL åºåˆ—å·å°±æ˜¯æ¶ˆæ¯çš„ç¼–å·ï¼ŒæŒ‰åºå–å‡ºå³å¯ã€‚ç”±äºåˆ›å»ºçš„èŠ‚ç‚¹æ˜¯æŒä¹…åŒ–çš„ï¼Œæ‰€ä»¥ä¸å¿…æ‹…å¿ƒé˜Ÿåˆ—æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜ã€‚

å½“ç„¶ï¼Œè¯¦ç»†çš„å¯ä»¥çœ‹çœ‹ [ã€ŠZookeeper æŠ€æœ¯æµ…æã€‹](http://www.cnblogs.com/sharpxiajun/archive/2013/06/02/3113923.html) æ–‡ç« ã€‚å¦å¤–ï¼Œè¯¥é—®å¯¹ Zookeeper çš„â€œç‰¹ç‚¹â€ä»‹ç»ï¼Œä¹Ÿè¦é‡ç‚¹çœ‹çœ‹ã€‚

ğŸ˜ˆ ä¸Šè¿°çš„å¾ˆå¤šåŠŸèƒ½ï¼Œåœ¨ Apache Curator å·²ç»é»˜è®¤æä¾›å®ç°äº†ï¼Œç›´æ¥è°ƒç”¨ API å³å¯ä½¿ç”¨ã€‚

### ä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼ŒEureka æ¯” Zookeeper å¥½åœ¨å“ªé‡Œï¼Ÿ

å‚è§ [ã€Šä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼ŒEureka æ¯” Zookeeper å¥½åœ¨å“ªé‡Œã€‹](https://blog.csdn.net/xuyw10000/article/details/79851697) æ–‡ç« ã€‚

æ¯”è¾ƒé‡è¦çš„åŸå› æ˜¯ï¼Œæ³¨å†Œä¸­å¿ƒå¯¹å¯ç”¨æ€§æ¯”ä¸€è‡´æ€§æœ‰æ›´é«˜çš„è¦æ±‚ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œèƒ½å¤Ÿå®¹å¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼Œè¯»å–åˆ°å‡ åˆ†é’Ÿå‰çš„æ•°æ®ã€‚

## Zookeeper æä¾›äº†ä»€ä¹ˆï¼Ÿ 

- **1ã€æ–‡ä»¶ç³»ç»Ÿ**ã€‚
- **2ã€é€šçŸ¥æœºåˆ¶**ã€‚

## Zookeeper çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Ÿ

Zookeeper æä¾›**ä¸€ä¸ªå¤šå±‚çº§çš„èŠ‚ç‚¹å‘½åç©ºé—´(èŠ‚ç‚¹ç§°ä¸º znode)**ã€‚ä¸æ–‡ä»¶ç³»ç»Ÿä¸åŒçš„æ˜¯ï¼Œè¿™äº›**èŠ‚ç‚¹éƒ½å¯ä»¥è®¾ç½®å…³è”çš„æ•°æ®**ï¼Œè€Œæ–‡ä»¶ç³»ç»Ÿä¸­åªæœ‰æ–‡ä»¶èŠ‚ç‚¹å¯ä»¥å­˜æ”¾æ•°æ®è€Œç›®å½•èŠ‚ç‚¹ä¸è¡Œã€‚

Zookeeper ä¸ºäº†ä¿è¯é«˜ååå’Œä½å»¶è¿Ÿï¼Œåœ¨å†…å­˜ä¸­ç»´æŠ¤äº†è¿™ä¸ªæ ‘çŠ¶çš„ç›®å½•ç»“æ„ï¼Œè¿™ç§ç‰¹æ€§ä½¿å¾— Zookeeper ä¸èƒ½ç”¨äºå­˜æ”¾å¤§é‡çš„æ•°æ®ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„å­˜æ”¾æ•°æ®ä¸Šé™ä¸º 1M ã€‚

ğŸ¦… **Zookeeper æœ‰å“ªå‡ ç§èŠ‚ç‚¹ç±»å‹ï¼Ÿ**

- PERSISTENT æŒä¹…èŠ‚ç‚¹

  > åˆ›å»ºä¹‹åä¸€ç›´å­˜åœ¨ï¼Œé™¤éæœ‰åˆ é™¤æ“ä½œï¼Œåˆ›å»ºèŠ‚ç‚¹çš„å®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆä¹Ÿä¸å½±å“æ­¤èŠ‚ç‚¹ã€‚

- PERSISTENT_SEQUENTIAL æŒä¹…é¡ºåºèŠ‚ç‚¹

  > è·ŸæŒä¹…ä¸€æ ·ï¼Œå°±æ˜¯çˆ¶èŠ‚ç‚¹åœ¨åˆ›å»ºä¸‹ä¸€çº§å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œè®°å½•æ¯ä¸ªå­èŠ‚ç‚¹åˆ›å»ºçš„å…ˆåé¡ºåºï¼Œä¼šç»™æ¯ä¸ªå­èŠ‚ç‚¹ååŠ ä¸Šä¸€ä¸ªæ•°å­—åç¼€ã€‚

- EPHEMERAL ä¸´æ—¶èŠ‚ç‚¹

  > åˆ›å»ºå®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆï¼ˆæ³¨æ„æ˜¯ä¼šè¯å¤±æ•ˆï¼Œä¸æ˜¯è¿æ¥æ–­äº†ï¼‰ï¼ŒèŠ‚ç‚¹ä¹Ÿå°±æ²¡äº†ã€‚ä¸èƒ½å»ºå­èŠ‚ç‚¹ã€‚

- EPHEMERAL_SEQUENTIAL ä¸´æ—¶é¡ºåºèŠ‚ç‚¹

  > åŸºæœ¬ç‰¹æ€§åŒä¸´æ—¶èŠ‚ç‚¹ï¼Œå¢åŠ äº†é¡ºåºå±æ€§ï¼ŒèŠ‚ç‚¹ååè¾¹ä¼šè¿½åŠ ä¸€ä¸ªç”±çˆ¶èŠ‚ç‚¹ç»´æŠ¤çš„è‡ªå¢æ•´å‹æ•°å­—ã€‚

å¦‚ä¸‹æ˜¯è‰¿è‰¿æ•´ç†çš„ Elastic-Job-Lite ä½¿ç”¨ Zookeeper ä½œä¸ºå­˜å‚¨çš„æ˜ç»†ï¼š[![Elastic-Job-Lite è¯¦ç»†](http://static2.iocoder.cn/images/Elastic-Job/2017_10_07/02.png)](http://static2.iocoder.cn/images/Elastic-Job/2017_10_07/02.png)Elastic-Job-Lite è¯¦ç»†

## Zookeeper çš„é€šçŸ¥æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ

Zookeeper å…è®¸å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯çš„æŸä¸ª znode æ³¨å†Œä¸€ä¸ª Watcher ç›‘å¬ï¼Œå½“æœåŠ¡ç«¯çš„ä¸€äº›æŒ‡å®šäº‹ä»¶è§¦å‘äº†è¿™ä¸ª Watcher ï¼ŒæœåŠ¡ç«¯ä¼šå‘æŒ‡å®šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªäº‹ä»¶é€šçŸ¥æ¥å®ç°åˆ†å¸ƒå¼çš„é€šçŸ¥åŠŸèƒ½ï¼Œç„¶åå®¢æˆ·ç«¯æ ¹æ® Watcher é€šçŸ¥çŠ¶æ€å’Œäº‹ä»¶ç±»å‹åšå‡ºä¸šåŠ¡ä¸Šçš„æ”¹å˜ã€‚

æ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š

> å…·ä½“çš„è¿‡ç¨‹ï¼Œä¸‹é¢æ¯ä¸ªå°é—®é¢˜ï¼Œè¿›è¡Œè¯´æ˜ã€‚

- ç¬¬ä¸€æ­¥ï¼Œå®¢æˆ·ç«¯æ³¨å†Œ Watcher ã€‚
- ç¬¬äºŒæ­¥ï¼ŒæœåŠ¡ç«¯å¤„ç† Watcher ã€‚
- ç¬¬ä¸‰æ­¥ï¼Œå®¢æˆ·ç«¯å›è°ƒ Watcher ã€‚

Watcher çš„ç‰¹æ€§æ€»ç»“ï¼š

- 1ã€ä¸€æ¬¡æ€§ã€‚

  > æ— è®ºæ˜¯æœåŠ¡ç«¯è¿˜æ˜¯å®¢æˆ·ç«¯ï¼Œä¸€æ—¦ä¸€ä¸ª Watcher è¢«è§¦å‘ï¼Œ Zookeeper éƒ½ä¼šå°†å…¶ä»ç›¸åº”çš„å­˜å‚¨ä¸­ç§»é™¤ã€‚è¿™æ ·çš„è®¾è®¡æœ‰æ•ˆçš„å‡è½»äº†æœåŠ¡ç«¯çš„å‹åŠ›ï¼Œä¸ç„¶å¯¹äºæ›´æ–°éå¸¸é¢‘ç¹çš„èŠ‚ç‚¹ï¼ŒæœåŠ¡ç«¯ä¼šä¸æ–­çš„å‘å®¢æˆ·ç«¯å‘é€äº‹ä»¶é€šçŸ¥ï¼Œæ— è®ºå¯¹äºç½‘ç»œè¿˜æ˜¯æœåŠ¡ç«¯çš„å‹åŠ›éƒ½éå¸¸å¤§ã€‚
  >
  > ğŸ˜ˆ æ³¨æ„å“Ÿï¼Œè¿™ä¸ªç‰¹æ€§å¯ä»¥å˜æˆä¸€ä¸ªé¢è¯•é¢˜ã€ŒZookeeper å¯¹èŠ‚ç‚¹çš„ watch ç›‘å¬é€šçŸ¥æ˜¯æ°¸ä¹…çš„å—ï¼Ÿã€ã€‚
  >
  > å¦‚æœæˆ‘ä»¬ä½¿ç”¨ [Apache Curator](https://curator.apache.org/) ä½œä¸ºæ“ä½œ Zookeeper çš„å®¢æˆ·ç«¯ï¼Œå®ƒå¯ä»¥å¸®æˆ‘ä»¬è‡ªåŠ¨é€æ˜çš„å®ç°æŒç»­çš„ watch æ“ä½œï¼Œéå¸¸æ–¹ä¾¿ã€‚

- 2ã€å®¢æˆ·ç«¯ä¸²è¡Œæ‰§è¡Œã€‚

  > å®¢æˆ·ç«¯ Watcher å›è°ƒçš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªä¸²è¡ŒåŒæ­¥çš„è¿‡ç¨‹ã€‚

- 3ã€è½»é‡çº§ Watch æœºåˆ¶ã€‚

  > - Watcher é€šçŸ¥éå¸¸ç®€å•ï¼Œåªä¼šå‘Šè¯‰å®¢æˆ·ç«¯å‘ç”Ÿäº†äº‹ä»¶ï¼Œè€Œä¸ä¼šè¯´æ˜äº‹ä»¶çš„å…·ä½“å†…å®¹ã€‚
  > - å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯æ³¨å†Œ Watcher çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šæŠŠå®¢æˆ·ç«¯çœŸå®çš„ Watcher å¯¹è±¡å®ä½“ä¼ é€’åˆ°æœåŠ¡ç«¯ï¼Œä»…ä»…æ˜¯åœ¨å®¢æˆ·ç«¯è¯·æ±‚ä¸­ä½¿ç”¨`boolean` ç±»å‹å±æ€§è¿›è¡Œäº†æ ‡è®°ã€‚

- 4ã€Watcher event å¼‚æ­¥å‘é€ Watcher çš„é€šçŸ¥äº‹ä»¶ä» Server å‘é€åˆ°Client æ˜¯å¼‚æ­¥çš„ï¼Œè¿™å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œä¸åŒçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´é€šè¿‡Socket è¿›è¡Œé€šä¿¡ï¼Œç”±äºç½‘ç»œå»¶è¿Ÿæˆ–å…¶ä»–å› ç´ å¯¼è‡´å®¢æˆ·ç«¯åœ¨ä¸é€šçš„æ—¶åˆ»ç›‘å¬åˆ°äº‹ä»¶ï¼Œç”±äº Zookeeper æœ¬èº«æä¾›äº† ordering guarantee ï¼Œå³å®¢æˆ·ç«¯ç›‘å¬äº‹ä»¶åï¼Œæ‰ä¼šæ„ŸçŸ¥å®ƒæ‰€ç›‘è§† znode å‘ç”Ÿäº†å˜åŒ–ã€‚æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ Zookeeper ä¸èƒ½æœŸæœ›èƒ½å¤Ÿç›‘æ§åˆ°èŠ‚ç‚¹æ¯æ¬¡çš„å˜åŒ–ã€‚**Zookeeper åªèƒ½ä¿è¯æœ€ç»ˆçš„ä¸€è‡´æ€§ï¼Œè€Œæ— æ³•ä¿è¯å¼ºä¸€è‡´æ€§**ã€‚

- 5ã€å¯ä»¥æ³¨å†Œ Watcher çš„æ“ä½œï¼šgetDataã€existsã€getChildren ã€‚

- 6ã€å¯ä»¥è§¦å‘ Watcher çš„æ“ä½œï¼šcreateã€deleteã€setData ã€‚

- 7ã€å½“ä¸€ä¸ª Client è¿æ¥åˆ°ä¸€ä¸ªæ–°çš„æœåŠ¡å™¨ä¸Šæ—¶ï¼Œwatch å°†ä¼šè¢«ä»¥ä»»æ„ä¼šè¯äº‹ä»¶è§¦å‘ã€‚å½“ä¸ä¸€ä¸ªæœåŠ¡å™¨å¤±å»è¿æ¥çš„æ—¶å€™ï¼Œæ˜¯æ— æ³•æ¥æ”¶åˆ° watch çš„ã€‚è€Œå½“ Client é‡æ–°è¿æ¥æ—¶ï¼Œå¦‚æœéœ€è¦çš„è¯ï¼Œæ‰€æœ‰å…ˆå‰æ³¨å†Œè¿‡çš„watch ï¼Œéƒ½ä¼šè¢«é‡æ–°æ³¨å†Œã€‚é€šå¸¸è¿™æ˜¯å®Œå…¨é€æ˜çš„ã€‚åªæœ‰åœ¨ä¸€ä¸ªç‰¹æ®Šæƒ…å†µä¸‹ï¼Œwatch å¯èƒ½ä¼šä¸¢å¤±ï¼šå¯¹äºä¸€ä¸ªæœªåˆ›å»ºçš„ znode çš„ exists watch ï¼Œå¦‚æœåœ¨å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æœŸé—´è¢«åˆ›å»ºäº†ï¼Œå¹¶ä¸”éšååœ¨å®¢æˆ·ç«¯è¿æ¥ä¸Šä¹‹å‰åˆåˆ é™¤äº†ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œè¿™ä¸ª watch äº‹ä»¶å¯èƒ½ä¼šè¢«ä¸¢å¤±ã€‚

ğŸ˜ˆ çœ‹äº†è¿™ä¹ˆå¤šç‰¹æ€§æ€»ç»“ï¼Œæœ€æœ€æœ€é‡è¦çš„æ˜¯ã€**ä¸€æ¬¡æ€§**ã€‘ã€‚

> è‰¿è‰¿ï¼šä¸‹é¢ä¸‰ä¸ªæ­¥éª¤ï¼Œé€‰æ‹©æ€§äº†è§£å³å¯ã€‚é¢è¯•å¦‚æœé—®åˆ°ï¼Œå°±å½“å€’éœ‰ã€‚

ğŸ¦… **ç¬¬ä¸€æ­¥ï¼Œå®¢æˆ·ç«¯æ³¨å†Œ Watcher å®ç°ï¼Ÿ**

- 1ã€è°ƒç”¨ getDataã€getChildrenã€exist ä¸‰ä¸ª API ï¼Œä¼ å…¥Watcher å¯¹è±¡ã€‚
- 2ã€æ ‡è®°è¯·æ±‚ request ï¼Œå°è£… Watcher åˆ° WatchRegistration ã€‚
- 3ã€å°è£…æˆ Packe tå¯¹è±¡ï¼Œå‘æœåŠ¡ç«¯å‘é€ request ã€‚
- 4ã€æ”¶åˆ°æœåŠ¡ç«¯å“åº”åï¼Œå°† Watcher æ³¨å†Œåˆ° ZKWatcherManager ä¸­è¿›è¡Œç®¡ç†ã€‚
- 5ã€è¯·æ±‚è¿”å›ï¼Œå®Œæˆæ³¨å†Œã€‚

ğŸ¦… **ç¬¬äºŒæ­¥ï¼ŒæœåŠ¡ç«¯å¤„ç† Watcher å®ç°ï¼Ÿ**

- 1ã€æœåŠ¡ç«¯æ¥æ”¶ Watcher å¹¶å­˜å‚¨ã€‚

  > æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå¤„ç†è¯·æ±‚åˆ¤æ–­æ˜¯å¦éœ€è¦æ³¨å†Œ Watcher ï¼Œéœ€è¦çš„è¯å°†æ•°æ®èŠ‚ç‚¹çš„èŠ‚ç‚¹è·¯å¾„å’Œ ServerCnxn(ServerCnxn ä»£è¡¨ä¸€ä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„è¿æ¥ï¼Œå®ç°äº† Watcher çš„ process æ¥å£ï¼Œæ­¤æ—¶å¯ä»¥çœ‹æˆä¸€ä¸ª Watcher å¯¹è±¡)å­˜å‚¨åœ¨ WatcherManager çš„ WatchTable å’Œ Watch2Paths ä¸­å»ã€‚

- 2ã€Watcher è§¦å‘ã€‚

  > ä»¥æœåŠ¡ç«¯æ¥æ”¶åˆ° setData äº‹åŠ¡è¯·æ±‚è§¦å‘ NodeDataChanged äº‹ä»¶ä¸ºä¾‹ï¼š
  >
  > - å°è£… WatchedEvent ï¼š
  >
  > > å°†é€šçŸ¥çŠ¶æ€ï¼ˆSyncConnectedï¼‰ã€äº‹ä»¶ç±»å‹ï¼ˆNodeDataChangedï¼‰ä»¥åŠèŠ‚ç‚¹è·¯å¾„å°è£…æˆä¸€ä¸ªWatchedEventå¯¹è±¡
  >
  > - æŸ¥è¯¢ Watcher ï¼š
  >
  >   > ä» WatchTable ä¸­æ ¹æ®èŠ‚ç‚¹è·¯å¾„æŸ¥æ‰¾ Watcher ã€‚
  >
  >   - æ²¡æ‰¾åˆ° ï¼šè¯´æ˜æ²¡æœ‰å®¢æˆ·ç«¯åœ¨è¯¥æ•°æ®èŠ‚ç‚¹ä¸Šæ³¨å†Œè¿‡ Watcher ã€‚
  >   - æ‰¾åˆ° ï¼šæå–å¹¶ä» WatchTable å’Œ Watch2Paths ä¸­åˆ é™¤å¯¹åº” Watcher (**ä»è¿™é‡Œå¯ä»¥çœ‹å‡º Watcher åœ¨æœåŠ¡ç«¯æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè§¦å‘ä¸€æ¬¡å°±å¤±æ•ˆäº†**)ã€‚

- 3ã€è°ƒç”¨ process æ–¹æ³•æ¥è§¦å‘ Watcher ã€‚

  > è¿™é‡Œ process ä¸»è¦å°±æ˜¯é€šè¿‡ ServerCnxn å¯¹åº”çš„ TCP è¿æ¥å‘é€ Watcher äº‹ä»¶é€šçŸ¥ã€‚

ğŸ¦… **ç¬¬ä¸‰æ­¥ï¼Œå®¢æˆ·ç«¯å›è°ƒ Watcher å®ç°ï¼Ÿ**

å®¢æˆ·ç«¯ SendThread çº¿ç¨‹æ¥æ”¶äº‹ä»¶é€šçŸ¥ï¼Œäº¤ç”± EventThread çº¿ç¨‹å›è°ƒWatcher ã€‚

å®¢æˆ·ç«¯çš„ Watcher æœºåˆ¶åŒæ ·æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œä¸€æ—¦è¢«è§¦å‘åï¼Œè¯¥ Watcher å°±å¤±æ•ˆäº†ã€‚

## Zookeeper é‡‡ç”¨ä»€ä¹ˆæƒé™æ§åˆ¶æœºåˆ¶ï¼Ÿ

> åœ¨ç½‘ä¸Šçœ‹åˆ°ä¸€ä¸ªã€Œä½ ä»¬çš„ Zookeeper çš„èŠ‚ç‚¹åŠ å¯†æ˜¯ç”¨çš„ä»€ä¹ˆæ–¹å¼ï¼Ÿã€é—®é¢˜ï¼Œåº”è¯¥ä¹Ÿæ˜¯é—®è¿™ä¸ªã€‚

ç›®å‰ï¼Œåœ¨ Linux/Unix æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä½¿ç”¨ UGO(User/Group/Others) æƒé™æ¨¡å‹ï¼Œä¹Ÿæ˜¯ä½¿ç”¨æœ€å¹¿æ³›çš„æƒé™æ§åˆ¶æ–¹å¼ã€‚æ˜¯ä¸€ç§ç²—ç²’åº¦çš„æ–‡ä»¶ç³»ç»Ÿæƒé™æ§åˆ¶æ¨¡å¼ã€‚

> ä¸€èˆ¬æˆ‘ä»¬ç®¡ç†åå°ï¼Œé‡‡ç”¨çš„ RBAC å±…å¤šï¼Œå’Œ UGO æ¯”è¾ƒç±»ä¼¼ï¼Œå·®åˆ«åœ¨äºä¸€èˆ¬å°†æƒé™åˆ†é…ç»™ Role ï¼Œè€Œä¸æ˜¯ç›´æ¥ç»™ User ã€‚

å¯¹äº Zookeeper ï¼Œå®ƒé‡‡ç”¨ ACLï¼ˆAccess Control Listï¼‰è®¿é—®æ§åˆ¶åˆ—è¡¨ã€‚åŒ…æ‹¬ä¸‰ä¸ªæ–¹é¢ï¼š

- æƒé™æ¨¡å¼ï¼ˆSchemeï¼‰

  > - IP ï¼šä» IP åœ°å€ç²’åº¦è¿›è¡Œæƒé™æ§åˆ¶
  > - ã€å¸¸ç”¨ã€‘Digest ï¼šæœ€å¸¸ç”¨ï¼Œç”¨ç±»ä¼¼äº `username:password` çš„æƒé™æ ‡è¯†æ¥è¿›è¡Œæƒé™é…ç½®ï¼Œä¾¿äºåŒºåˆ†ä¸åŒåº”ç”¨æ¥è¿›è¡Œæƒé™æ§åˆ¶ã€‚
  > - World ï¼šæœ€å¼€æ”¾çš„æƒé™æ§åˆ¶æ–¹å¼ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„ digest æ¨¡å¼ï¼Œåªæœ‰ä¸€ä¸ªæƒé™æ ‡è¯† `â€œworld:anyoneâ€` ã€‚
  > - Super ï¼šè¶…çº§ç”¨æˆ·ã€‚

- æˆæƒå¯¹è±¡

  > æˆæƒå¯¹è±¡æŒ‡çš„æ˜¯æƒé™èµ‹äºˆçš„ç”¨æˆ·æˆ–ä¸€ä¸ªæŒ‡å®šå®ä½“ï¼Œä¾‹å¦‚ IP åœ°å€æˆ–æ˜¯æœºå™¨ç­‰ã€‚

- æƒé™ Permission

  > - CREATE ï¼šæ•°æ®èŠ‚ç‚¹åˆ›å»ºæƒé™ï¼Œå…è®¸æˆæƒå¯¹è±¡åœ¨è¯¥ znode ä¸‹åˆ›å»ºå­èŠ‚ç‚¹ã€‚
  > - DELETE ï¼šå­èŠ‚ç‚¹åˆ é™¤æƒé™ï¼Œå…è®¸æˆæƒå¯¹è±¡åˆ é™¤è¯¥æ•°æ®èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ã€‚
  > - READ ï¼šæ•°æ®èŠ‚ç‚¹çš„è¯»å–æƒé™ï¼Œå…è®¸æˆæƒå¯¹è±¡è®¿é—®è¯¥æ•°æ®èŠ‚ç‚¹å¹¶è¯»å–å…¶æ•°æ®å†…å®¹æˆ–å­èŠ‚ç‚¹åˆ—è¡¨ç­‰ã€‚
  > - WRITE ï¼šæ•°æ®èŠ‚ç‚¹æ›´æ–°æƒé™ï¼Œå…è®¸æˆæƒå¯¹è±¡å¯¹è¯¥æ•°æ®èŠ‚ç‚¹è¿›è¡Œæ›´æ–°æ“ä½œã€‚
  > - ADMIN ï¼šæ•°æ®èŠ‚ç‚¹ç®¡ç†æƒé™ï¼Œå…è®¸æˆæƒå¯¹è±¡å¯¹è¯¥æ•°æ®èŠ‚ç‚¹è¿›è¡Œ ACL ç›¸å…³è®¾ç½®æ“ä½œã€‚

ğŸ¦… **Chroot ç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Ÿ**

Zookeeper 3.2.0 ç‰ˆæœ¬åï¼Œæ·»åŠ äº† Chroot ç‰¹æ€§ã€‚è¯¥ç‰¹æ€§å…è®¸æ¯ä¸ªå®¢æˆ·ç«¯ä¸ºè‡ªå·±è®¾ç½®ä¸€ä¸ªå‘½åç©ºé—´ã€‚å¦‚æœä¸€ä¸ªå®¢æˆ·ç«¯è®¾ç½®äº† Chroot ï¼Œé‚£ä¹ˆè¯¥å®¢æˆ·ç«¯å¯¹æœåŠ¡å™¨çš„ä»»ä½•æ“ä½œï¼Œéƒ½å°†ä¼šè¢«é™åˆ¶åœ¨å…¶è‡ªå·±çš„å‘½åç©ºé—´ä¸‹ã€‚

é€šè¿‡è®¾ç½® Chroot ï¼Œèƒ½å¤Ÿå°†ä¸€ä¸ªå®¢æˆ·ç«¯åº”ç”¨äº Zookeeper æœåŠ¡ç«¯çš„ä¸€é¢—å­æ ‘ç›¸å¯¹åº”ï¼Œåœ¨é‚£äº›å¤šä¸ªåº”ç”¨å…¬ç”¨ä¸€ä¸ª Zookeeper è¿›ç¾¤çš„åœºæ™¯ä¸‹ï¼Œå¯¹å®ç°ä¸åŒåº”ç”¨é—´çš„ç›¸äº’éš”ç¦»éå¸¸æœ‰å¸®åŠ©ã€‚

> è‰¿è‰¿ï¼šè²Œä¼¼å®é™…è¿˜ç”¨çš„æ¯”è¾ƒå°‘ã€‚

## Zookeeper çš„ä¼šè¯ç®¡ç†æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

ZooKeeper çš„æ¯ä¸ªå®¢æˆ·ç«¯éƒ½ç»´æŠ¤ä¸€ç»„æœåŠ¡ç«¯ä¿¡æ¯ï¼Œåœ¨åˆ›å»ºè¿æ¥æ—¶ç”±åº”ç”¨æŒ‡å®šï¼Œå®¢æˆ·ç«¯éšæœºé€‰æ‹©ä¸€ä¸ªæœåŠ¡ç«¯è¿›è¡Œè¿æ¥ï¼Œè¿æ¥æˆåŠŸåï¼ŒæœåŠ¡ç«¯ä¸ºæ¯ä¸ªè¿æ¥åˆ†é…ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ã€‚

- å®¢æˆ·ç«¯åœ¨åˆ›å»ºè¿æ¥æ—¶å¯ä»¥æŒ‡å®šæº¢å‡ºæ—¶é—´ï¼Œå®¢æˆ·ç«¯ä¼šå‘¨æœŸæ€§çš„å‘æœåŠ¡ç«¯å‘é€ PING è¯·æ±‚æ¥ä¿æŒè¿æ¥ã€‚

  > å¦‚æœå®¢æˆ·ç«¯å¼‚å¸¸ä¸‹çº¿ï¼Œæˆ–è€…ç½‘ç»œé—®é¢˜ï¼Œå¯¼è‡´ä¸€æ®µæ—¶é—´æ²¡å¿ƒè·³ç»™ Zookeeper æœåŠ¡ç«¯ï¼Œåˆ™ä¼šè¢« Zookeeper æ ‡è®°ä¸ºä¸‹çº¿ã€‚

- å½“å®¢æˆ·ç«¯æ£€æµ‹åˆ°ä¸æœåŠ¡ç«¯æ–­å¼€è¿æ¥åï¼Œå®¢æˆ·ç«¯å°†è‡ªåŠ¨é€‰æ‹©æœåŠ¡ç«¯åˆ—è¡¨ä¸­çš„å¦ä¸€ä¸ªæœåŠ¡ç«¯è¿›è¡Œé‡è¿ã€‚å®¢æˆ·ç«¯å…è®¸åº”ç”¨ä¿®æ”¹æœåŠ¡ç«¯åˆ—è¡¨ï¼Œä½†ä¿®æ”¹å¯èƒ½å¯¼è‡´å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é‡è¿ã€‚

è¯¦ç»†çš„ï¼Œæ¨èé˜…è¯»å¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼š

- [ã€ŠZooKeeper session ç®¡ç†ã€‹](https://blog.csdn.net/tomato__/article/details/78560727)
- [ã€ŠZooKeeper æŠ€æœ¯å†…å¹•ï¼šä¼šè¯ã€‹](http://ningg.top/zookeeper-lesson-3-session/) æ›´åŸç†å±‚é¢ã€‚

## Zookeeper çš„éƒ¨ç½²æ–¹å¼ï¼Ÿ

Zookeeper æœ‰ä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼š

- 1ã€å•æœº
- 2ã€é›†ç¾¤

> Zookeeper é›†ç¾¤ï¼Œæ˜¯ä¸€ä¸ªç”±å¤šä¸ª Server ç»„æˆï¼Œä¸€ä¸ª Leaderï¼Œå¤šä¸ª Followerã€‚ï¼ˆè¿™ä¸ªä¸åŒäºæˆ‘ä»¬å¸¸è§çš„ Master/Slave æ¨¡å¼ï¼‰Leader ä¸ºå®¢æˆ·ç«¯æœåŠ¡å™¨æä¾›è¯»å†™æœåŠ¡ï¼Œé™¤äº† Leader å¤–å…¶ä»–çš„æœºå™¨åªèƒ½æä¾›è¯»æœåŠ¡ã€‚
>
> æ¯ä¸ª Server ä¿å­˜ä¸€ä»½æ•°æ®å‰¯æœ¬å…¨æ•°æ®ä¸€è‡´ï¼Œåˆ†å¸ƒå¼è¯» Follower ï¼Œå†™ç”± Leader å®æ–½æ›´æ–°è¯·æ±‚è½¬å‘ï¼Œç”± Leader å®æ–½æ›´æ–°è¯·æ±‚é¡ºåºè¿›è¡Œï¼Œæ¥è‡ªåŒä¸€ä¸ª Client çš„æ›´æ–°è¯·æ±‚æŒ‰å…¶å‘é€é¡ºåºä¾æ¬¡æ‰§è¡Œæ•°æ®æ›´æ–°åŸå­æ€§ï¼Œä¸€æ¬¡æ•°æ®æ›´æ–°è¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥ã€‚
>
> å…¨å±€å”¯ä¸€æ•°æ®è§†å›¾ï¼ŒClient æ— è®ºè¿æ¥åˆ°å“ªä¸ª Serverï¼Œæ•°æ®è§†å›¾éƒ½æ˜¯ä¸€è‡´çš„å®æ—¶æ€§ï¼Œåœ¨ä¸€å®šäº‹ä»¶èŒƒå›´å†…ï¼ŒClient èƒ½è¯»åˆ°æœ€æ–°æ•°æ®ã€‚
>
> [![Zookeeper é›†ç¾¤](http://static2.iocoder.cn/20cdb662c4f40297b3713148fdfd1c47)](http://static2.iocoder.cn/20cdb662c4f40297b3713148fdfd1c47)Zookeeper é›†ç¾¤

ä¸€èˆ¬æ¥è¯´ï¼Œæµ‹è¯•ç¯å¢ƒéƒ¨ç½²å•æœºï¼Œè€Œç”Ÿäº§ç¯å¢ƒå¿…é¡»å¿…é¡»å¿…é¡»éƒ¨ç½²é›†ç¾¤ã€‚

ğŸ¦… **é›†ç¾¤ä¸­çš„æœºå™¨è§’è‰²æœ‰å“ªäº›ï¼Ÿ**

é›†ç¾¤ä¸­ä¸€å…±æœ‰ä¸‰ç§è§’è‰²ï¼š

- 1ã€Leader

  > - äº‹åŠ¡è¯·æ±‚çš„å”¯ä¸€è°ƒåº¦å’Œå¤„ç†è€…ï¼Œä¿è¯é›†ç¾¤äº‹åŠ¡å¤„ç†çš„é¡ºåºæ€§ã€‚
  > - é›†ç¾¤å†…éƒ¨å„æœåŠ¡çš„è°ƒåº¦è€…ã€‚

- 2ã€Follower

  > - å¤„ç†å®¢æˆ·ç«¯çš„éäº‹åŠ¡è¯·æ±‚ï¼Œè½¬å‘äº‹åŠ¡è¯·æ±‚ç»™ Leader æœåŠ¡å™¨ã€‚
  > - å‚ä¸äº‹åŠ¡è¯·æ±‚ Proposal çš„æŠ•ç¥¨ã€‚
  > - å‚ä¸ Leader é€‰ä¸¾æŠ•ç¥¨ã€‚

- 3ã€Observer

  > 3.3.0 ç‰ˆæœ¬ä»¥åå¼•å…¥çš„ä¸€ä¸ªæœåŠ¡å™¨è§’è‰²ï¼Œåœ¨ä¸å½±å“é›†ç¾¤äº‹åŠ¡å¤„ç†èƒ½åŠ›çš„åŸºç¡€ä¸Šæå‡é›†ç¾¤çš„éäº‹åŠ¡å¤„ç†èƒ½åŠ›ã€‚
  >
  > - å¤„ç†å®¢æˆ·ç«¯çš„éäº‹åŠ¡è¯·æ±‚ï¼Œè½¬å‘äº‹åŠ¡è¯·æ±‚ç»™ Leader æœåŠ¡å™¨
  > - ä¸å‚ä¸ä»»ä½•å½¢å¼çš„æŠ•ç¥¨ã€‚
  >
  > å¦‚æœ ZooKeeper é›†ç¾¤çš„è¯»å–è´Ÿè½½å¾ˆé«˜ï¼Œæˆ–è€…å®¢æˆ·ç«¯å¤šåˆ°è·¨æœºæˆ¿ï¼Œå¯ä»¥è®¾ç½®ä¸€äº› Observer æœåŠ¡å™¨ï¼Œä»¥æé«˜è¯»å–çš„ååé‡ã€‚Observer å’Œ Follower æ¯”è¾ƒç›¸ä¼¼ï¼Œåªæœ‰ä¸€äº›å°åŒºåˆ«ï¼š
  >
  > - é¦–å…ˆ Observer ä¸å±äºæ³•å®šäººæ•°ï¼Œå³ä¸å‚åŠ é€‰ä¸¾ä¹Ÿä¸å“åº”æè®®ï¼Œä¹Ÿä¸å‚ä¸å†™æ“ä½œçš„â€œè¿‡åŠå†™æˆåŠŸâ€ç­–ç•¥ï¼›
  > - å…¶æ¬¡æ˜¯ Observer ä¸éœ€è¦å°†äº‹åŠ¡æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œä¸€æ—¦ Observer è¢«é‡å¯ï¼Œéœ€è¦ä» Leader é‡æ–°åŒæ­¥æ•´ä¸ªåå­—ç©ºé—´ã€‚

åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œæœ€å°‘éœ€è¦ 3 å°ã€‚æˆ–è€…ä¿è¯ 2N + 1 å°ï¼Œå³å¥‡æ•°ã€‚ä¸ºä»€ä¹ˆä¿è¯å¥‡æ•°ï¼Ÿä¸»è¦æ˜¯ä¸ºäº†é€‰ä¸¾ç®—æ³•ã€‚

ğŸ¦… **é›†ç¾¤å¦‚æœæœ‰ 3 å°æœºå™¨ï¼ŒæŒ‚æ‰ 1 å°é›†ç¾¤è¿˜èƒ½å·¥ä½œå—ï¼ŸæŒ‚æ‰ 2 å°å‘¢ï¼Ÿ**

è®°ä½ä¸€ä¸ªåŸåˆ™ï¼šè¿‡åŠå­˜æ´»å³å¯ç”¨ã€‚æ‰€ä»¥æŒ‚æ‰ 1 å°å¯ä»¥ç»§ç»­å·¥ä½œï¼ŒæŒ‚æ‰ 2 å°ä¸å¯ä»¥å·¥ä½œã€‚

ğŸ¦… **é›†ç¾¤æ”¯æŒåŠ¨æ€æ·»åŠ æœºå™¨å—ï¼Ÿ**

åœ¨ 3.5 ç‰ˆæœ¬å¼€å§‹ï¼Œæ”¯æŒåŠ¨æ€æ‰©å®¹ã€‚

è€Œåœ¨ 3.5 ç‰ˆæœ¬ä¹‹å‰ï¼ŒZookeeper åœ¨è¿™æ–¹é¢ä¸å¤ªå¥½ã€‚æ‰€ä»¥éœ€è¦å¦‚ä¸‹ä¸¤ç§æ–¹å¼ï¼š

- å…¨éƒ¨é‡å¯ï¼šå…³é—­æ‰€æœ‰ Zookeeper æœåŠ¡ï¼Œä¿®æ”¹é…ç½®ä¹‹åå¯åŠ¨ã€‚ä¸å½±å“ä¹‹å‰å®¢æˆ·ç«¯çš„ä¼šè¯ã€‚
- é€ä¸ªé‡å¯ï¼šé¡¾åæ€ä¹‰ã€‚è¿™æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„æ–¹å¼ã€‚

ğŸ¦… **Zookeeper ä¸‹ Server å·¥ä½œçŠ¶æ€ï¼Ÿ**

æœåŠ¡å™¨å…·æœ‰å››ç§çŠ¶æ€ï¼Œåˆ†åˆ«æ˜¯ï¼š

- LOOKING å¯»æ‰¾ Leader çŠ¶æ€

  > å½“æœåŠ¡å™¨å¤„äºè¯¥çŠ¶æ€æ—¶ï¼Œå®ƒä¼šè®¤ä¸ºå½“å‰é›†ç¾¤ä¸­æ²¡æœ‰ Leader ï¼Œå› æ­¤éœ€è¦è¿›å…¥ Leader é€‰ä¸¾çŠ¶æ€ã€‚

- FOLLOWING è·Ÿéšè€…çŠ¶æ€

  > è¡¨æ˜å½“å‰æœåŠ¡å™¨è§’è‰²æ˜¯ Follower ã€‚

- LEADING é¢†å¯¼è€…çŠ¶æ€

  > è¡¨æ˜å½“å‰æœåŠ¡å™¨è§’è‰²æ˜¯ Leader ã€‚

- OBSERVING è§‚å¯Ÿè€…çŠ¶æ€

  > è¡¨æ˜å½“å‰æœåŠ¡å™¨è§’è‰²æ˜¯ Observer ã€‚

## ZooKeeper çš„å·¥ä½œåŸç†ï¼Ÿ

ZooKeeper çš„æ ¸å¿ƒæ˜¯åŸå­å¹¿æ’­ï¼Œè¿™ä¸ªæœºåˆ¶ä¿è¯äº†å„ä¸ª Server ä¹‹é—´çš„åŒæ­¥ã€‚å®ç°è¿™ä¸ªæœºåˆ¶çš„åè®®å«åš **Zab** åè®®ã€‚Zab åè®®æœ‰ä¸¤ç§æ¨¡å¼ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯æ¢å¤æ¨¡å¼ï¼ˆé€‰ä¸»ï¼‰å’Œå¹¿æ’­æ¨¡å¼ï¼ˆåŒæ­¥ï¼‰ï¼š

- é€‰ä¸»ï¼šå½“æœåŠ¡å¯åŠ¨æˆ–è€… Leader å´©æºƒåï¼ŒZab å°±è¿›å…¥äº†æ¢å¤æ¨¡å¼ï¼Œå½“æ–°çš„ Leader è¢«é€‰ä¸¾å‡ºæ¥ï¼Œä¸”å¤§å¤šæ•° Server å®Œæˆäº†å’Œ Leader çš„çŠ¶æ€åŒæ­¥ä»¥åï¼Œæ¢å¤æ¨¡å¼å°±ç»“æŸäº†ã€‚

  > æ›´åŠ è¯¦ç»†çš„æè¿°ã€‚
  >
  > å½“æ•´ä¸ª Zookeeper é›†ç¾¤åˆšåˆšå¯åŠ¨ï¼Œæˆ–è€… Leader æœåŠ¡å™¨å®•æœºã€é‡å¯æˆ–è€…ç½‘ç»œæ•…éšœå¯¼è‡´ä¸å­˜åœ¨è¿‡åŠçš„æœåŠ¡å™¨ä¸ LeaderæœåŠ¡å™¨ä¿æŒæ­£å¸¸é€šä¿¡æ—¶ï¼Œæ‰€æœ‰è¿›ç¨‹ï¼ˆæœåŠ¡å™¨ï¼‰è¿›å…¥å´©æºƒæ¢å¤æ¨¡å¼ã€‚
  >
  > - é¦–å…ˆï¼Œé€‰ä¸¾äº§ç”Ÿæ–°çš„LeaderæœåŠ¡å™¨ã€‚
  > - ç„¶åï¼Œé›†ç¾¤ä¸­ Follower æœåŠ¡å™¨å¼€å§‹ä¸æ–°çš„ Leader æœåŠ¡å™¨è¿›è¡Œæ•°æ®åŒæ­¥ã€‚
  > - å½“é›†ç¾¤ä¸­è¶…è¿‡åŠæ•°æœºå™¨ä¸è¯¥LeaderæœåŠ¡å™¨å®Œæˆæ•°æ®åŒæ­¥ä¹‹åï¼Œé€€å‡ºæ¢å¤æ¨¡å¼è¿›å…¥æ¶ˆæ¯å¹¿æ’­æ¨¡å¼ï¼Œ

- åŒæ­¥ï¼šçŠ¶æ€åŒæ­¥ä¿è¯äº† Leader å’Œ Server å…·æœ‰ç›¸åŒçš„ç³»ç»ŸçŠ¶æ€ã€‚

  > æ›´åŠ è¯¦ç»†çš„æè¿°ã€‚
  >
  > Leader æœåŠ¡å™¨å¼€å§‹æ¥æ”¶å®¢æˆ·ç«¯çš„äº‹åŠ¡è¯·æ±‚ï¼Œç”Ÿæˆäº‹åŠ¡ææ¡ˆæ¥è¿›è¡Œäº‹åŠ¡è¯·æ±‚å¤„ç†ã€‚

ğŸ¦… **ZooKeeper æ˜¯å¦‚ä½•ä¿è¯äº‹åŠ¡çš„é¡ºåºä¸€è‡´æ€§çš„ï¼Ÿ**

ZooKeeper é‡‡ç”¨äº†é€’å¢çš„äº‹åŠ¡ id æ¥è¯†åˆ«ï¼Œæ‰€æœ‰çš„ proposalï¼ˆæè®®ï¼‰éƒ½åœ¨è¢«æå‡ºçš„æ—¶å€™åŠ ä¸Šäº† zxid ã€‚zxid å®é™…ä¸Šæ˜¯ä¸€ä¸ª 64 ä½æ•°å­—ã€‚

- é«˜ 32 ä½æ˜¯ epoch ç”¨æ¥æ ‡è¯† Leader æ˜¯å¦å‘ç”Ÿäº†æ”¹å˜ï¼Œå¦‚æœæœ‰æ–°çš„ Leader äº§ç”Ÿå‡ºæ¥ï¼Œepochä¼šè‡ªå¢ã€‚
- ä½ 32 ä½ç”¨æ¥é€’å¢è®¡æ•°ã€‚

å½“æ–°äº§ç”Ÿçš„ peoposal çš„æ—¶å€™ï¼Œä¼šä¾æ®æ•°æ®åº“çš„ä¸¤é˜¶æ®µè¿‡ç¨‹ï¼Œé¦–å…ˆä¼šå‘å…¶ä»–çš„ Server å‘å‡ºäº‹åŠ¡æ‰§è¡Œè¯·æ±‚ï¼Œå¦‚æœè¶…è¿‡åŠæ•°çš„æœºå™¨éƒ½èƒ½æ‰§è¡Œå¹¶ä¸”èƒ½å¤ŸæˆåŠŸï¼Œé‚£ä¹ˆå°±ä¼šå¼€å§‹æ‰§è¡Œã€‚

ğŸ¦… **ZooKeeper é›†ç¾¤ä¸­ä¸ªæœåŠ¡å™¨ä¹‹é—´æ˜¯æ€æ ·é€šä¿¡çš„ï¼Ÿ**

Leader æœåŠ¡å™¨ä¼šå’Œæ¯ä¸€ä¸ª Follower/Observer æœåŠ¡å™¨éƒ½å»ºç«‹ TCP è¿æ¥ï¼ŒåŒæ—¶ä¸ºæ¯ä¸ª Follower/Observer éƒ½åˆ›å»ºä¸€ä¸ªå«åš LearnerHandler çš„å®ä½“ã€‚

- LearnerHandler ä¸»è¦è´Ÿè´£ Leader å’Œ Follower/Observer ä¹‹é—´çš„ç½‘ç»œé€šè®¯ï¼ŒåŒ…æ‹¬æ•°æ®åŒæ­¥ï¼Œè¯·æ±‚è½¬å‘å’Œ Proposal æè®®çš„æŠ•ç¥¨ç­‰ã€‚
- Leader æœåŠ¡å™¨ä¿å­˜äº†æ‰€æœ‰ Follower/Observer çš„ LearnerHandler ã€‚

ğŸ¦… **ZAB å’Œ Paxos ç®—æ³•çš„è”ç³»ä¸åŒºåˆ«ï¼Ÿ**

Paxos ç®—æ³•æ˜¯åˆ†å¸ƒå¼é€‰ä¸¾ç®—æ³•ï¼ŒZookeeper ä½¿ç”¨çš„ ZAB åè®®ï¼ˆZookeeper åŸå­å¹¿æ’­ï¼‰ã€‚

äºŒè€…æœ‰ç›¸åŒçš„åœ°æ–¹ï¼š

- éƒ½æœ‰ä¸€ä¸ª Leaderï¼Œç”¨æ¥åè°ƒ N ä¸ª Follower çš„è¿è¡Œ
- Leader è¦ç­‰å¾…è¶…åŠæ•°çš„ Followeråš å‡ºæ­£ç¡®åé¦ˆä¹‹åæ‰è¿›è¡Œææ¡ˆã€‚
- äºŒè€…éƒ½æœ‰ä¸€ä¸ªå€¼æ¥ä»£è¡¨ Leader çš„å‘¨æœŸã€‚ZAB åè®®ä¸­ï¼Œæ¯ä¸ª Proposal ä¸­éƒ½åŒ…å«ä¸€ä¸ª epoch å€¼æ¥ä»£è¡¨å½“å‰çš„Leaderå‘¨æœŸï¼ŒPaxosä¸­åå­—ä¸º Ballot ã€‚

ä¸åŒçš„åœ°æ–¹åœ¨äºï¼š

- ZAB ç”¨æ¥æ„å»ºé«˜å¯ç”¨çš„åˆ†å¸ƒå¼æ•°æ®ä¸»å¤‡ç³»ç»Ÿï¼ˆZookeeperï¼‰ï¼ŒPaxos æ˜¯ç”¨æ¥æ„å»ºåˆ†å¸ƒå¼ä¸€è‡´æ€§çŠ¶æ€æœºç³»ç»Ÿã€‚

Paxos ç®—æ³•ã€ZAB åè®®è¦æƒ³è®²æ¸…æ¥šå¯ä¸æ˜¯ä¸€æ—¶åŠä¼šçš„äº‹å„¿ï¼Œè‡ª 1990 å¹´è±æ–¯åˆ©Â·å…°ä¼¯ç‰¹æå‡º Paxos ç®—æ³•ä»¥æ¥ï¼Œå› ä¸ºæ™¦æ¶©éš¾æ‡‚å¹¶æ²¡æœ‰å—åˆ°é‡è§†ã€‚åç»­å‡ å¹´ï¼Œå…°ä¼¯ç‰¹é€šè¿‡å¥½å‡ ç¯‡è®ºæ–‡å¯¹å…¶è¿›è¡Œæ›´è¿›ä¸€æ­¥åœ°è§£é‡Šï¼Œä¹Ÿç›´åˆ° 06 å¹´è°·æ­Œå‘è¡¨äº†ä¸‰ç¯‡è®ºæ–‡ï¼Œé€‰æ‹© Paxos ä½œä¸º Chubby cell çš„ä¸€è‡´æ€§ç®—æ³•ï¼ŒPaxo sæ‰çœŸæ­£æµè¡Œèµ·æ¥ã€‚

å¯¹äºæ™®é€šå¼€å‘è€…æ¥è¯´ï¼Œå°¤å…¶æ˜¯å­¦ä¹ ä½¿ç”¨ Zookeeper çš„å¼€å‘è€…æ˜ç¡®ä¸€ç‚¹å°±å¥½ï¼šåˆ†å¸ƒå¼ Zookeeper é€‰ä¸¾ Leader æœåŠ¡å™¨çš„ç®—æ³•ï¼Œä¸ Paxos æœ‰å¾ˆæ·±çš„å…³ç³»ã€‚

## Zookeeper çš„é€‰ä¸¾è¿‡ç¨‹ï¼Ÿ

å½“ Leader å´©æºƒï¼Œæˆ–è€… Leader å¤±å»å¤§å¤šæ•°çš„ Followerï¼Œè¿™æ—¶ Zookeeper è¿›å…¥æ¢å¤æ¨¡å¼ï¼Œæ¢å¤æ¨¡å¼éœ€è¦é‡æ–°é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ Leaderï¼Œè®©æ‰€æœ‰çš„ Server éƒ½æ¢å¤åˆ°ä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€ã€‚

Zookeeper çš„é€‰ä¸¾ç®—æ³•æœ‰ä¸¤ç§ï¼šä¸€ç§æ˜¯åŸºäº basic paxos å®ç°çš„ï¼Œå¦å¤–ä¸€ç§æ˜¯åŸºäº fast paxos ç®—æ³•å®ç°çš„ã€‚ç³»ç»Ÿé»˜è®¤çš„é€‰ä¸¾ç®—æ³•ä¸º fast paxos ã€‚

> ç›¸å¯¹è¯¦ç»†çš„ï¼Œèƒ–å‹å¯ä»¥çœ‹çœ‹ [ã€Šã€åˆ†å¸ƒå¼ã€‘Zookeeperçš„Leaderé€‰ä¸¾ã€‹](http://www.cnblogs.com/leesf456/p/6107600.html) å’Œ [ã€ŠZookeeper æºç åˆ†æ â€”â€” Zookeeper Leader é€‰ä¸¾ç®—æ³•ã€‹](https://juejin.im/post/5b949d595188255c6a041c22) ã€‚
>
> - ä¸åŒé˜¶æ®µçš„é€‰ä¸¾æµç¨‹
>   - æœåŠ¡å™¨å¯åŠ¨æ—¶æœŸçš„ Leader é€‰ä¸¾ã€‚
>   - æœåŠ¡å™¨è¿è¡Œæ—¶æœŸçš„ Leader é€‰ä¸¾ã€‚
> - ä¸‰ç§é€‰ä¸¾ç®—æ³•
>   - LeaderElection ï¼šä½¿ç”¨ basic paxos ç®—æ³•ã€‚
>   - FastLeaderElection ï¼šä½¿ç”¨ fast paxos ç®—æ³•ã€‚
>   - AuthFastLeaderElection ï¼šåœ¨ FastLeaderElection çš„åŸºç¡€ä¸Šï¼Œå¢åŠ è®¤è¯ã€‚
>   - æœ€ç»ˆåœ¨ Zookeeper 3.4.0 ç‰ˆæœ¬ä¹‹åï¼Œåªä¿ç•™ FastLeaderElection ç‰ˆæœ¬ã€‚

ğŸ˜ˆ çœ‹ä¸‹é¢çš„åŸç†æè¿°ï¼Œè¿˜æ˜¯æœ‰ç‚¹æ‡µé€¼ã€‚ç­‰åé¢è‰¿è‰¿è‡ªå·±å»æ’¸ä¸‹æºç ï¼Œå¯èƒ½ä¼šæ¸…æ™°ä¸€äº›ã€‚

ğŸ¦… **Zookeeper é€‰ä¸»æµç¨‹(basic paxos)ï¼Ÿ**

> é€‰æ‹©æ€§äº†è§£ã€‚

- 1ã€é€‰ä¸¾çº¿ç¨‹ç”±å½“å‰ Server å‘èµ·é€‰ä¸¾çš„çº¿ç¨‹æ‹…ä»»ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯å¯¹æŠ•ç¥¨ç»“æœè¿›è¡Œç»Ÿè®¡ï¼Œå¹¶é€‰å‡ºæ¨èçš„ Server ã€‚
- 2ã€é€‰ä¸¾çº¿ç¨‹é¦–å…ˆå‘æ‰€æœ‰ Server å‘èµ·ä¸€æ¬¡è¯¢é—®(åŒ…æ‹¬è‡ªå·±)ã€‚
- 3ã€é€‰ä¸¾çº¿ç¨‹æ”¶åˆ°å›å¤åï¼ŒéªŒè¯æ˜¯å¦æ˜¯è‡ªå·±å‘èµ·çš„è¯¢é—®(éªŒè¯ zxid æ˜¯å¦ä¸€è‡´)ï¼Œç„¶åè·å–å¯¹æ–¹çš„ id(myid)ï¼Œå¹¶å­˜å‚¨åˆ°å½“å‰è¯¢é—®å¯¹è±¡åˆ—è¡¨ä¸­ï¼Œæœ€åè·å–å¯¹æ–¹æè®®çš„ Leaderç›¸å…³ä¿¡æ¯(idï¼Œzxid)ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åˆ°å½“æ¬¡é€‰ä¸¾çš„æŠ•ç¥¨è®°å½•è¡¨ä¸­ã€‚
- 4ã€æ”¶åˆ°æ‰€æœ‰ Server å›å¤ä»¥åï¼Œå°±è®¡ç®—å‡º zxid æœ€å¤§çš„é‚£ä¸ª Server ï¼Œå¹¶å°†è¿™ä¸ª Server ç›¸å…³ä¿¡æ¯è®¾ç½®æˆä¸‹ä¸€æ¬¡è¦æŠ•ç¥¨çš„ Server ã€‚
- 5ã€çº¿ç¨‹å°†å½“å‰ zxid æœ€å¤§çš„ Server è®¾ç½®ä¸ºå½“å‰ Server è¦æ¨èçš„ Leader ï¼Œå¦‚æœæ­¤æ—¶è·èƒœçš„ Server è·å¾— `n/2+1` çš„ Server ç¥¨æ•°ï¼Œè®¾ç½®å½“å‰æ¨èçš„ Leader ä¸ºè·èƒœçš„ Server ï¼Œå°†æ ¹æ®è·èƒœçš„ Server ç›¸å…³ä¿¡æ¯è®¾ç½®è‡ªå·±çš„çŠ¶æ€ï¼Œå¦åˆ™ï¼Œç»§ç»­è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ° Leader è¢«é€‰ä¸¾å‡ºæ¥ã€‚

é€šè¿‡æµç¨‹åˆ†ææˆ‘ä»¬å¯ä»¥å¾—å‡ºï¼šè¦ä½¿ Leader è·å¾—å¤šæ•° Server çš„æ”¯æŒï¼Œåˆ™ Server æ€»æ•°å¿…é¡»æ˜¯å¥‡æ•° `2n+1` ï¼Œä¸”å­˜æ´»çš„ Server çš„æ•°ç›®ä¸å¾—å°‘äº`n+1` ã€‚æ¯ä¸ª Server å¯åŠ¨åéƒ½ä¼šé‡å¤ä»¥ä¸Šæµç¨‹ã€‚

åœ¨æ¢å¤æ¨¡å¼ä¸‹ï¼Œå¦‚æœæ˜¯åˆšä»å´©æºƒçŠ¶æ€æ¢å¤çš„æˆ–è€…åˆšå¯åŠ¨çš„ Server è¿˜ä¼šä»ç£ç›˜å¿«ç…§ä¸­æ¢å¤æ•°æ®å’Œä¼šè¯ä¿¡æ¯ï¼ŒZookeeper ä¼šè®°å½•äº‹åŠ¡æ—¥å¿—å¹¶å®šæœŸè¿›è¡Œå¿«ç…§ï¼Œæ–¹ä¾¿åœ¨æ¢å¤æ—¶è¿›è¡ŒçŠ¶æ€æ¢å¤ã€‚

[![æµç¨‹](http://static2.iocoder.cn/4c9358ff89ffef1089190c6472ebe51c)](http://static2.iocoder.cn/4c9358ff89ffef1089190c6472ebe51c)æµç¨‹

ğŸ¦… **Zookeeper é€‰ä¸»æµç¨‹(fast paxos)ï¼Ÿ**

> é‡ç‚¹äº†è§£ã€‚è¿™å—åœ¨ [ã€ŠZookeeper æºç åˆ†æ â€”â€” Zookeeper Leader é€‰ä¸¾ç®—æ³•ã€‹](https://juejin.im/post/5b949d595188255c6a041c22) å†™çš„æ¯”è¾ƒè¯¦ç»†ã€‚

ç”±äº LeaderElection æ”¶æ•›é€Ÿåº¦è¾ƒæ…¢ï¼Œæ‰€ä»¥ Zookeeper å¼•å…¥äº† FastLeaderElection é€‰ä¸¾ç®—æ³•ï¼ŒFastLeaderElection ä¹Ÿæˆäº†Zookeeperé»˜è®¤çš„Leaderé€‰ä¸¾ç®—æ³•ã€‚

FastLeaderElection æ˜¯æ ‡å‡†çš„ Fast Paxos çš„å®ç°ã€‚å®ƒé¦–å…ˆå‘æ‰€æœ‰ Server æè®®è‡ªå·±è¦æˆä¸º Leader ï¼Œå½“å…¶å®ƒ Server æ”¶åˆ°æè®®ä»¥åï¼Œè§£å†³ epoch å’Œ zxid çš„å†²çªï¼Œå¹¶æ¥å—å¯¹æ–¹çš„æè®®ï¼Œç„¶åå‘å¯¹æ–¹å‘é€æ¥å—æè®®å®Œæˆçš„æ¶ˆæ¯ã€‚é‡å¤è¿™ä¸ªæµç¨‹ï¼Œæœ€åä¸€å®šèƒ½é€‰ä¸¾å‡ºLeaderã€‚

FastLeaderElection ç®—æ³•é€šè¿‡å¼‚æ­¥çš„é€šä¿¡æ–¹å¼æ¥æ”¶é›†å…¶å®ƒèŠ‚ç‚¹çš„é€‰ç¥¨ï¼ŒåŒæ—¶åœ¨åˆ†æé€‰ç¥¨æ—¶åˆæ ¹æ®æŠ•ç¥¨è€…çš„å½“å‰çŠ¶æ€æ¥ä½œä¸åŒçš„å¤„ç†ï¼Œä»¥åŠ å¿« Leader çš„é€‰ä¸¾è¿›ç¨‹ã€‚

[![æµç¨‹](http://static2.iocoder.cn/6591164c09fd2dadef24bd984c9f3a14)](http://static2.iocoder.cn/6591164c09fd2dadef24bd984c9f3a14)æµç¨‹

ğŸ¦… **ä¸ºä»€ä¹ˆ Zookeeper é›†ç¾¤æ¨èèŠ‚ç‚¹æ•°æ˜¯å•æ•°ï¼Ÿ**

åœ¨ç»Ÿè®¡æŠ•ç¥¨æ—¶ï¼Œæœ‰ä¸ªè¿‡åŠçš„æ¦‚å¿µï¼Œå¤§äºé›†ç¾¤æœºå™¨æ•°é‡çš„ä¸€åŠï¼Œå³å¤§äºæˆ–ç­‰äº(`n/2+1`)ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä¸‹çš„ç»Ÿè®¡ï¼š

| é›†ç¾¤æ•°é‡ | è‡³å°‘æ­£å¸¸è¿è¡Œæ•°é‡                 | å…è®¸æŒ‚æ‰çš„æ•°é‡ |
| :------- | :------------------------------- | :------------- |
| 2        | 2 çš„åŠæ•°ä¸º 1ï¼ŒåŠæ•°ä»¥ä¸Šæœ€å°‘ä¸º 2   | 0              |
| 3        | 3 çš„åŠæ•°ä¸º 1.5ï¼ŒåŠæ•°ä»¥ä¸Šæœ€å°‘ä¸º 2 | 1              |
| 4        | 4 çš„åŠæ•°ä¸º 2ï¼ŒåŠæ•°ä»¥ä¸Šæœ€å°‘ä¸º 3   | 1              |
| 5        | 5 çš„åŠæ•°ä¸º 2.5ï¼ŒåŠæ•°ä»¥ä¸Šæœ€å°‘ä¸º 3 | 2              |
| 6        | 6 çš„åŠæ•°ä¸º 3ï¼ŒåŠæ•°ä»¥ä¸Šæœ€å°‘ä¸º 4   | 2              |

é€šè¿‡ä»¥ä¸Šå¯ä»¥å‘ç°ï¼š

- 3 å°æœåŠ¡å™¨å’Œ 4 å°æœåŠ¡å™¨éƒ½æœ€å¤šå…è®¸ 1 å°æœåŠ¡å™¨æŒ‚æ‰ï¼Œ5 å°æœåŠ¡å™¨å’Œ 6 å°æœåŠ¡å™¨éƒ½æœ€å¤šå…è®¸ 2 å°æœåŠ¡å™¨æŒ‚æ‰ï¼Œæ˜æ˜¾ 4 å°æœåŠ¡å™¨æˆæœ¬é«˜äº 3 å°æœåŠ¡å™¨æˆæœ¬ï¼Œ6 å°æœåŠ¡å™¨æˆæœ¬é«˜äº 5 æœåŠ¡å™¨æˆæœ¬ã€‚
- è¿™æ˜¯ç”±äºåŠæ•°ä»¥ä¸ŠæŠ•ç¥¨é€šè¿‡å†³å®šçš„ã€‚æ‰€ä»¥ï¼ŒZookeeper é›†ç¾¤æ¨èèŠ‚ç‚¹æ•°æ˜¯å•æ•°ã€‚

ç®€å•çš„æ¥è¯´ï¼Œ**èŠ‚çœèµ„æº**ï¼

å¦å¤–ï¼Œå› ä¸º Zookeeper ä½¿ç”¨ä¸€è‡´æ€§åè®®ï¼Œè¿‡å¤šçš„èŠ‚ç‚¹ï¼Œåå€’ä¼šé™ä½æ€§èƒ½ã€‚ğŸ˜ˆ

ğŸ¦… **Zookeeper æ˜¯å¦éœ€å­˜åœ¨è„‘è£‚ï¼Ÿ**

æŒ‰é“ç†è¯´ï¼ŒZookeeper é€‰ä¸¾ä¸ä¼šå­˜åœ¨è„‘è£‚é—®é¢˜ï¼Œå› ä¸ºéœ€è¦ `n / 2 + 1` æŠ•ç¥¨é€šè¿‡ï¼Œæ‰èƒ½æ‰§è¡Œå¯¹åº”çš„å†™æ“ä½œã€‚ä½†æ˜¯å¬æœ‹å‹è¯´ï¼Œå®é™…åœºæ™¯ä¸‹ï¼Œè²Œä¼¼å‘ç”Ÿè¿‡è„‘è£‚é—®é¢˜ã€‚å…³äºè¿™å—ï¼Œè‰¿è‰¿å¿ƒé‡Œä¹Ÿä¸å¤ªæœ‰åº•ï¼Œæ¬¢è¿åœ¨æ˜Ÿçƒä¸€èµ·è®¨è®ºã€‚

- [ã€ŠZookeeper å·²ç»åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„å‡æ­»è„‘è£‚ã€‹](https://blog.csdn.net/u010185262/article/details/49910301)

  > è®¤ä¸ºå­˜åœ¨è„‘è£‚é—®é¢˜ï¼Œä»¥åŠæä¾›æ€ä¹ˆè§£å†³ã€‚

- [ã€Šzookeeperï¼ˆäºŒï¼‰å¸¸è§é—®é¢˜æ±‡æ€»ã€‹](https://blog.csdn.net/yjp198713/article/details/79400927)

  > è®¤ä¸ºä¸ä¼šå­˜åœ¨è„‘è£‚é—®é¢˜ã€‚

ğŸ¦… **æœºå™¨ä¸­ä¸ºä»€ä¹ˆä¼šæœ‰ Leaderï¼Ÿ**

åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œæœ‰äº›ä¸šåŠ¡é€»è¾‘åªéœ€è¦é›†ç¾¤ä¸­çš„æŸä¸€å°æœºå™¨è¿›è¡Œæ‰§è¡Œï¼Œå…¶ä»–çš„æœºå™¨å¯ä»¥å…±äº«è¿™ä¸ªç»“æœï¼Œè¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘é‡å¤è®¡ç®—ï¼Œæé«˜æ€§èƒ½ï¼Œäºæ˜¯å°±éœ€è¦è¿›è¡Œ Leader é€‰ä¸¾ã€‚

## Zookeeper çš„åŒæ­¥æµç¨‹ï¼Ÿ

é€‰å®Œ Leader ä»¥åï¼ŒZookeeper å°±è¿›å…¥çŠ¶æ€åŒæ­¥è¿‡ç¨‹ã€‚

- 1ã€Leader ç­‰å¾… Server è¿æ¥ã€‚
- 2ã€Follower è¿æ¥ Leader ï¼Œå°†æœ€å¤§çš„ zxid å‘é€ç»™ Leader ã€‚
- 3ã€Leader æ ¹æ® Follower çš„ zxid ç¡®å®šåŒæ­¥ç‚¹ã€‚
- 4ã€å®ŒæˆåŒæ­¥åé€šçŸ¥ Follower å·²ç»æˆä¸º update çŠ¶æ€ã€‚
- 5ã€Follower æ”¶åˆ° update æ¶ˆæ¯åï¼Œåˆå¯ä»¥é‡æ–°æ¥å— Client çš„è¯·æ±‚è¿›è¡ŒæœåŠ¡äº†ã€‚

å½“ç„¶ï¼ŒåŒæ­¥æµç¨‹å¹¶ä¸æ˜¯åƒä¸Šè¿°æè¿°çš„è¿™ä¹ˆç®€å•ï¼Œå…·ä½“çš„ï¼Œè¿˜æ˜¯å¾—çœ‹çœ‹ [ã€ŠZookeeper Leader å’Œ Learner çš„æ•°æ®åŒæ­¥ã€‹](https://blog.csdn.net/weixin_36145588/article/details/75043611) ã€‚

## 666. å½©è›‹

ä¼°è®¡å¤§å¤šæ•°èƒ–å‹ï¼Œå­¦ä¹  Zookeeper çš„è¿‡ç¨‹ï¼Œæ˜¯å› ä¸ºä½¿ç”¨ Dubbo æ—¶ï¼Œéœ€è¦ä½¿ç”¨åˆ° Zookeeper ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œç„¶åå¿«é€Ÿæ­å»ºäº†ä¸‹ã€‚ç„¶åï¼Œæ–­æ–­ç»­ç»­çœ‹äº†ä¸‹ Zookeeper çš„æ–‡ç« ã€‚ğŸ™‚ å°±å½“æ˜¯å¤ä¹ ã€‚é¢å¯¹çš„æ—¶å€™ï¼Œæ¯”è¾ƒé‡ç‚¹çš„å‡ ä¸ªé—®é¢˜æ˜¯ï¼š

- Zookeeper çš„é€‰ä¸¾è¿‡ç¨‹ï¼Ÿ
- Zookeeper å¦‚ä½•æä¾›åˆ†å¸ƒå¼é”ï¼Ÿ
- Zookeeper çš„ä¸€äº›åº”ç”¨åœºæ™¯ï¼Ÿ

å‚è€ƒä¸æ¨èå¦‚ä¸‹æ–‡ç« ï¼š

- [ã€ŠZooKeeper å­¦ä¹ æ€»ç»“ï¼ˆ3ï¼‰â€”â€” ZooKeeper å¸¸è§é¢è¯•é¢˜ã€‹](https://blog.csdn.net/u012562943/article/details/76128183)
- [ã€ŠZookeeper å¸¸è§é¢è¯•é¢˜ã€‹](https://blog.csdn.net/u013676711/article/details/53842438)
- [ã€ŠZookeeper é¢è¯•é¢˜ã€‹](https://www.cnblogs.com/lanqiu5ge/p/9405601.html)
- [ã€Šå¦‚æœæœ‰äººé—®ä½  ZooKeeper æ˜¯ä»€ä¹ˆï¼Œå°±æŠŠè¿™ç¯‡æ–‡ç« å‘ç»™ä»–ã€‹](https://juejin.im/post/5baf7db75188255c3d11622e)

**æ–‡ç« ç›®å½•**

1. [Zookeeper æ˜¯ä»€ä¹ˆï¼Ÿ](http://svip.iocoder.cn/Zookeeper/Interview/#undefined)
2. [Zookeeper çš„è®¾è®¡ç›®æ ‡ï¼Ÿ](http://svip.iocoder.cn/Zookeeper/Interview/#undefined)
3. [Zookeeper æœ‰å“ªäº›åº”ç”¨åœºæ™¯ï¼Ÿ](http://svip.iocoder.cn/Zookeeper/Interview/#undefined)
4. [Zookeeper æä¾›äº†ä»€ä¹ˆï¼Ÿ](http://svip.iocoder.cn/Zookeeper/Interview/#undefined)
5. [Zookeeper çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Ÿ](http://svip.iocoder.cn/Zookeeper/Interview/#undefined)
6. [Zookeeper çš„é€šçŸ¥æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ](http://svip.iocoder.cn/Zookeeper/Interview/#undefined)
7. [Zookeeper é‡‡ç”¨ä»€ä¹ˆæƒé™æ§åˆ¶æœºåˆ¶ï¼Ÿ](http://svip.iocoder.cn/Zookeeper/Interview/#undefined)
8. [Zookeeper çš„ä¼šè¯ç®¡ç†æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ](http://svip.iocoder.cn/Zookeeper/Interview/#undefined)
9. [Zookeeper çš„éƒ¨ç½²æ–¹å¼ï¼Ÿ](http://svip.iocoder.cn/Zookeeper/Interview/#undefined)
10. [ZooKeeper çš„å·¥ä½œåŸç†ï¼Ÿ](http://svip.iocoder.cn/Zookeeper/Interview/#undefined)
11. [Zookeeper çš„é€‰ä¸¾è¿‡ç¨‹ï¼Ÿ](http://svip.iocoder.cn/Zookeeper/Interview/#undefined)
12. [Zookeeper çš„åŒæ­¥æµç¨‹ï¼Ÿ](http://svip.iocoder.cn/Zookeeper/Interview/#undefined)
13. [666. å½©è›‹](http://svip.iocoder.cn/Zookeeper/Interview/#undefined)

Â© 2014 - 2020 èŠ‹é“æºç  | 

æ€»è®¿å®¢æ•° 809434 æ¬¡ && æ€»è®¿é—®é‡ 3940223 æ¬¡

[å›åˆ°é¦–é¡µ](http://svip.iocoder.cn/index)